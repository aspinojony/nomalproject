<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç« èŠ‚è¿›åº¦æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .log { background: #f5f5f5; padding: 10px; font-family: monospace; max-height: 400px; overflow-y: auto; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .progress-item { margin: 5px 0; padding: 8px; background: #f8f9fa; border-left: 3px solid #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ç« èŠ‚è¿›åº¦æ•°æ®æµ‹è¯•</h1>
        
        <div class="section">
            <h2>æµ‹è¯•æ§åˆ¶</h2>
            <button onclick="testLocalStorageData()">æ£€æŸ¥localStorageæ•°æ®</button>
            <button onclick="testStatsManager()">æµ‹è¯•StatsManagerè·å–</button>
            <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="section">
            <h2>æµ‹è¯•æ—¥å¿—</h2>
            <div id="log" class="log">æµ‹è¯•å‡†å¤‡å°±ç»ª...\n</div>
        </div>

        <div class="section">
            <h2>ç« èŠ‚è¿›åº¦ç»“æœ</h2>
            <div id="results">
                <p>ç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹...</p>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„JSæ–‡ä»¶ -->
    <script src="assets/js/stats-manager.js"></script>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('log').textContent = 'æ—¥å¿—å·²æ¸…ç©º...\n';
        }

        function testLocalStorageData() {
            log('=== å¼€å§‹æ£€æŸ¥localStorageæ•°æ® ===');
            
            // æ£€æŸ¥study_progress
            const studyProgress = localStorage.getItem('study_progress');
            if (studyProgress) {
                try {
                    const parsed = JSON.parse(studyProgress);
                    log(`âœ… æ‰¾åˆ°study_progressæ•°æ®ï¼Œå¤§å°: ${studyProgress.length} å­—ç¬¦`);
                    log(`ğŸ“Š å…¬å…±ç§‘ç›®æ•°é‡: ${parsed.publicSubjects ? parsed.publicSubjects.length : 0}`);
                    log(`ğŸ“Š ä¸“ä¸šç§‘ç›®æ•°é‡: ${parsed.professionalSubjects ? parsed.professionalSubjects.length : 0}`);
                    
                    // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                    let totalChapters = 0;
                    let completedChapters = 0;
                    
                    const allSubjects = [
                        ...(parsed.publicSubjects || []),
                        ...(parsed.professionalSubjects || [])
                    ];
                    
                    let resultsHTML = '<h3>LocalStorageæ•°æ®è§£æç»“æœ:</h3>';
                    
                    allSubjects.forEach(subject => {
                        if (subject.chapters && Array.isArray(subject.chapters)) {
                            const subjectCompleted = subject.chapters.filter(ch => ch.completed).length;
                            totalChapters += subject.chapters.length;
                            completedChapters += subjectCompleted;
                            
                            resultsHTML += `
                                <div class="progress-item">
                                    <strong>${subject.name}</strong>: ${subjectCompleted}/${subject.chapters.length} ç« èŠ‚å®Œæˆ
                                    <br><small>ID: ${subject.id}</small>
                                </div>
                            `;
                            
                            log(`ğŸ“š ${subject.name}: ${subjectCompleted}/${subject.chapters.length} ç« èŠ‚å®Œæˆ`);
                        }
                    });
                    
                    resultsHTML += `
                        <div class="progress-item" style="border-left-color: #28a745; background: #d4edda;">
                            <strong>æ€»è®¡</strong>: ${completedChapters}/${totalChapters} ç« èŠ‚å®Œæˆ 
                            (${totalChapters > 0 ? Math.round((completedChapters / totalChapters) * 100) : 0}%)
                        </div>
                    `;
                    
                    document.getElementById('results').innerHTML = resultsHTML;
                    log(`âœ… æ€»è®¡: ${completedChapters}/${totalChapters} ç« èŠ‚å®Œæˆ`);
                    
                } catch (error) {
                    log(`âŒ è§£æstudy_progresså¤±è´¥: ${error.message}`);
                }
            } else {
                log('âš ï¸ æœªæ‰¾åˆ°study_progressæ•°æ®');
            }

            // æ£€æŸ¥å…¶ä»–ç›¸å…³æ•°æ®
            const statsData = localStorage.getItem('study_statistics');
            if (statsData) {
                log(`âœ… æ‰¾åˆ°study_statisticsæ•°æ®ï¼Œå¤§å°: ${statsData.length} å­—ç¬¦`);
            } else {
                log('âš ï¸ æœªæ‰¾åˆ°study_statisticsæ•°æ®');
            }
            
            log('=== localStorageæ£€æŸ¥å®Œæˆ ===');
        }

        async function testStatsManager() {
            log('=== å¼€å§‹æµ‹è¯•StatsManager ===');
            
            if (!window.studyStats) {
                log('âŒ StudyStatsManageræœªåˆå§‹åŒ–');
                return;
            }
            
            try {
                log('ğŸ”„ è°ƒç”¨getAllChapterProgress()...');
                const chapterProgress = await window.studyStats.getAllChapterProgress();
                
                log(`âœ… è·å–ç« èŠ‚è¿›åº¦æˆåŠŸ:`);
                log(`ğŸ“Š æ€»ç« èŠ‚æ•°: ${chapterProgress.totalChapters}`);
                log(`ğŸ“Š å·²å®Œæˆç« èŠ‚: ${chapterProgress.completedChapters}`);
                log(`ğŸ“Š æ€»è§‚çœ‹æ—¶é•¿: ${chapterProgress.totalWatchedSeconds}ç§’`);
                
                let resultsHTML = '<h3>StatsManagerè·å–ç»“æœ:</h3>';
                
                if (chapterProgress.courseProgress && typeof chapterProgress.courseProgress === 'object') {
                    Object.values(chapterProgress.courseProgress).forEach(course => {
                        const completionRate = course.chapters && course.chapters.length > 0 ? 
                            Math.round((course.completedCount / course.chapters.length) * 100) : 0;
                        
                        resultsHTML += `
                            <div class="progress-item">
                                <strong>${course.courseName}</strong>: ${course.completedCount}/${course.chapters ? course.chapters.length : 0} ç« èŠ‚å®Œæˆ (${completionRate}%)
                                <br><small>ID: ${course.courseId}, è§‚çœ‹: ${Math.round(course.totalWatchedSeconds / 60)}åˆ†é’Ÿ</small>
                            </div>
                        `;
                        
                        log(`ğŸ“š ${course.courseName}: ${course.completedCount}/${course.chapters ? course.chapters.length : 0} (${completionRate}%)`);
                    });
                }
                
                const overallRate = chapterProgress.totalChapters > 0 ? 
                    Math.round((chapterProgress.completedChapters / chapterProgress.totalChapters) * 100) : 0;
                
                resultsHTML += `
                    <div class="progress-item" style="border-left-color: #28a745; background: #d4edda;">
                        <strong>æ€»è®¡</strong>: ${chapterProgress.completedChapters}/${chapterProgress.totalChapters} ç« èŠ‚å®Œæˆ (${overallRate}%)
                        <br><small>æ€»è§‚çœ‹æ—¶é•¿: ${Math.round(chapterProgress.totalWatchedSeconds / 60)}åˆ†é’Ÿ</small>
                    </div>
                `;
                
                document.getElementById('results').innerHTML = resultsHTML;
                
            } catch (error) {
                log(`âŒ StatsManageræµ‹è¯•å¤±è´¥: ${error.message}`);
                console.error('StatsManageræµ‹è¯•é”™è¯¯:', error);
            }
            
            log('=== StatsManageræµ‹è¯•å®Œæˆ ===');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ');
            if (window.studyStats) {
                log('âœ… StudyStatsManagerå·²åˆå§‹åŒ–');
            } else {
                log('âš ï¸ StudyStatsManageræœªæ‰¾åˆ°');
            }
        });
    </script>
</body>
</html>