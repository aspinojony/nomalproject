<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>完善导入系统测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        .card { background: white; border-radius: 8px; padding: 20px; margin: 15px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status { padding: 8px 15px; border-radius: 20px; font-size: 14px; margin: 5px; display: inline-block; }
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        .log { background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.warning { background: #ffc107; color: #212529; }
        .progress-item { padding: 10px; margin: 5px 0; background: #e9ecef; border-left: 4px solid #007bff; border-radius: 0 5px 5px 0; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .test-step { margin: 10px 0; padding: 10px; background: #f8f9fa; border-left: 4px solid #6c757d; }
        .test-step.active { border-left-color: #007bff; background: #e7f3ff; }
        .test-step.completed { border-left-color: #28a745; background: #d4edda; }
        .data-comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .comparison-box { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; }
        .subject-card { background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin: 10px 0; }
        .chapter-list { margin-top: 10px; }
        .chapter-item { background: #f8f9fa; padding: 8px; margin: 3px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .chapter-item.completed { background: #d4edda; }
        .chapter-item.incomplete { background: #f8d7da; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 完善的学习记录导入系统测试</h1>
        
        <div class="card">
            <h2>📋 系统设计概览</h2>
            <div class="grid-3">
                <div class="comparison-box">
                    <h4>🔍 问题识别</h4>
                    <ul style="font-size: 14px;">
                        <li>导入后科目完成度显示为0</li>
                        <li>章节完成状态不正确</li>
                        <li>课程ID映射不完整</li>
                        <li>数据格式不匹配</li>
                    </ul>
                </div>
                <div class="comparison-box">
                    <h4>💡 解决方案</h4>
                    <ul style="font-size: 14px;">
                        <li>完善课程ID映射系统</li>
                        <li>统一数据格式转换</li>
                        <li>自动计算科目完成度</li>
                        <li>双向数据同步机制</li>
                    </ul>
                </div>
                <div class="comparison-box">
                    <h4>✅ 预期效果</h4>
                    <ul style="font-size: 14px;">
                        <li>科目完成度正确显示</li>
                        <li>章节状态完整保持</li>
                        <li>学习进度准确恢复</li>
                        <li>数据格式完全兼容</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>🧪 完整测试流程</h2>
            <div class="grid">
                <div>
                    <h3>测试步骤</h3>
                    <div id="testSteps">
                        <div class="test-step" id="step1">
                            <strong>1. 创建完整测试数据</strong>
                            <button onclick="createCompleteTestData()">创建测试数据</button>
                            <span id="step1Status"></span>
                        </div>
                        <div class="test-step" id="step2">
                            <strong>2. 验证课程ID映射</strong>
                            <button onclick="testCourseMapping()">测试映射系统</button>
                            <span id="step2Status"></span>
                        </div>
                        <div class="test-step" id="step3">
                            <strong>3. 执行导入同步</strong>
                            <button onclick="executeImportSync()">执行同步</button>
                            <span id="step3Status"></span>
                        </div>
                        <div class="test-step" id="step4">
                            <strong>4. 验证科目完成度</strong>
                            <button onclick="verifySubjectProgress()">验证进度</button>
                            <span id="step4Status"></span>
                        </div>
                        <div class="test-step" id="step5">
                            <strong>5. 测试subjects页面显示</strong>
                            <button onclick="testSubjectsDisplay()">测试显示</button>
                            <span id="step5Status"></span>
                        </div>
                    </div>
                </div>
                <div>
                    <h3>测试控制</h3>
                    <button onclick="runAllTests()" class="success">🚀 运行所有测试</button>
                    <button onclick="clearAllData()" class="warning">🧹 清空所有数据</button>
                    <button onclick="openSubjectsPage()">📖 打开subjects页面</button>
                    <button onclick="clearLog()">📝 清空日志</button>
                    
                    <h3>测试结果</h3>
                    <div id="overallResults">
                        <p>等待测试开始...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>📊 导入前后数据对比</h2>
                <div class="data-comparison">
                    <div class="comparison-box">
                        <h4>导入前 (localStorage)</h4>
                        <div id="beforeImportData" style="font-size: 12px; max-height: 300px; overflow-y: auto;">未加载</div>
                    </div>
                    <div class="comparison-box">
                        <h4>导入后 (localStorage)</h4>
                        <div id="afterImportData" style="font-size: 12px; max-height: 300px; overflow-y: auto;">未加载</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>📝 详细测试日志</h2>
                <div id="testLog" class="log">测试系统初始化...\n</div>
            </div>
        </div>

        <div class="card">
            <h2>📈 科目进度可视化</h2>
            <div id="subjectProgressVisualization">
                <p>运行测试后将显示科目进度详情</p>
            </div>
        </div>
    </div>

    <!-- 引入必要的JS -->
    <script src="assets/js/stats-manager.js"></script>

    <script>
        let testImportData = null;
        let testResults = {
            step1: false,
            step2: false,
            step3: false,
            step4: false,
            step5: false
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').textContent = '日志已清空...\n';
        }

        function updateStepStatus(stepNum, status, message = '') {
            const stepEl = document.getElementById(`step${stepNum}`);
            const statusEl = document.getElementById(`step${stepNum}Status`);
            
            stepEl.className = `test-step ${status}`;
            statusEl.innerHTML = message ? `<span class="status ${status}">${message}</span>` : '';
            testResults[`step${stepNum}`] = (status === 'completed');
            
            updateOverallResults();
        }

        function updateOverallResults() {
            const completedSteps = Object.values(testResults).filter(Boolean).length;
            const totalSteps = Object.keys(testResults).length;
            const progressPercentage = Math.round((completedSteps / totalSteps) * 100);
            
            document.getElementById('overallResults').innerHTML = `
                <div class="progress-item" style="border-left-color: ${completedSteps === totalSteps ? '#28a745' : '#007bff'};">
                    <strong>测试进度: ${completedSteps}/${totalSteps} (${progressPercentage}%)</strong><br>
                    ${completedSteps === totalSteps ? '🎉 所有测试完成！' : '⏳ 测试进行中...'}
                </div>
            `;
        }

        function createCompleteTestData() {
            log('创建完整的测试导入数据...');
            
            testImportData = {
                exportInfo: {
                    exportTime: new Date().toISOString(),
                    version: '1.2',
                    platform: 'Computer Science Study Platform'
                },
                stats: {
                    totalStudyTime: 1200,
                    totalSessions: 48,
                    totalQuestionsAnswered: 300,
                    correctAnswers: 240,
                    dailyStats: {},
                    subjectStats: {}
                },
                chapterProgress: {
                    courseProgress: {
                        // 公共课测试数据
                        'mathematics': {
                            courseName: '高等数学',
                            courseId: 'mathematics',
                            chapters: [
                                { index: 0, name: '函数与极限', duration: '3小时', difficulty: '中等', completed: true, watchedSeconds: 10800 },
                                { index: 1, name: '导数与微分', duration: '2小时30分钟', difficulty: '中等', completed: true, watchedSeconds: 9000 },
                                { index: 2, name: '积分', duration: '4小时', difficulty: '困难', completed: false, watchedSeconds: 0 },
                                { index: 3, name: '无穷级数', duration: '3小时30分钟', difficulty: '困难', completed: false, watchedSeconds: 0 }
                            ],
                            completedCount: 2,
                            totalWatchedSeconds: 19800
                        },
                        'english': {
                            courseName: '英语',
                            courseId: 'english',
                            chapters: [
                                { index: 0, name: '词汇基础', duration: '2小时', difficulty: '简单', completed: true, watchedSeconds: 7200 },
                                { index: 1, name: '阅读理解', duration: '3小时', difficulty: '中等', completed: true, watchedSeconds: 10800 },
                                { index: 2, name: '写作技巧', duration: '2小时', difficulty: '中等', completed: false, watchedSeconds: 0 }
                            ],
                            completedCount: 2,
                            totalWatchedSeconds: 18000
                        },
                        // 专业课测试数据
                        'data_structure': {
                            courseName: '数据结构',
                            courseId: 'data_structure',
                            chapters: [
                                { index: 0, name: '线性表', duration: '3小时', difficulty: '中等', completed: true, watchedSeconds: 10800 },
                                { index: 1, name: '栈和队列', duration: '2小时30分钟', difficulty: '中等', completed: true, watchedSeconds: 9000 },
                                { index: 2, name: '树和二叉树', duration: '4小时', difficulty: '困难', completed: true, watchedSeconds: 14400 },
                                { index: 3, name: '图论基础', duration: '3小时30分钟', difficulty: '困难', completed: false, watchedSeconds: 0 }
                            ],
                            completedCount: 3,
                            totalWatchedSeconds: 34200
                        },
                        'operating_system': {
                            courseName: '操作系统',
                            courseId: 'operating_system',
                            chapters: [
                                { index: 0, name: '进程管理', duration: '3小时', difficulty: '中等', completed: true, watchedSeconds: 10800 },
                                { index: 1, name: '内存管理', duration: '3小时30分钟', difficulty: '困难', completed: false, watchedSeconds: 0 },
                                { index: 2, name: '文件系统', duration: '2小时30分钟', difficulty: '中等', completed: false, watchedSeconds: 0 }
                            ],
                            completedCount: 1,
                            totalWatchedSeconds: 10800
                        }
                    },
                    totalChapters: 14,
                    completedChapters: 8,
                    totalWatchedSeconds: 82800
                }
            };

            // 记录导入前的数据
            const beforeData = localStorage.getItem('study_progress');
            document.getElementById('beforeImportData').innerHTML = beforeData ? 
                `<pre>${JSON.stringify(JSON.parse(beforeData), null, 2)}</pre>` : 
                '<p style="color: #6c757d;">无现有数据</p>';
            
            log('测试数据创建完成', 'success');
            log(`包含 ${testImportData.chapterProgress.totalChapters} 个章节，其中 ${testImportData.chapterProgress.completedChapters} 个已完成`);
            log(`涵盖 ${Object.keys(testImportData.chapterProgress.courseProgress).length} 个科目`);
            
            updateStepStatus(1, 'completed', '数据已创建');
        }

        function testCourseMapping() {
            if (!testImportData) {
                log('请先创建测试数据', 'error');
                return;
            }

            log('测试课程ID映射系统...');
            
            if (!window.studyStats) {
                log('StudyStatsManager未初始化', 'error');
                updateStepStatus(2, 'error', '系统未初始化');
                return;
            }

            const courseMapping = window.studyStats.createCourseIdToSubjectMapping();
            let mappingResults = [];
            
            for (const [courseId, courseData] of Object.entries(testImportData.chapterProgress.courseProgress)) {
                const courseInfo = window.studyStats.determineCourseType(courseId, courseData.courseName, courseMapping);
                mappingResults.push({
                    原始ID: courseId,
                    课程名称: courseData.courseName,
                    数字ID: courseInfo.numericId,
                    课程类型: courseInfo.courseType,
                    映射有效: courseInfo.isValid
                });
                
                log(`映射测试: ${courseData.courseName} (${courseId}) -> ID:${courseInfo.numericId}, 类型:${courseInfo.courseType}`, 
                    courseInfo.isValid ? 'success' : 'error');
            }
            
            const allValid = mappingResults.every(result => result.映射有效);
            if (allValid) {
                updateStepStatus(2, 'completed', '映射测试通过');
                log('所有课程ID映射测试通过', 'success');
            } else {
                updateStepStatus(2, 'error', '映射测试失败');
                log('部分课程ID映射失败', 'error');
            }
        }

        async function executeImportSync() {
            if (!testImportData) {
                log('请先创建测试数据', 'error');
                return;
            }

            log('执行导入同步过程...');
            updateStepStatus(3, 'active', '同步中...');
            
            try {
                if (!window.studyStats) {
                    throw new Error('StudyStatsManager未初始化');
                }

                // 执行同步
                const syncResult = await window.studyStats.syncChapterProgressToSubjectsFormat(
                    testImportData.chapterProgress, 
                    'replace'
                );
                
                if (syncResult.success) {
                    log('数据同步成功!', 'success');
                    log(`更新了 ${syncResult.updatedSubjects} 个科目，创建了 ${syncResult.createdSubjects} 个科目`);
                    log(`总章节数: ${syncResult.totalChapters}, 已完成: ${syncResult.completedChapters}`);
                    log(`总体完成率: ${syncResult.overallCompletionRate}%`);
                    
                    // 显示导入后的数据
                    const afterData = localStorage.getItem('study_progress');
                    document.getElementById('afterImportData').innerHTML = afterData ? 
                        `<pre>${JSON.stringify(JSON.parse(afterData), null, 2)}</pre>` : 
                        '<p style="color: #dc3545;">导入后无数据</p>';
                    
                    updateStepStatus(3, 'completed', '同步成功');
                } else {
                    throw new Error(syncResult.error || '同步失败');
                }
                
            } catch (error) {
                log(`导入同步失败: ${error.message}`, 'error');
                updateStepStatus(3, 'error', '同步失败');
            }
        }

        async function verifySubjectProgress() {
            log('验证科目完成度计算...');
            
            try {
                const progressData = localStorage.getItem('study_progress');
                if (!progressData) {
                    throw new Error('未找到进度数据');
                }

                const parsed = JSON.parse(progressData);
                const allSubjects = [
                    ...(parsed.publicSubjects || []),
                    ...(parsed.professionalSubjects || [])
                ];

                let verificationResults = [];
                let allCorrect = true;

                allSubjects.forEach(subject => {
                    const totalChapters = subject.chapters ? subject.chapters.length : 0;
                    const completedCount = subject.chapters ? subject.chapters.filter(ch => ch.completed).length : 0;
                    const expectedProgress = totalChapters > 0 ? Math.round((completedCount / totalChapters) * 100) : 0;
                    
                    const progressCorrect = subject.progress === expectedProgress;
                    const completedCorrect = subject.completedChapters === completedCount;
                    
                    verificationResults.push({
                        科目: subject.name,
                        ID: subject.id,
                        总章节: totalChapters,
                        已完成: completedCount,
                        计算进度: expectedProgress,
                        实际进度: subject.progress,
                        进度正确: progressCorrect,
                        完成数正确: completedCorrect
                    });
                    
                    if (!progressCorrect || !completedCorrect) {
                        allCorrect = false;
                        log(`❌ 科目 ${subject.name} 进度计算错误: 期望${expectedProgress}%, 实际${subject.progress}%`, 'error');
                    } else {
                        log(`✅ 科目 ${subject.name} 进度正确: ${subject.progress}% (${completedCount}/${totalChapters})`, 'success');
                    }
                });

                if (allCorrect) {
                    updateStepStatus(4, 'completed', '进度验证通过');
                    log('所有科目进度计算正确', 'success');
                } else {
                    updateStepStatus(4, 'error', '进度计算错误');
                    log('部分科目进度计算错误', 'error');
                }

            } catch (error) {
                log(`验证科目进度失败: ${error.message}`, 'error');
                updateStepStatus(4, 'error', '验证失败');
            }
        }

        async function testSubjectsDisplay() {
            log('测试subjects页面数据显示...');
            
            try {
                if (!window.studyStats) {
                    throw new Error('StudyStatsManager未初始化');
                }
                
                // 调用章节进度获取方法
                const chapterProgress = await window.studyStats.getAllChapterProgress();
                
                log(`获取章节进度: ${chapterProgress.completedChapters}/${chapterProgress.totalChapters}`, 'success');
                
                // 生成可视化展示
                generateProgressVisualization(chapterProgress);
                
                if (chapterProgress.completedChapters > 0) {
                    updateStepStatus(5, 'completed', '显示测试通过');
                    log('subjects页面数据显示测试通过', 'success');
                } else {
                    updateStepStatus(5, 'warning', '无完成数据');
                    log('subjects页面显示无完成数据', 'warning');
                }
                
            } catch (error) {
                log(`subjects显示测试失败: ${error.message}`, 'error');
                updateStepStatus(5, 'error', '显示测试失败');
            }
        }

        function generateProgressVisualization(chapterProgress) {
            let visualizationHTML = '';
            
            if (chapterProgress.courseProgress) {
                Object.values(chapterProgress.courseProgress).forEach(course => {
                    const completionRate = course.chapters && course.chapters.length > 0 ? 
                        Math.round((course.completedCount / course.chapters.length) * 100) : 0;
                    
                    visualizationHTML += `
                        <div class="subject-card">
                            <h4>${course.courseName} (完成率: ${completionRate}%)</h4>
                            <div style="background: #e9ecef; height: 8px; border-radius: 4px; margin: 10px 0;">
                                <div style="background: linear-gradient(90deg, #28a745, #20c997); height: 8px; border-radius: 4px; width: ${completionRate}%;"></div>
                            </div>
                            <p>进度: ${course.completedCount}/${course.chapters ? course.chapters.length : 0} 章节</p>
                            <div class="chapter-list">
                                ${course.chapters ? course.chapters.map(chapter => `
                                    <div class="chapter-item ${chapter.completed ? 'completed' : 'incomplete'}">
                                        <span>${chapter.name}</span>
                                        <span>${chapter.completed ? '✅ 已完成' : '⏳ 未完成'}</span>
                                    </div>
                                `).join('') : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('subjectProgressVisualization').innerHTML = visualizationHTML || '<p>无进度数据</p>';
        }

        async function runAllTests() {
            log('开始运行所有测试...', 'success');
            
            createCompleteTestData();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testCourseMapping();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await executeImportSync();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await verifySubjectProgress();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testSubjectsDisplay();
            
            log('所有测试完成!', 'success');
        }

        function clearAllData() {
            localStorage.removeItem('study_progress');
            localStorage.removeItem('study_statistics');
            log('所有数据已清空', 'warning');
            
            document.getElementById('beforeImportData').innerHTML = '无现有数据';
            document.getElementById('afterImportData').innerHTML = '未加载';
            document.getElementById('subjectProgressVisualization').innerHTML = '<p>运行测试后将显示科目进度详情</p>';
            
            // 重置测试状态
            Object.keys(testResults).forEach(key => testResults[key] = false);
            for (let i = 1; i <= 5; i++) {
                updateStepStatus(i, '', '');
            }
        }

        function openSubjectsPage() {
            window.open('subjects.html', '_blank');
        }

        // 页面加载时的初始化
        window.addEventListener('load', () => {
            log('完善导入系统测试页面加载完成');
            if (window.studyStats) {
                log('StudyStatsManager已就绪', 'success');
            } else {
                log('StudyStatsManager未找到', 'error');
            }
            updateOverallResults();
        });
    </script>
</body>
</html>