<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œå–„å¯¼å…¥ç³»ç»Ÿæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        .card { background: white; border-radius: 8px; padding: 20px; margin: 15px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status { padding: 8px 15px; border-radius: 20px; font-size: 14px; margin: 5px; display: inline-block; }
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        .log { background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.warning { background: #ffc107; color: #212529; }
        .progress-item { padding: 10px; margin: 5px 0; background: #e9ecef; border-left: 4px solid #007bff; border-radius: 0 5px 5px 0; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .test-step { margin: 10px 0; padding: 10px; background: #f8f9fa; border-left: 4px solid #6c757d; }
        .test-step.active { border-left-color: #007bff; background: #e7f3ff; }
        .test-step.completed { border-left-color: #28a745; background: #d4edda; }
        .data-comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .comparison-box { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; }
        .subject-card { background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin: 10px 0; }
        .chapter-list { margin-top: 10px; }
        .chapter-item { background: #f8f9fa; padding: 8px; margin: 3px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .chapter-item.completed { background: #d4edda; }
        .chapter-item.incomplete { background: #f8d7da; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ å®Œå–„çš„å­¦ä¹ è®°å½•å¯¼å…¥ç³»ç»Ÿæµ‹è¯•</h1>
        
        <div class="card">
            <h2>ğŸ“‹ ç³»ç»Ÿè®¾è®¡æ¦‚è§ˆ</h2>
            <div class="grid-3">
                <div class="comparison-box">
                    <h4>ğŸ” é—®é¢˜è¯†åˆ«</h4>
                    <ul style="font-size: 14px;">
                        <li>å¯¼å…¥åç§‘ç›®å®Œæˆåº¦æ˜¾ç¤ºä¸º0</li>
                        <li>ç« èŠ‚å®ŒæˆçŠ¶æ€ä¸æ­£ç¡®</li>
                        <li>è¯¾ç¨‹IDæ˜ å°„ä¸å®Œæ•´</li>
                        <li>æ•°æ®æ ¼å¼ä¸åŒ¹é…</li>
                    </ul>
                </div>
                <div class="comparison-box">
                    <h4>ğŸ’¡ è§£å†³æ–¹æ¡ˆ</h4>
                    <ul style="font-size: 14px;">
                        <li>å®Œå–„è¯¾ç¨‹IDæ˜ å°„ç³»ç»Ÿ</li>
                        <li>ç»Ÿä¸€æ•°æ®æ ¼å¼è½¬æ¢</li>
                        <li>è‡ªåŠ¨è®¡ç®—ç§‘ç›®å®Œæˆåº¦</li>
                        <li>åŒå‘æ•°æ®åŒæ­¥æœºåˆ¶</li>
                    </ul>
                </div>
                <div class="comparison-box">
                    <h4>âœ… é¢„æœŸæ•ˆæœ</h4>
                    <ul style="font-size: 14px;">
                        <li>ç§‘ç›®å®Œæˆåº¦æ­£ç¡®æ˜¾ç¤º</li>
                        <li>ç« èŠ‚çŠ¶æ€å®Œæ•´ä¿æŒ</li>
                        <li>å­¦ä¹ è¿›åº¦å‡†ç¡®æ¢å¤</li>
                        <li>æ•°æ®æ ¼å¼å®Œå…¨å…¼å®¹</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ§ª å®Œæ•´æµ‹è¯•æµç¨‹</h2>
            <div class="grid">
                <div>
                    <h3>æµ‹è¯•æ­¥éª¤</h3>
                    <div id="testSteps">
                        <div class="test-step" id="step1">
                            <strong>1. åˆ›å»ºå®Œæ•´æµ‹è¯•æ•°æ®</strong>
                            <button onclick="createCompleteTestData()">åˆ›å»ºæµ‹è¯•æ•°æ®</button>
                            <span id="step1Status"></span>
                        </div>
                        <div class="test-step" id="step2">
                            <strong>2. éªŒè¯è¯¾ç¨‹IDæ˜ å°„</strong>
                            <button onclick="testCourseMapping()">æµ‹è¯•æ˜ å°„ç³»ç»Ÿ</button>
                            <span id="step2Status"></span>
                        </div>
                        <div class="test-step" id="step3">
                            <strong>3. æ‰§è¡Œå¯¼å…¥åŒæ­¥</strong>
                            <button onclick="executeImportSync()">æ‰§è¡ŒåŒæ­¥</button>
                            <span id="step3Status"></span>
                        </div>
                        <div class="test-step" id="step4">
                            <strong>4. éªŒè¯ç§‘ç›®å®Œæˆåº¦</strong>
                            <button onclick="verifySubjectProgress()">éªŒè¯è¿›åº¦</button>
                            <span id="step4Status"></span>
                        </div>
                        <div class="test-step" id="step5">
                            <strong>5. æµ‹è¯•subjectsé¡µé¢æ˜¾ç¤º</strong>
                            <button onclick="testSubjectsDisplay()">æµ‹è¯•æ˜¾ç¤º</button>
                            <span id="step5Status"></span>
                        </div>
                    </div>
                </div>
                <div>
                    <h3>æµ‹è¯•æ§åˆ¶</h3>
                    <button onclick="runAllTests()" class="success">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
                    <button onclick="clearAllData()" class="warning">ğŸ§¹ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                    <button onclick="openSubjectsPage()">ğŸ“– æ‰“å¼€subjectsé¡µé¢</button>
                    <button onclick="clearLog()">ğŸ“ æ¸…ç©ºæ—¥å¿—</button>
                    
                    <h3>æµ‹è¯•ç»“æœ</h3>
                    <div id="overallResults">
                        <p>ç­‰å¾…æµ‹è¯•å¼€å§‹...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>ğŸ“Š å¯¼å…¥å‰åæ•°æ®å¯¹æ¯”</h2>
                <div class="data-comparison">
                    <div class="comparison-box">
                        <h4>å¯¼å…¥å‰ (localStorage)</h4>
                        <div id="beforeImportData" style="font-size: 12px; max-height: 300px; overflow-y: auto;">æœªåŠ è½½</div>
                    </div>
                    <div class="comparison-box">
                        <h4>å¯¼å…¥å (localStorage)</h4>
                        <div id="afterImportData" style="font-size: 12px; max-height: 300px; overflow-y: auto;">æœªåŠ è½½</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ“ è¯¦ç»†æµ‹è¯•æ—¥å¿—</h2>
                <div id="testLog" class="log">æµ‹è¯•ç³»ç»Ÿåˆå§‹åŒ–...\n</div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“ˆ ç§‘ç›®è¿›åº¦å¯è§†åŒ–</h2>
            <div id="subjectProgressVisualization">
                <p>è¿è¡Œæµ‹è¯•åå°†æ˜¾ç¤ºç§‘ç›®è¿›åº¦è¯¦æƒ…</p>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„JS -->
    <script src="assets/js/stats-manager.js"></script>

    <script>
        let testImportData = null;
        let testResults = {
            step1: false,
            step2: false,
            step3: false,
            step4: false,
            step5: false
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').textContent = 'æ—¥å¿—å·²æ¸…ç©º...\n';
        }

        function updateStepStatus(stepNum, status, message = '') {
            const stepEl = document.getElementById(`step${stepNum}`);
            const statusEl = document.getElementById(`step${stepNum}Status`);
            
            stepEl.className = `test-step ${status}`;
            statusEl.innerHTML = message ? `<span class="status ${status}">${message}</span>` : '';
            testResults[`step${stepNum}`] = (status === 'completed');
            
            updateOverallResults();
        }

        function updateOverallResults() {
            const completedSteps = Object.values(testResults).filter(Boolean).length;
            const totalSteps = Object.keys(testResults).length;
            const progressPercentage = Math.round((completedSteps / totalSteps) * 100);
            
            document.getElementById('overallResults').innerHTML = `
                <div class="progress-item" style="border-left-color: ${completedSteps === totalSteps ? '#28a745' : '#007bff'};">
                    <strong>æµ‹è¯•è¿›åº¦: ${completedSteps}/${totalSteps} (${progressPercentage}%)</strong><br>
                    ${completedSteps === totalSteps ? 'ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼' : 'â³ æµ‹è¯•è¿›è¡Œä¸­...'}
                </div>
            `;
        }

        function createCompleteTestData() {
            log('åˆ›å»ºå®Œæ•´çš„æµ‹è¯•å¯¼å…¥æ•°æ®...');
            
            testImportData = {
                exportInfo: {
                    exportTime: new Date().toISOString(),
                    version: '1.2',
                    platform: 'Computer Science Study Platform'
                },
                stats: {
                    totalStudyTime: 1200,
                    totalSessions: 48,
                    totalQuestionsAnswered: 300,
                    correctAnswers: 240,
                    dailyStats: {},
                    subjectStats: {}
                },
                chapterProgress: {
                    courseProgress: {
                        // å…¬å…±è¯¾æµ‹è¯•æ•°æ®
                        'mathematics': {
                            courseName: 'é«˜ç­‰æ•°å­¦',
                            courseId: 'mathematics',
                            chapters: [
                                { index: 0, name: 'å‡½æ•°ä¸æé™', duration: '3å°æ—¶', difficulty: 'ä¸­ç­‰', completed: true, watchedSeconds: 10800 },
                                { index: 1, name: 'å¯¼æ•°ä¸å¾®åˆ†', duration: '2å°æ—¶30åˆ†é’Ÿ', difficulty: 'ä¸­ç­‰', completed: true, watchedSeconds: 9000 },
                                { index: 2, name: 'ç§¯åˆ†', duration: '4å°æ—¶', difficulty: 'å›°éš¾', completed: false, watchedSeconds: 0 },
                                { index: 3, name: 'æ— ç©·çº§æ•°', duration: '3å°æ—¶30åˆ†é’Ÿ', difficulty: 'å›°éš¾', completed: false, watchedSeconds: 0 }
                            ],
                            completedCount: 2,
                            totalWatchedSeconds: 19800
                        },
                        'english': {
                            courseName: 'è‹±è¯­',
                            courseId: 'english',
                            chapters: [
                                { index: 0, name: 'è¯æ±‡åŸºç¡€', duration: '2å°æ—¶', difficulty: 'ç®€å•', completed: true, watchedSeconds: 7200 },
                                { index: 1, name: 'é˜…è¯»ç†è§£', duration: '3å°æ—¶', difficulty: 'ä¸­ç­‰', completed: true, watchedSeconds: 10800 },
                                { index: 2, name: 'å†™ä½œæŠ€å·§', duration: '2å°æ—¶', difficulty: 'ä¸­ç­‰', completed: false, watchedSeconds: 0 }
                            ],
                            completedCount: 2,
                            totalWatchedSeconds: 18000
                        },
                        // ä¸“ä¸šè¯¾æµ‹è¯•æ•°æ®
                        'data_structure': {
                            courseName: 'æ•°æ®ç»“æ„',
                            courseId: 'data_structure',
                            chapters: [
                                { index: 0, name: 'çº¿æ€§è¡¨', duration: '3å°æ—¶', difficulty: 'ä¸­ç­‰', completed: true, watchedSeconds: 10800 },
                                { index: 1, name: 'æ ˆå’Œé˜Ÿåˆ—', duration: '2å°æ—¶30åˆ†é’Ÿ', difficulty: 'ä¸­ç­‰', completed: true, watchedSeconds: 9000 },
                                { index: 2, name: 'æ ‘å’ŒäºŒå‰æ ‘', duration: '4å°æ—¶', difficulty: 'å›°éš¾', completed: true, watchedSeconds: 14400 },
                                { index: 3, name: 'å›¾è®ºåŸºç¡€', duration: '3å°æ—¶30åˆ†é’Ÿ', difficulty: 'å›°éš¾', completed: false, watchedSeconds: 0 }
                            ],
                            completedCount: 3,
                            totalWatchedSeconds: 34200
                        },
                        'operating_system': {
                            courseName: 'æ“ä½œç³»ç»Ÿ',
                            courseId: 'operating_system',
                            chapters: [
                                { index: 0, name: 'è¿›ç¨‹ç®¡ç†', duration: '3å°æ—¶', difficulty: 'ä¸­ç­‰', completed: true, watchedSeconds: 10800 },
                                { index: 1, name: 'å†…å­˜ç®¡ç†', duration: '3å°æ—¶30åˆ†é’Ÿ', difficulty: 'å›°éš¾', completed: false, watchedSeconds: 0 },
                                { index: 2, name: 'æ–‡ä»¶ç³»ç»Ÿ', duration: '2å°æ—¶30åˆ†é’Ÿ', difficulty: 'ä¸­ç­‰', completed: false, watchedSeconds: 0 }
                            ],
                            completedCount: 1,
                            totalWatchedSeconds: 10800
                        }
                    },
                    totalChapters: 14,
                    completedChapters: 8,
                    totalWatchedSeconds: 82800
                }
            };

            // è®°å½•å¯¼å…¥å‰çš„æ•°æ®
            const beforeData = localStorage.getItem('study_progress');
            document.getElementById('beforeImportData').innerHTML = beforeData ? 
                `<pre>${JSON.stringify(JSON.parse(beforeData), null, 2)}</pre>` : 
                '<p style="color: #6c757d;">æ— ç°æœ‰æ•°æ®</p>';
            
            log('æµ‹è¯•æ•°æ®åˆ›å»ºå®Œæˆ', 'success');
            log(`åŒ…å« ${testImportData.chapterProgress.totalChapters} ä¸ªç« èŠ‚ï¼Œå…¶ä¸­ ${testImportData.chapterProgress.completedChapters} ä¸ªå·²å®Œæˆ`);
            log(`æ¶µç›– ${Object.keys(testImportData.chapterProgress.courseProgress).length} ä¸ªç§‘ç›®`);
            
            updateStepStatus(1, 'completed', 'æ•°æ®å·²åˆ›å»º');
        }

        function testCourseMapping() {
            if (!testImportData) {
                log('è¯·å…ˆåˆ›å»ºæµ‹è¯•æ•°æ®', 'error');
                return;
            }

            log('æµ‹è¯•è¯¾ç¨‹IDæ˜ å°„ç³»ç»Ÿ...');
            
            if (!window.studyStats) {
                log('StudyStatsManageræœªåˆå§‹åŒ–', 'error');
                updateStepStatus(2, 'error', 'ç³»ç»Ÿæœªåˆå§‹åŒ–');
                return;
            }

            const courseMapping = window.studyStats.createCourseIdToSubjectMapping();
            let mappingResults = [];
            
            for (const [courseId, courseData] of Object.entries(testImportData.chapterProgress.courseProgress)) {
                const courseInfo = window.studyStats.determineCourseType(courseId, courseData.courseName, courseMapping);
                mappingResults.push({
                    åŸå§‹ID: courseId,
                    è¯¾ç¨‹åç§°: courseData.courseName,
                    æ•°å­—ID: courseInfo.numericId,
                    è¯¾ç¨‹ç±»å‹: courseInfo.courseType,
                    æ˜ å°„æœ‰æ•ˆ: courseInfo.isValid
                });
                
                log(`æ˜ å°„æµ‹è¯•: ${courseData.courseName} (${courseId}) -> ID:${courseInfo.numericId}, ç±»å‹:${courseInfo.courseType}`, 
                    courseInfo.isValid ? 'success' : 'error');
            }
            
            const allValid = mappingResults.every(result => result.æ˜ å°„æœ‰æ•ˆ);
            if (allValid) {
                updateStepStatus(2, 'completed', 'æ˜ å°„æµ‹è¯•é€šè¿‡');
                log('æ‰€æœ‰è¯¾ç¨‹IDæ˜ å°„æµ‹è¯•é€šè¿‡', 'success');
            } else {
                updateStepStatus(2, 'error', 'æ˜ å°„æµ‹è¯•å¤±è´¥');
                log('éƒ¨åˆ†è¯¾ç¨‹IDæ˜ å°„å¤±è´¥', 'error');
            }
        }

        async function executeImportSync() {
            if (!testImportData) {
                log('è¯·å…ˆåˆ›å»ºæµ‹è¯•æ•°æ®', 'error');
                return;
            }

            log('æ‰§è¡Œå¯¼å…¥åŒæ­¥è¿‡ç¨‹...');
            updateStepStatus(3, 'active', 'åŒæ­¥ä¸­...');
            
            try {
                if (!window.studyStats) {
                    throw new Error('StudyStatsManageræœªåˆå§‹åŒ–');
                }

                // æ‰§è¡ŒåŒæ­¥
                const syncResult = await window.studyStats.syncChapterProgressToSubjectsFormat(
                    testImportData.chapterProgress, 
                    'replace'
                );
                
                if (syncResult.success) {
                    log('æ•°æ®åŒæ­¥æˆåŠŸ!', 'success');
                    log(`æ›´æ–°äº† ${syncResult.updatedSubjects} ä¸ªç§‘ç›®ï¼Œåˆ›å»ºäº† ${syncResult.createdSubjects} ä¸ªç§‘ç›®`);
                    log(`æ€»ç« èŠ‚æ•°: ${syncResult.totalChapters}, å·²å®Œæˆ: ${syncResult.completedChapters}`);
                    log(`æ€»ä½“å®Œæˆç‡: ${syncResult.overallCompletionRate}%`);
                    
                    // æ˜¾ç¤ºå¯¼å…¥åçš„æ•°æ®
                    const afterData = localStorage.getItem('study_progress');
                    document.getElementById('afterImportData').innerHTML = afterData ? 
                        `<pre>${JSON.stringify(JSON.parse(afterData), null, 2)}</pre>` : 
                        '<p style="color: #dc3545;">å¯¼å…¥åæ— æ•°æ®</p>';
                    
                    updateStepStatus(3, 'completed', 'åŒæ­¥æˆåŠŸ');
                } else {
                    throw new Error(syncResult.error || 'åŒæ­¥å¤±è´¥');
                }
                
            } catch (error) {
                log(`å¯¼å…¥åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
                updateStepStatus(3, 'error', 'åŒæ­¥å¤±è´¥');
            }
        }

        async function verifySubjectProgress() {
            log('éªŒè¯ç§‘ç›®å®Œæˆåº¦è®¡ç®—...');
            
            try {
                const progressData = localStorage.getItem('study_progress');
                if (!progressData) {
                    throw new Error('æœªæ‰¾åˆ°è¿›åº¦æ•°æ®');
                }

                const parsed = JSON.parse(progressData);
                const allSubjects = [
                    ...(parsed.publicSubjects || []),
                    ...(parsed.professionalSubjects || [])
                ];

                let verificationResults = [];
                let allCorrect = true;

                allSubjects.forEach(subject => {
                    const totalChapters = subject.chapters ? subject.chapters.length : 0;
                    const completedCount = subject.chapters ? subject.chapters.filter(ch => ch.completed).length : 0;
                    const expectedProgress = totalChapters > 0 ? Math.round((completedCount / totalChapters) * 100) : 0;
                    
                    const progressCorrect = subject.progress === expectedProgress;
                    const completedCorrect = subject.completedChapters === completedCount;
                    
                    verificationResults.push({
                        ç§‘ç›®: subject.name,
                        ID: subject.id,
                        æ€»ç« èŠ‚: totalChapters,
                        å·²å®Œæˆ: completedCount,
                        è®¡ç®—è¿›åº¦: expectedProgress,
                        å®é™…è¿›åº¦: subject.progress,
                        è¿›åº¦æ­£ç¡®: progressCorrect,
                        å®Œæˆæ•°æ­£ç¡®: completedCorrect
                    });
                    
                    if (!progressCorrect || !completedCorrect) {
                        allCorrect = false;
                        log(`âŒ ç§‘ç›® ${subject.name} è¿›åº¦è®¡ç®—é”™è¯¯: æœŸæœ›${expectedProgress}%, å®é™…${subject.progress}%`, 'error');
                    } else {
                        log(`âœ… ç§‘ç›® ${subject.name} è¿›åº¦æ­£ç¡®: ${subject.progress}% (${completedCount}/${totalChapters})`, 'success');
                    }
                });

                if (allCorrect) {
                    updateStepStatus(4, 'completed', 'è¿›åº¦éªŒè¯é€šè¿‡');
                    log('æ‰€æœ‰ç§‘ç›®è¿›åº¦è®¡ç®—æ­£ç¡®', 'success');
                } else {
                    updateStepStatus(4, 'error', 'è¿›åº¦è®¡ç®—é”™è¯¯');
                    log('éƒ¨åˆ†ç§‘ç›®è¿›åº¦è®¡ç®—é”™è¯¯', 'error');
                }

            } catch (error) {
                log(`éªŒè¯ç§‘ç›®è¿›åº¦å¤±è´¥: ${error.message}`, 'error');
                updateStepStatus(4, 'error', 'éªŒè¯å¤±è´¥');
            }
        }

        async function testSubjectsDisplay() {
            log('æµ‹è¯•subjectsé¡µé¢æ•°æ®æ˜¾ç¤º...');
            
            try {
                if (!window.studyStats) {
                    throw new Error('StudyStatsManageræœªåˆå§‹åŒ–');
                }
                
                // è°ƒç”¨ç« èŠ‚è¿›åº¦è·å–æ–¹æ³•
                const chapterProgress = await window.studyStats.getAllChapterProgress();
                
                log(`è·å–ç« èŠ‚è¿›åº¦: ${chapterProgress.completedChapters}/${chapterProgress.totalChapters}`, 'success');
                
                // ç”Ÿæˆå¯è§†åŒ–å±•ç¤º
                generateProgressVisualization(chapterProgress);
                
                if (chapterProgress.completedChapters > 0) {
                    updateStepStatus(5, 'completed', 'æ˜¾ç¤ºæµ‹è¯•é€šè¿‡');
                    log('subjectsé¡µé¢æ•°æ®æ˜¾ç¤ºæµ‹è¯•é€šè¿‡', 'success');
                } else {
                    updateStepStatus(5, 'warning', 'æ— å®Œæˆæ•°æ®');
                    log('subjectsé¡µé¢æ˜¾ç¤ºæ— å®Œæˆæ•°æ®', 'warning');
                }
                
            } catch (error) {
                log(`subjectsæ˜¾ç¤ºæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateStepStatus(5, 'error', 'æ˜¾ç¤ºæµ‹è¯•å¤±è´¥');
            }
        }

        function generateProgressVisualization(chapterProgress) {
            let visualizationHTML = '';
            
            if (chapterProgress.courseProgress) {
                Object.values(chapterProgress.courseProgress).forEach(course => {
                    const completionRate = course.chapters && course.chapters.length > 0 ? 
                        Math.round((course.completedCount / course.chapters.length) * 100) : 0;
                    
                    visualizationHTML += `
                        <div class="subject-card">
                            <h4>${course.courseName} (å®Œæˆç‡: ${completionRate}%)</h4>
                            <div style="background: #e9ecef; height: 8px; border-radius: 4px; margin: 10px 0;">
                                <div style="background: linear-gradient(90deg, #28a745, #20c997); height: 8px; border-radius: 4px; width: ${completionRate}%;"></div>
                            </div>
                            <p>è¿›åº¦: ${course.completedCount}/${course.chapters ? course.chapters.length : 0} ç« èŠ‚</p>
                            <div class="chapter-list">
                                ${course.chapters ? course.chapters.map(chapter => `
                                    <div class="chapter-item ${chapter.completed ? 'completed' : 'incomplete'}">
                                        <span>${chapter.name}</span>
                                        <span>${chapter.completed ? 'âœ… å·²å®Œæˆ' : 'â³ æœªå®Œæˆ'}</span>
                                    </div>
                                `).join('') : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('subjectProgressVisualization').innerHTML = visualizationHTML || '<p>æ— è¿›åº¦æ•°æ®</p>';
        }

        async function runAllTests() {
            log('å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...', 'success');
            
            createCompleteTestData();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testCourseMapping();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await executeImportSync();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await verifySubjectProgress();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testSubjectsDisplay();
            
            log('æ‰€æœ‰æµ‹è¯•å®Œæˆ!', 'success');
        }

        function clearAllData() {
            localStorage.removeItem('study_progress');
            localStorage.removeItem('study_statistics');
            log('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º', 'warning');
            
            document.getElementById('beforeImportData').innerHTML = 'æ— ç°æœ‰æ•°æ®';
            document.getElementById('afterImportData').innerHTML = 'æœªåŠ è½½';
            document.getElementById('subjectProgressVisualization').innerHTML = '<p>è¿è¡Œæµ‹è¯•åå°†æ˜¾ç¤ºç§‘ç›®è¿›åº¦è¯¦æƒ…</p>';
            
            // é‡ç½®æµ‹è¯•çŠ¶æ€
            Object.keys(testResults).forEach(key => testResults[key] = false);
            for (let i = 1; i <= 5; i++) {
                updateStepStatus(i, '', '');
            }
        }

        function openSubjectsPage() {
            window.open('subjects.html', '_blank');
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('å®Œå–„å¯¼å…¥ç³»ç»Ÿæµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            if (window.studyStats) {
                log('StudyStatsManagerå·²å°±ç»ª', 'success');
            } else {
                log('StudyStatsManageræœªæ‰¾åˆ°', 'error');
            }
            updateOverallResults();
        });
    </script>
</body>
</html>