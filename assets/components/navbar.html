<!-- 参考 subjects.html 的简洁导航栏组件 -->
<template id="navbar-template">
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <!-- Logo 和品牌 -->
                <div class="flex items-center space-x-2">
                    <a href="index.html" class="flex items-center space-x-2">
                        <i class="fas fa-graduation-cap text-2xl text-indigo-600"></i>
                        <h1 class="text-xl font-bold text-gray-800">计算机考研平台</h1>
                    </a>
                </div>

                <!-- 桌面端导航链接 -->
                <div class="hidden md:flex space-x-6" id="nav-links">
                    <!-- 导航链接将通过JavaScript动态生成 -->
                </div>

                <!-- 右侧功能区 -->
                <div class="flex items-center space-x-4">
                    <!-- 学习进度显示 -->
                    <div class="hidden md:block text-sm text-gray-600" id="nav-stats">
                        学习进度: <span class="text-indigo-600 font-semibold" id="progress-display">0%</span>
                    </div>
                    
                    <!-- 用户认证区域 -->
                    <div class="flex items-center space-x-2" id="user-auth-area">
                        <!-- 未登录状态 -->
                        <div class="user-not-logged-in flex items-center space-x-2">
                            <button onclick="openUserLogin()" class="hidden md:inline-flex items-center px-3 py-1 text-sm text-gray-600 hover:text-indigo-600 transition">
                                <span class="material-symbols-outlined text-lg mr-1">login</span>
                                登录
                            </button>
                            <button onclick="openUserRegister()" class="hidden md:inline-flex items-center px-3 py-1 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition text-sm">
                                <span class="material-symbols-outlined text-lg mr-1">person_add</span>
                                注册
                            </button>
                        </div>
                        
                        <!-- 已登录状态 -->
                        <div class="user-logged-in hidden flex items-center space-x-2">
                            <div class="relative" x-data="{ open: false }">
                                <button @click="open = !open" class="flex items-center space-x-2 text-gray-600 hover:text-indigo-600 transition">
                                    <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center">
                                        <span class="material-symbols-outlined text-indigo-600">person</span>
                                    </div>
                                    <span class="hidden md:block text-sm font-medium" id="user-display-name">用户</span>
                                    <span class="material-symbols-outlined text-sm">expand_more</span>
                                </button>
                                
                                <!-- 用户菜单 -->
                                <div x-show="open" @click.away="open = false" 
                                     x-transition:enter="transition ease-out duration-100"
                                     x-transition:enter-start="transform opacity-0 scale-95"
                                     x-transition:enter-end="transform opacity-100 scale-100"
                                     x-transition:leave="transition ease-in duration-75"
                                     x-transition:leave-start="transform opacity-100 scale-100"
                                     x-transition:leave-end="transform opacity-0 scale-95"
                                     class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 border">
                                    <div class="px-4 py-2 text-sm text-gray-500 border-b">
                                        <div class="font-medium" id="menu-user-name">用户名</div>
                                        <div class="text-xs" id="menu-user-email">user@example.com</div>
                                    </div>
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                        <span class="material-symbols-outlined text-lg mr-2">person</span>
                                        个人资料
                                    </a>
                                    <button onclick="showUserDataModal()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                        <span class="material-symbols-outlined text-lg mr-2">analytics</span>
                                        我的数据
                                    </button>
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                        <span class="material-symbols-outlined text-lg mr-2">settings</span>
                                        设置
                                    </a>
                                    <div class="border-t">
                                        <button onclick="handleUserLogout()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center">
                                            <span class="material-symbols-outlined text-lg mr-2">logout</span>
                                            退出登录
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 移动端菜单按钮 -->
                    <button class="md:hidden text-gray-600 hover:text-indigo-600" id="mobile-menu-btn">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- 移动端导航菜单 -->
            <div class="md:hidden border-t border-gray-200 bg-white hidden" id="mobile-menu">
                <div class="px-2 pt-2 pb-3 space-y-1" id="mobile-nav-links">
                    <!-- 移动端导航链接 -->
                </div>
                
                <!-- 移动端用户认证区域 -->
                <div class="px-4 py-3 border-t border-gray-200" id="mobile-user-auth">
                    <!-- 未登录状态 -->
                    <div class="mobile-user-not-logged-in space-y-2">
                        <button onclick="openUserLogin()" class="w-full flex items-center justify-center px-4 py-2 text-sm text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition">
                            <span class="material-symbols-outlined text-lg mr-2">login</span>
                            登录
                        </button>
                        <button onclick="openUserRegister()" class="w-full flex items-center justify-center px-4 py-2 text-sm bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
                            <span class="material-symbols-outlined text-lg mr-2">person_add</span>
                            注册
                        </button>
                    </div>
                    
                    <!-- 已登录状态 -->
                    <div class="mobile-user-logged-in hidden">
                        <div class="flex items-center space-x-3 py-2">
                            <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center">
                                <span class="material-symbols-outlined text-indigo-600">person</span>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm font-medium text-gray-900" id="mobile-user-name">用户名</div>
                                <div class="text-xs text-gray-500" id="mobile-user-email">user@example.com</div>
                            </div>
                        </div>
                        <div class="mt-3 space-y-1">
                            <a href="#" class="block px-3 py-2 text-sm text-gray-600 hover:bg-gray-50 rounded-md flex items-center">
                                <span class="material-symbols-outlined text-lg mr-2">person</span>
                                个人资料
                            </a>
                            <a href="#" class="block px-3 py-2 text-sm text-gray-600 hover:bg-gray-50 rounded-md flex items-center">
                                <span class="material-symbols-outlined text-lg mr-2">settings</span>
                                设置
                            </a>
                            <button onclick="handleUserLogout()" class="w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-md flex items-center">
                                <span class="material-symbols-outlined text-lg mr-2">logout</span>
                                退出登录
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 移动端统计信息 -->
                <div class="px-4 py-3 border-t border-gray-200" id="mobile-nav-stats">
                    <div class="text-sm text-gray-600">
                        学习进度: <span class="text-indigo-600 font-semibold" id="mobile-progress-display">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>
</template>

<script>
class NavbarComponent {
    constructor(container, options = {}) {
        this.container = container;
        this.options = {
            currentPage: '',
            showStats: true,
            progress: 0,
            navLinks: [
                { href: 'index.html', text: '首页', page: 'home' },
                { href: 'subjects.html', text: '课程导航', page: 'subjects' },
                { href: 'practice.html', text: '真题练习', page: 'practice' },
                { href: 'question-manager.html', text: '题目管理', page: 'question-manager' },
                { href: 'resources.html', text: '学习资源', page: 'resources' }
            ],
            ...options
        };
        this.init();
    }

    init() {
        this.render();
        this.bindEvents();
    }

    render() {
        const template = document.getElementById('navbar-template');
        const clone = template.content.cloneNode(true);
        
        this.renderNavLinks(clone);
        this.updateProgress(clone);
        
        this.container.appendChild(clone);
    }

    renderNavLinks(element) {
        const navLinks = element.querySelector('#nav-links');
        const mobileNavLinks = element.querySelector('#mobile-nav-links');
        
        this.options.navLinks.forEach(link => {
            const isActive = link.page === this.options.currentPage;
            
            // 桌面端链接
            const desktopLink = document.createElement('a');
            desktopLink.href = link.href;
            desktopLink.className = isActive 
                ? 'text-indigo-600 font-semibold transition' 
                : 'text-gray-600 hover:text-indigo-600 transition';
            desktopLink.textContent = link.text;
            navLinks.appendChild(desktopLink);
            
            // 移动端链接
            const mobileLink = document.createElement('a');
            mobileLink.href = link.href;
            mobileLink.className = isActive 
                ? 'block px-3 py-2 text-indigo-600 bg-indigo-50 rounded-md font-semibold' 
                : 'block px-3 py-2 text-gray-600 hover:text-indigo-600 hover:bg-gray-50 rounded-md transition';
            mobileLink.textContent = link.text;
            mobileNavLinks.appendChild(mobileLink);
        });
    }

    updateProgress(element = this.container) {
        const progressDisplay = element.querySelector('#progress-display');
        const mobileProgressDisplay = element.querySelector('#mobile-progress-display');
        
        if (progressDisplay) {
            progressDisplay.textContent = `${this.options.progress}%`;
        }
        if (mobileProgressDisplay) {
            mobileProgressDisplay.textContent = `${this.options.progress}%`;
        }
    }

    bindEvents() {
        const mobileMenuBtn = this.container.querySelector('#mobile-menu-btn');
        const mobileMenu = this.container.querySelector('#mobile-menu');
        
        // 移动菜单切换
        if (mobileMenuBtn && mobileMenu) {
            mobileMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                mobileMenu.classList.toggle('hidden');
                const icon = mobileMenuBtn.querySelector('i');
                icon.className = mobileMenu.classList.contains('hidden') 
                    ? 'fas fa-bars text-xl' 
                    : 'fas fa-times text-xl';
            });
        }
        
        // 点击外部关闭移动菜单
        document.addEventListener('click', (e) => {
            if (mobileMenu && !mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                mobileMenu.classList.add('hidden');
                const icon = mobileMenuBtn.querySelector('i');
                icon.className = 'fas fa-bars text-xl';
            }
        });
        
        // 监听用户认证状态变化
        this.initUserAuthStatus();
        this.bindUserAuthEvents();
    }

    initUserAuthStatus() {
        // 检查用户登录状态并更新UI
        this.checkAndUpdateAuthStatus();
        
        // 监听DOM完全加载后再次检查
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => this.checkAndUpdateAuthStatus(), 100);
            });
        }
    }

    checkAndUpdateAuthStatus() {
        // 首先检查localStorage中的认证状态
        const storedUser = localStorage.getItem('auth_user') || localStorage.getItem('currentUser');
        const accessToken = localStorage.getItem('auth_access_token') || localStorage.getItem('authToken');
        const tokenExpiry = localStorage.getItem('auth_token_expiry');
        
        if (storedUser && accessToken) {
            try {
                const user = JSON.parse(storedUser);
                
                // 检查token是否过期
                if (tokenExpiry) {
                    const expiryDate = new Date(tokenExpiry);
                    if (expiryDate > new Date()) {
                        this.updateUserUI(user);
                        console.log('✅ 导航栏：从localStorage恢复用户登录状态:', user.username);
                        return;
                    } else {
                        console.log('⚠️ 导航栏：认证token已过期，清除登录状态');
                        this.clearLocalAuthState();
                    }
                } else {
                    // 没有过期时间，假设仍然有效
                    this.updateUserUI(user);
                    console.log('✅ 导航栏：从localStorage恢复用户登录状态:', user.username);
                    return;
                }
            } catch (e) {
                console.warn('⚠️ 导航栏：解析用户数据失败:', e);
                this.clearLocalAuthState();
            }
        }
        
        // 如果localStorage中没有有效的认证状态，检查authManager
        if (window.authManager && window.authManager.isAuthenticated()) {
            const user = window.authManager.getCurrentUser();
            this.updateUserUI(user);
        } else {
            this.showNotLoggedInState();
        }
    }

    clearLocalAuthState() {
        // 清除所有相关的localStorage项
        localStorage.removeItem('auth_access_token');
        localStorage.removeItem('auth_refresh_token');
        localStorage.removeItem('auth_user');
        localStorage.removeItem('auth_login_time');
        localStorage.removeItem('auth_token_expiry');
        localStorage.removeItem('currentUser');
        localStorage.removeItem('authToken');
        
        this.showNotLoggedInState();
    }

    bindUserAuthEvents() {
        // 监听登录成功事件
        document.addEventListener('userLoggedIn', (event) => {
            this.updateUserUI(event.detail.user);
        });

        // 监听登出事件
        document.addEventListener('userLoggedOut', () => {
            this.showNotLoggedInState();
        });
        
        // 监听认证组件加载完成事件
        document.addEventListener('authComponentLoaded', () => {
            console.log('🔄 导航栏：收到认证组件加载完成事件，重新检查认证状态');
            this.checkAndUpdateAuthStatus();
        });
    }

    updateUserUI(user) {
        // 桌面端更新
        const notLoggedIn = this.container.querySelector('.user-not-logged-in');
        const loggedIn = this.container.querySelector('.user-logged-in');
        const displayName = this.container.querySelector('#user-display-name');
        const menuUserName = this.container.querySelector('#menu-user-name');
        const menuUserEmail = this.container.querySelector('#menu-user-email');

        if (notLoggedIn) notLoggedIn.classList.add('hidden');
        if (loggedIn) loggedIn.classList.remove('hidden');
        if (displayName) displayName.textContent = user.displayName || user.username;
        if (menuUserName) menuUserName.textContent = user.displayName || user.username;
        if (menuUserEmail) menuUserEmail.textContent = user.email;

        // 移动端更新
        const mobileNotLoggedIn = this.container.querySelector('.mobile-user-not-logged-in');
        const mobileLoggedIn = this.container.querySelector('.mobile-user-logged-in');
        const mobileUserName = this.container.querySelector('#mobile-user-name');
        const mobileUserEmail = this.container.querySelector('#mobile-user-email');

        if (mobileNotLoggedIn) mobileNotLoggedIn.classList.add('hidden');
        if (mobileLoggedIn) mobileLoggedIn.classList.remove('hidden');
        if (mobileUserName) mobileUserName.textContent = user.displayName || user.username;
        if (mobileUserEmail) mobileUserEmail.textContent = user.email;
    }

    showNotLoggedInState() {
        // 桌面端更新
        const notLoggedIn = this.container.querySelector('.user-not-logged-in');
        const loggedIn = this.container.querySelector('.user-logged-in');

        if (notLoggedIn) notLoggedIn.classList.remove('hidden');
        if (loggedIn) loggedIn.classList.add('hidden');

        // 移动端更新
        const mobileNotLoggedIn = this.container.querySelector('.mobile-user-not-logged-in');
        const mobileLoggedIn = this.container.querySelector('.mobile-user-logged-in');

        if (mobileNotLoggedIn) mobileNotLoggedIn.classList.remove('hidden');
        if (mobileLoggedIn) mobileLoggedIn.classList.add('hidden');
    }

    setProgress(progress) {
        this.options.progress = progress;
        this.updateProgress();
    }

    setActivePage(page) {
        this.options.currentPage = page;
        // 重新渲染导航链接
        const navLinks = this.container.querySelector('#nav-links');
        const mobileNavLinks = this.container.querySelector('#mobile-nav-links');
        if (navLinks && mobileNavLinks) {
            navLinks.innerHTML = '';
            mobileNavLinks.innerHTML = '';
            const fakeElement = { querySelector: (selector) => {
                if (selector === '#nav-links') return navLinks;
                if (selector === '#mobile-nav-links') return mobileNavLinks;
            }};
            this.renderNavLinks(fakeElement);
        }
    }
}

// 导出组件类
window.NavbarComponent = NavbarComponent;

// 全局登出处理函数
window.handleUserLogout = function() {
    try {
        // 清除所有认证相关的localStorage
        localStorage.removeItem('auth_access_token');
        localStorage.removeItem('auth_refresh_token');
        localStorage.removeItem('auth_user');
        localStorage.removeItem('auth_login_time');
        localStorage.removeItem('auth_token_expiry');
        localStorage.removeItem('currentUser');
        localStorage.removeItem('authToken');
        
        // 触发登出事件
        const logoutEvent = new CustomEvent('userLoggedOut', {
            bubbles: true
        });
        document.dispatchEvent(logoutEvent);
        
        console.log('✅ 全局登出：用户已登出');
        
        // 刷新页面以重置状态
        window.location.reload();
    } catch (error) {
        console.error('❌ 全局登出错误:', error);
        alert('登出失败，请重试');
    }
};
</script>