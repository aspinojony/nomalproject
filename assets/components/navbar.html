<!-- ÂèÇËÄÉ subjects.html ÁöÑÁÆÄÊ¥ÅÂØºËà™Ê†èÁªÑ‰ª∂ -->
<template id="navbar-template">
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <!-- Logo ÂíåÂìÅÁâå -->
                <div class="flex items-center space-x-2">
                    <a href="index.html" class="flex items-center space-x-2">
                        <i class="fas fa-graduation-cap text-2xl text-indigo-600"></i>
                        <h1 class="text-xl font-bold text-gray-800">ËÆ°ÁÆóÊú∫ËÄÉÁ†îÂπ≥Âè∞</h1>
                    </a>
                </div>

                <!-- Ê°åÈù¢Á´ØÂØºËà™ÈìæÊé• -->
                <div class="hidden md:flex space-x-6" id="nav-links">
                    <!-- ÂØºËà™ÈìæÊé•Â∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                </div>

                <!-- Âè≥‰æßÂäüËÉΩÂå∫ -->
                <div class="flex items-center space-x-4">
                    <!-- Â≠¶‰π†ËøõÂ∫¶ÊòæÁ§∫ -->
                    <div class="hidden md:block text-sm text-gray-600" id="nav-stats">
                        Â≠¶‰π†ËøõÂ∫¶: <span class="text-indigo-600 font-semibold" id="progress-display">0%</span>
                    </div>
                    
                    <!-- Áî®Êà∑ËÆ§ËØÅÂå∫Âüü -->
                    <div class="flex items-center space-x-2" id="user-auth-area">
                        <!-- Êú™ÁôªÂΩïÁä∂ÊÄÅ -->
                        <div class="user-not-logged-in flex items-center space-x-2">
                            <button onclick="openUserLogin()" class="hidden md:inline-flex items-center px-3 py-1 text-sm text-gray-600 hover:text-indigo-600 transition">
                                <span class="material-symbols-outlined text-lg mr-1">login</span>
                                ÁôªÂΩï
                            </button>
                            <button onclick="openUserRegister()" class="hidden md:inline-flex items-center px-3 py-1 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition text-sm">
                                <span class="material-symbols-outlined text-lg mr-1">person_add</span>
                                Ê≥®ÂÜå
                            </button>
                        </div>
                        
                        <!-- Â∑≤ÁôªÂΩïÁä∂ÊÄÅ -->
                        <div class="user-logged-in hidden flex items-center space-x-2">
                            <div class="relative" x-data="{ open: false }">
                                <button @click="open = !open" class="flex items-center space-x-2 text-gray-600 hover:text-indigo-600 transition">
                                    <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center">
                                        <span class="material-symbols-outlined text-indigo-600">person</span>
                                    </div>
                                    <span class="hidden md:block text-sm font-medium" id="user-display-name">Áî®Êà∑</span>
                                    <span class="material-symbols-outlined text-sm">expand_more</span>
                                </button>
                                
                                <!-- Áî®Êà∑ËèúÂçï -->
                                <div x-show="open" @click.away="open = false" 
                                     x-transition:enter="transition ease-out duration-100"
                                     x-transition:enter-start="transform opacity-0 scale-95"
                                     x-transition:enter-end="transform opacity-100 scale-100"
                                     x-transition:leave="transition ease-in duration-75"
                                     x-transition:leave-start="transform opacity-100 scale-100"
                                     x-transition:leave-end="transform opacity-0 scale-95"
                                     class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 border">
                                    <div class="px-4 py-2 text-sm text-gray-500 border-b">
                                        <div class="font-medium" id="menu-user-name">Áî®Êà∑Âêç</div>
                                        <div class="text-xs" id="menu-user-email">user@example.com</div>
                                    </div>
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                        <span class="material-symbols-outlined text-lg mr-2">person</span>
                                        ‰∏™‰∫∫ËµÑÊñô
                                    </a>
                                    <button onclick="showUserDataModal()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                        <span class="material-symbols-outlined text-lg mr-2">analytics</span>
                                        ÊàëÁöÑÊï∞ÊçÆ
                                    </button>
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                        <span class="material-symbols-outlined text-lg mr-2">settings</span>
                                        ËÆæÁΩÆ
                                    </a>
                                    <div class="border-t">
                                        <button onclick="handleUserLogout()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center">
                                            <span class="material-symbols-outlined text-lg mr-2">logout</span>
                                            ÈÄÄÂá∫ÁôªÂΩï
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÁßªÂä®Á´ØËèúÂçïÊåâÈíÆ -->
                    <button class="md:hidden text-gray-600 hover:text-indigo-600" id="mobile-menu-btn">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- ÁßªÂä®Á´ØÂØºËà™ËèúÂçï -->
            <div class="md:hidden border-t border-gray-200 bg-white hidden" id="mobile-menu">
                <div class="px-2 pt-2 pb-3 space-y-1" id="mobile-nav-links">
                    <!-- ÁßªÂä®Á´ØÂØºËà™ÈìæÊé• -->
                </div>
                
                <!-- ÁßªÂä®Á´ØÁî®Êà∑ËÆ§ËØÅÂå∫Âüü -->
                <div class="px-4 py-3 border-t border-gray-200" id="mobile-user-auth">
                    <!-- Êú™ÁôªÂΩïÁä∂ÊÄÅ -->
                    <div class="mobile-user-not-logged-in space-y-2">
                        <button onclick="openUserLogin()" class="w-full flex items-center justify-center px-4 py-2 text-sm text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition">
                            <span class="material-symbols-outlined text-lg mr-2">login</span>
                            ÁôªÂΩï
                        </button>
                        <button onclick="openUserRegister()" class="w-full flex items-center justify-center px-4 py-2 text-sm bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
                            <span class="material-symbols-outlined text-lg mr-2">person_add</span>
                            Ê≥®ÂÜå
                        </button>
                    </div>
                    
                    <!-- Â∑≤ÁôªÂΩïÁä∂ÊÄÅ -->
                    <div class="mobile-user-logged-in hidden">
                        <div class="flex items-center space-x-3 py-2">
                            <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center">
                                <span class="material-symbols-outlined text-indigo-600">person</span>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm font-medium text-gray-900" id="mobile-user-name">Áî®Êà∑Âêç</div>
                                <div class="text-xs text-gray-500" id="mobile-user-email">user@example.com</div>
                            </div>
                        </div>
                        <div class="mt-3 space-y-1">
                            <a href="#" class="block px-3 py-2 text-sm text-gray-600 hover:bg-gray-50 rounded-md flex items-center">
                                <span class="material-symbols-outlined text-lg mr-2">person</span>
                                ‰∏™‰∫∫ËµÑÊñô
                            </a>
                            <a href="#" class="block px-3 py-2 text-sm text-gray-600 hover:bg-gray-50 rounded-md flex items-center">
                                <span class="material-symbols-outlined text-lg mr-2">settings</span>
                                ËÆæÁΩÆ
                            </a>
                            <button onclick="handleUserLogout()" class="w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-md flex items-center">
                                <span class="material-symbols-outlined text-lg mr-2">logout</span>
                                ÈÄÄÂá∫ÁôªÂΩï
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ÁßªÂä®Á´ØÁªüËÆ°‰ø°ÊÅØ -->
                <div class="px-4 py-3 border-t border-gray-200" id="mobile-nav-stats">
                    <div class="text-sm text-gray-600">
                        Â≠¶‰π†ËøõÂ∫¶: <span class="text-indigo-600 font-semibold" id="mobile-progress-display">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>
</template>

<script>
class NavbarComponent {
    constructor(container, options = {}) {
        this.container = container;
        this.options = {
            currentPage: '',
            showStats: true,
            progress: 0,
            navLinks: [
                { href: 'index.html', text: 'È¶ñÈ°µ', page: 'home' },
                { href: 'subjects.html', text: 'ËØæÁ®ãÂØºËà™', page: 'subjects' },
                { href: 'practice.html', text: 'ÁúüÈ¢òÁªÉ‰π†', page: 'practice' },
                { href: 'question-manager.html', text: 'È¢òÁõÆÁÆ°ÁêÜ', page: 'question-manager' },
                { href: 'resources.html', text: 'Â≠¶‰π†ËµÑÊ∫ê', page: 'resources' }
            ],
            ...options
        };
        this.init();
    }

    init() {
        this.render();
        this.bindEvents();
    }

    render() {
        const template = document.getElementById('navbar-template');
        const clone = template.content.cloneNode(true);
        
        this.renderNavLinks(clone);
        this.updateProgress(clone);
        
        this.container.appendChild(clone);
    }

    renderNavLinks(element) {
        const navLinks = element.querySelector('#nav-links');
        const mobileNavLinks = element.querySelector('#mobile-nav-links');
        
        this.options.navLinks.forEach(link => {
            const isActive = link.page === this.options.currentPage;
            
            // Ê°åÈù¢Á´ØÈìæÊé•
            const desktopLink = document.createElement('a');
            desktopLink.href = link.href;
            desktopLink.className = isActive 
                ? 'text-indigo-600 font-semibold transition' 
                : 'text-gray-600 hover:text-indigo-600 transition';
            desktopLink.textContent = link.text;
            navLinks.appendChild(desktopLink);
            
            // ÁßªÂä®Á´ØÈìæÊé•
            const mobileLink = document.createElement('a');
            mobileLink.href = link.href;
            mobileLink.className = isActive 
                ? 'block px-3 py-2 text-indigo-600 bg-indigo-50 rounded-md font-semibold' 
                : 'block px-3 py-2 text-gray-600 hover:text-indigo-600 hover:bg-gray-50 rounded-md transition';
            mobileLink.textContent = link.text;
            mobileNavLinks.appendChild(mobileLink);
        });
    }

    updateProgress(element = this.container) {
        const progressDisplay = element.querySelector('#progress-display');
        const mobileProgressDisplay = element.querySelector('#mobile-progress-display');
        
        if (progressDisplay) {
            progressDisplay.textContent = `${this.options.progress}%`;
        }
        if (mobileProgressDisplay) {
            mobileProgressDisplay.textContent = `${this.options.progress}%`;
        }
    }

    bindEvents() {
        const mobileMenuBtn = this.container.querySelector('#mobile-menu-btn');
        const mobileMenu = this.container.querySelector('#mobile-menu');
        
        // ÁßªÂä®ËèúÂçïÂàáÊç¢
        if (mobileMenuBtn && mobileMenu) {
            mobileMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                mobileMenu.classList.toggle('hidden');
                const icon = mobileMenuBtn.querySelector('i');
                icon.className = mobileMenu.classList.contains('hidden') 
                    ? 'fas fa-bars text-xl' 
                    : 'fas fa-times text-xl';
            });
        }
        
        // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠ÁßªÂä®ËèúÂçï
        document.addEventListener('click', (e) => {
            if (mobileMenu && !mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                mobileMenu.classList.add('hidden');
                const icon = mobileMenuBtn.querySelector('i');
                icon.className = 'fas fa-bars text-xl';
            }
        });
        
        // ÁõëÂê¨Áî®Êà∑ËÆ§ËØÅÁä∂ÊÄÅÂèòÂåñ
        this.initUserAuthStatus();
        this.bindUserAuthEvents();
    }

    initUserAuthStatus() {
        // Ê£ÄÊü•Áî®Êà∑ÁôªÂΩïÁä∂ÊÄÅÂπ∂Êõ¥Êñ∞UI
        this.checkAndUpdateAuthStatus();
        
        // ÁõëÂê¨DOMÂÆåÂÖ®Âä†ËΩΩÂêéÂÜçÊ¨°Ê£ÄÊü•
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => this.checkAndUpdateAuthStatus(), 100);
            });
        }
    }

    checkAndUpdateAuthStatus() {
        // È¶ñÂÖàÊ£ÄÊü•localStorage‰∏≠ÁöÑËÆ§ËØÅÁä∂ÊÄÅ
        const storedUser = localStorage.getItem('auth_user') || localStorage.getItem('currentUser');
        const accessToken = localStorage.getItem('auth_access_token') || localStorage.getItem('authToken');
        const tokenExpiry = localStorage.getItem('auth_token_expiry');
        
        if (storedUser && accessToken) {
            try {
                const user = JSON.parse(storedUser);
                
                // Ê£ÄÊü•tokenÊòØÂê¶ËøáÊúü
                if (tokenExpiry) {
                    const expiryDate = new Date(tokenExpiry);
                    if (expiryDate > new Date()) {
                        this.updateUserUI(user);
                        console.log('‚úÖ ÂØºËà™Ê†èÔºö‰ªélocalStorageÊÅ¢Â§çÁî®Êà∑ÁôªÂΩïÁä∂ÊÄÅ:', user.username);
                        return;
                    } else {
                        console.log('‚ö†Ô∏è ÂØºËà™Ê†èÔºöËÆ§ËØÅtokenÂ∑≤ËøáÊúüÔºåÊ∏ÖÈô§ÁôªÂΩïÁä∂ÊÄÅ');
                        this.clearLocalAuthState();
                    }
                } else {
                    // Ê≤°ÊúâËøáÊúüÊó∂Èó¥ÔºåÂÅáËÆæ‰ªçÁÑ∂ÊúâÊïà
                    this.updateUserUI(user);
                    console.log('‚úÖ ÂØºËà™Ê†èÔºö‰ªélocalStorageÊÅ¢Â§çÁî®Êà∑ÁôªÂΩïÁä∂ÊÄÅ:', user.username);
                    return;
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è ÂØºËà™Ê†èÔºöËß£ÊûêÁî®Êà∑Êï∞ÊçÆÂ§±Ë¥•:', e);
                this.clearLocalAuthState();
            }
        }
        
        // Â¶ÇÊûúlocalStorage‰∏≠Ê≤°ÊúâÊúâÊïàÁöÑËÆ§ËØÅÁä∂ÊÄÅÔºåÊ£ÄÊü•authManager
        if (window.authManager && window.authManager.isAuthenticated()) {
            const user = window.authManager.getCurrentUser();
            this.updateUserUI(user);
        } else {
            this.showNotLoggedInState();
        }
    }

    clearLocalAuthState() {
        // Ê∏ÖÈô§ÊâÄÊúâÁõ∏ÂÖ≥ÁöÑlocalStorageÈ°π
        localStorage.removeItem('auth_access_token');
        localStorage.removeItem('auth_refresh_token');
        localStorage.removeItem('auth_user');
        localStorage.removeItem('auth_login_time');
        localStorage.removeItem('auth_token_expiry');
        localStorage.removeItem('currentUser');
        localStorage.removeItem('authToken');
        
        this.showNotLoggedInState();
    }

    bindUserAuthEvents() {
        // ÁõëÂê¨ÁôªÂΩïÊàêÂäü‰∫ã‰ª∂
        document.addEventListener('userLoggedIn', (event) => {
            this.updateUserUI(event.detail.user);
        });

        // ÁõëÂê¨ÁôªÂá∫‰∫ã‰ª∂
        document.addEventListener('userLoggedOut', () => {
            this.showNotLoggedInState();
        });
        
        // ÁõëÂê¨ËÆ§ËØÅÁªÑ‰ª∂Âä†ËΩΩÂÆåÊàê‰∫ã‰ª∂
        document.addEventListener('authComponentLoaded', () => {
            console.log('üîÑ ÂØºËà™Ê†èÔºöÊî∂Âà∞ËÆ§ËØÅÁªÑ‰ª∂Âä†ËΩΩÂÆåÊàê‰∫ã‰ª∂ÔºåÈáçÊñ∞Ê£ÄÊü•ËÆ§ËØÅÁä∂ÊÄÅ');
            this.checkAndUpdateAuthStatus();
        });
    }

    updateUserUI(user) {
        // Ê°åÈù¢Á´ØÊõ¥Êñ∞
        const notLoggedIn = this.container.querySelector('.user-not-logged-in');
        const loggedIn = this.container.querySelector('.user-logged-in');
        const displayName = this.container.querySelector('#user-display-name');
        const menuUserName = this.container.querySelector('#menu-user-name');
        const menuUserEmail = this.container.querySelector('#menu-user-email');

        if (notLoggedIn) notLoggedIn.classList.add('hidden');
        if (loggedIn) loggedIn.classList.remove('hidden');
        if (displayName) displayName.textContent = user.displayName || user.username;
        if (menuUserName) menuUserName.textContent = user.displayName || user.username;
        if (menuUserEmail) menuUserEmail.textContent = user.email;

        // ÁßªÂä®Á´ØÊõ¥Êñ∞
        const mobileNotLoggedIn = this.container.querySelector('.mobile-user-not-logged-in');
        const mobileLoggedIn = this.container.querySelector('.mobile-user-logged-in');
        const mobileUserName = this.container.querySelector('#mobile-user-name');
        const mobileUserEmail = this.container.querySelector('#mobile-user-email');

        if (mobileNotLoggedIn) mobileNotLoggedIn.classList.add('hidden');
        if (mobileLoggedIn) mobileLoggedIn.classList.remove('hidden');
        if (mobileUserName) mobileUserName.textContent = user.displayName || user.username;
        if (mobileUserEmail) mobileUserEmail.textContent = user.email;
    }

    showNotLoggedInState() {
        // Ê°åÈù¢Á´ØÊõ¥Êñ∞
        const notLoggedIn = this.container.querySelector('.user-not-logged-in');
        const loggedIn = this.container.querySelector('.user-logged-in');

        if (notLoggedIn) notLoggedIn.classList.remove('hidden');
        if (loggedIn) loggedIn.classList.add('hidden');

        // ÁßªÂä®Á´ØÊõ¥Êñ∞
        const mobileNotLoggedIn = this.container.querySelector('.mobile-user-not-logged-in');
        const mobileLoggedIn = this.container.querySelector('.mobile-user-logged-in');

        if (mobileNotLoggedIn) mobileNotLoggedIn.classList.remove('hidden');
        if (mobileLoggedIn) mobileLoggedIn.classList.add('hidden');
    }

    setProgress(progress) {
        this.options.progress = progress;
        this.updateProgress();
    }

    setActivePage(page) {
        this.options.currentPage = page;
        // ÈáçÊñ∞Ê∏≤ÊüìÂØºËà™ÈìæÊé•
        const navLinks = this.container.querySelector('#nav-links');
        const mobileNavLinks = this.container.querySelector('#mobile-nav-links');
        if (navLinks && mobileNavLinks) {
            navLinks.innerHTML = '';
            mobileNavLinks.innerHTML = '';
            const fakeElement = { querySelector: (selector) => {
                if (selector === '#nav-links') return navLinks;
                if (selector === '#mobile-nav-links') return mobileNavLinks;
            }};
            this.renderNavLinks(fakeElement);
        }
    }
}

// ÂØºÂá∫ÁªÑ‰ª∂Á±ª
window.NavbarComponent = NavbarComponent;

// ÂÖ®Â±ÄÁôªÂá∫Â§ÑÁêÜÂáΩÊï∞
window.handleUserLogout = function() {
    try {
        // Ê∏ÖÈô§ÊâÄÊúâËÆ§ËØÅÁõ∏ÂÖ≥ÁöÑlocalStorage
        localStorage.removeItem('auth_access_token');
        localStorage.removeItem('auth_refresh_token');
        localStorage.removeItem('auth_user');
        localStorage.removeItem('auth_login_time');
        localStorage.removeItem('auth_token_expiry');
        localStorage.removeItem('currentUser');
        localStorage.removeItem('authToken');
        
        // Ëß¶ÂèëÁôªÂá∫‰∫ã‰ª∂
        const logoutEvent = new CustomEvent('userLoggedOut', {
            bubbles: true
        });
        document.dispatchEvent(logoutEvent);
        
        console.log('‚úÖ ÂÖ®Â±ÄÁôªÂá∫ÔºöÁî®Êà∑Â∑≤ÁôªÂá∫');
        
        // Âà∑Êñ∞È°µÈù¢‰ª•ÈáçÁΩÆÁä∂ÊÄÅ
        window.location.reload();
    } catch (error) {
        console.error('‚ùå ÂÖ®Â±ÄÁôªÂá∫ÈîôËØØ:', error);
        alert('ÁôªÂá∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
    }
};
</script>