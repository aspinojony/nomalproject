<!-- 云同步登录模态框 -->
<div x-data="loginModal" 
     x-show="showModal" 
     x-transition:enter="transition ease-out duration-200"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     class="fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-50"
     style="display: none;">
    
    <div class="flex min-h-full items-center justify-center p-4">
        <div x-show="showModal"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             class="relative bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            
            <!-- 模态框头部 -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900" x-text="mode === 'login' ? '登录账号' : '注册账号'"></h3>
                <button @click="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- 模态框内容 -->
            <div class="p-6">
                <!-- 错误提示 -->
                <div x-show="error" 
                     x-transition
                     class="mb-4 p-3 bg-red-50 border border-red-200 rounded-md">
                    <p class="text-sm text-red-600" x-text="error"></p>
                </div>

                <!-- 成功提示 -->
                <div x-show="success" 
                     x-transition
                     class="mb-4 p-3 bg-green-50 border border-green-200 rounded-md">
                    <p class="text-sm text-green-600" x-text="success"></p>
                </div>

                <!-- 登录表单 -->
                <form x-show="mode === 'login'" @submit.prevent="handleLogin()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                用户名或邮箱
                            </label>
                            <input type="text" 
                                   x-model="loginForm.identifier"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="请输入用户名或邮箱"
                                   required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                密码
                            </label>
                            <input type="password" 
                                   x-model="loginForm.password"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="请输入密码"
                                   required>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <label class="flex items-center">
                                <input type="checkbox" x-model="loginForm.remember" class="mr-2">
                                <span class="text-gray-600">记住登录状态</span>
                            </label>
                            <a href="#" class="text-blue-600 hover:text-blue-500">忘记密码？</a>
                        </div>
                    </div>
                    <div class="mt-6 flex space-x-3">
                        <button type="submit" 
                                :disabled="loading"
                                class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                            <span x-show="!loading">登录</span>
                            <span x-show="loading">登录中...</span>
                        </button>
                        <button type="button" 
                                @click="switchMode()"
                                class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors">
                            注册账号
                        </button>
                    </div>
                </form>

                <!-- 注册表单 -->
                <form x-show="mode === 'register'" @submit.prevent="handleRegister()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                用户名
                            </label>
                            <input type="text" 
                                   x-model="registerForm.username"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="3-30个字符，支持中文、字母、数字、下划线"
                                   required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                邮箱
                            </label>
                            <input type="email" 
                                   x-model="registerForm.email"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="请输入有效的邮箱地址"
                                   required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                显示名称（可选）
                            </label>
                            <input type="text" 
                                   x-model="registerForm.displayName"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="显示在对话中的名称">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                密码
                            </label>
                            <input type="password" 
                                   x-model="registerForm.password"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="至少6个字符，包含字母和数字"
                                   required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                确认密码
                            </label>
                            <input type="password" 
                                   x-model="registerForm.confirmPassword"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="再次输入密码"
                                   required>
                        </div>
                        <div class="text-sm">
                            <label class="flex items-start">
                                <input type="checkbox" x-model="registerForm.agree" class="mr-2 mt-0.5" required>
                                <span class="text-gray-600">
                                    我已阅读并同意
                                    <a href="#" class="text-blue-600 hover:text-blue-500">用户协议</a>
                                    和
                                    <a href="#" class="text-blue-600 hover:text-blue-500">隐私政策</a>
                                </span>
                            </label>
                        </div>
                    </div>
                    <div class="mt-6 flex space-x-3">
                        <button type="submit" 
                                :disabled="loading || !registerForm.agree || registerForm.password !== registerForm.confirmPassword"
                                class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                            <span x-show="!loading">注册</span>
                            <span x-show="loading">注册中...</span>
                        </button>
                        <button type="button" 
                                @click="switchMode()"
                                class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors">
                            返回登录
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function loginModal() {
    return {
        showModal: false,
        mode: 'login', // 'login' | 'register'
        loading: false,
        error: '',
        success: '',
        
        loginForm: {
            identifier: '',
            password: '',
            remember: false
        },
        
        registerForm: {
            username: '',
            email: '',
            displayName: '',
            password: '',
            confirmPassword: '',
            agree: false
        },
        
        init() {
            // 监听云同步状态变化
            window.addEventListener('needLogin', () => {
                this.openModal('login');
            });
            
            // 监听登录成功事件
            window.addEventListener('loginSuccess', (event) => {
                this.success = `欢迎回来，${event.detail.user.username}！`;
                setTimeout(() => {
                    this.closeModal();
                }, 2000);
            });
        },
        
        openModal(mode = 'login') {
            this.mode = mode;
            this.showModal = true;
            this.clearMessages();
        },
        
        closeModal() {
            this.showModal = false;
            this.clearForms();
            this.clearMessages();
        },
        
        switchMode() {
            this.mode = this.mode === 'login' ? 'register' : 'login';
            this.clearMessages();
        },
        
        clearForms() {
            this.loginForm = {
                identifier: '',
                password: '',
                remember: false
            };
            this.registerForm = {
                username: '',
                email: '',
                displayName: '',
                password: '',
                confirmPassword: '',
                agree: false
            };
        },
        
        clearMessages() {
            this.error = '';
            this.success = '';
        },
        
        async handleLogin() {
            if (this.loading) return;
            
            this.loading = true;
            this.clearMessages();
            
            try {
                const result = await window.aiConversationStorage.login(
                    this.loginForm.identifier,
                    this.loginForm.password
                );
                
                if (result.success) {
                    this.success = `欢迎回来，${result.user.username}！`;
                    
                    // 触发登录成功事件
                    window.dispatchEvent(new CustomEvent('loginSuccess', {
                        detail: result
                    }));
                    
                    setTimeout(() => {
                        this.closeModal();
                    }, 1500);
                } else {
                    this.error = result.message || '登录失败';
                }
            } catch (error) {
                console.error('登录错误:', error);
                this.error = '登录失败，请检查网络连接';
            } finally {
                this.loading = false;
            }
        },
        
        async handleRegister() {
            if (this.loading) return;
            
            // 验证密码匹配
            if (this.registerForm.password !== this.registerForm.confirmPassword) {
                this.error = '两次输入的密码不匹配';
                return;
            }
            
            this.loading = true;
            this.clearMessages();
            
            try {
                const result = await window.aiConversationStorage.register(
                    this.registerForm.username,
                    this.registerForm.email,
                    this.registerForm.password,
                    this.registerForm.displayName
                );
                
                if (result.success) {
                    this.success = `注册成功，欢迎 ${result.user.username}！`;
                    
                    // 触发注册成功事件
                    window.dispatchEvent(new CustomEvent('registerSuccess', {
                        detail: result
                    }));
                    
                    setTimeout(() => {
                        this.closeModal();
                    }, 1500);
                } else {
                    this.error = result.message || '注册失败';
                    if (result.errors && result.errors.length > 0) {
                        this.error = result.errors.map(err => err.msg).join('；');
                    }
                }
            } catch (error) {
                console.error('注册错误:', error);
                this.error = '注册失败，请检查网络连接';
            } finally {
                this.loading = false;
            }
        }
    }
}
</script>