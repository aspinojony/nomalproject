<!-- 笔记管理弹窗组件 -->
<div x-show="showNotesModal" 
     x-cloak
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
     @click.self="showNotesModal = false">
    <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
        <!-- 头部 -->
        <div class="flex justify-between items-center p-6 border-b bg-gray-50">
            <div class="flex items-center space-x-3">
                <i class="fas fa-sticky-note text-indigo-600 text-xl"></i>
                <div>
                    <h3 class="text-xl font-bold text-gray-800">学习笔记</h3>
                    <p class="text-sm text-gray-600" x-text="currentNoteSubject?.name || '全部笔记'"></p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <!-- 搜索框 -->
                <div class="relative">
                    <input type="text" 
                           x-model="noteSearchQuery"
                           @input="searchNotes()"
                           placeholder="搜索笔记..." 
                           class="pl-10 pr-4 py-2 border rounded-lg text-sm w-64 focus:border-indigo-500 focus:outline-none">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400 text-sm"></i>
                </div>
                <button @click="showNotesModal = false" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <div class="flex flex-1 overflow-hidden">
            <!-- 左侧：笔记列表 -->
            <div class="w-1/3 border-r bg-gray-50 overflow-y-auto">
                <!-- 筛选器 -->
                <div class="p-4 border-b bg-white">
                    <div class="space-y-3">
                        <!-- 科目筛选 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">科目</label>
                            <select x-model="noteFilterSubject" 
                                    @change="filterNotes()"
                                    class="w-full p-2 border rounded text-sm">
                                <option value="">全部科目</option>
                                <template x-for="subject in allSubjects" :key="subject.id">
                                    <option :value="subject.id" x-text="subject.name"></option>
                                </template>
                            </select>
                        </div>
                        
                        <!-- 标签筛选 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">标签</label>
                            <div class="flex flex-wrap gap-1">
                                <template x-for="tag in allNoteTags" :key="tag">
                                    <button @click="toggleTagFilter(tag)"
                                            :class="selectedTagFilters.includes(tag) ? 
                                                   'bg-indigo-100 text-indigo-800' : 'bg-gray-100 text-gray-600'"
                                            class="px-2 py-1 rounded text-xs hover:bg-indigo-50">
                                        #<span x-text="tag"></span>
                                    </button>
                                </template>
                            </div>
                        </div>
                        
                        <!-- 新建笔记按钮 -->
                        <button @click="createNewNote()" 
                                class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition text-sm font-medium">
                            <i class="fas fa-plus mr-2"></i>新建笔记
                        </button>
                    </div>
                </div>

                <!-- 笔记列表 -->
                <div class="p-4">
                    <template x-for="note in filteredNotes" :key="note.id">
                        <div @click="selectNote(note)"
                             :class="selectedNote?.id === note.id ? 
                                     'bg-indigo-50 border-indigo-200' : 'bg-white border-gray-200'"
                             class="p-4 border rounded-lg mb-3 cursor-pointer hover:bg-gray-50 transition">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-medium text-gray-800 text-sm" x-text="note.title"></h4>
                                <div class="flex items-center space-x-1">
                                    <button @click.stop="editNote(note)" 
                                            class="text-gray-400 hover:text-indigo-600 text-xs">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button @click.stop="deleteNote(note.id)" 
                                            class="text-gray-400 hover:text-red-600 text-xs">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="text-xs text-gray-500 mb-2" x-text="note.subjectName + ' • ' + note.chapterName"></div>
                            
                            <div class="text-xs text-gray-600 mb-2" x-text="note.content.substring(0, 80) + '...'"></div>
                            
                            <!-- 标签 -->
                            <div class="flex flex-wrap gap-1 mb-2">
                                <template x-for="tag in note.tags" :key="tag">
                                    <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">
                                        #<span x-text="tag"></span>
                                    </span>
                                </template>
                            </div>
                            
                            <div class="text-xs text-gray-400" x-text="formatNoteDate(note.updatedAt)"></div>
                        </div>
                    </template>
                    
                    <div x-show="filteredNotes.length === 0" class="text-center text-gray-500 py-8">
                        <i class="fas fa-sticky-note text-3xl mb-3 opacity-50"></i>
                        <p>暂无笔记</p>
                    </div>
                </div>
            </div>

            <!-- 右侧：笔记编辑器 -->
            <div class="flex-1 flex flex-col">
                <div x-show="selectedNote" class="flex-1 flex flex-col">
                    <!-- 笔记头部 -->
                    <div class="p-4 border-b bg-gray-50">
                        <div class="flex justify-between items-center mb-3">
                            <input type="text" 
                                   x-model="selectedNote.title"
                                   @input="updateNote()"
                                   placeholder="笔记标题..."
                                   class="text-lg font-semibold bg-transparent border-none focus:outline-none flex-1">
                            <div class="flex items-center space-x-2">
                                <button @click="exportSelectedNote()" 
                                        class="text-gray-500 hover:text-indigo-600" 
                                        title="导出单个笔记">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button @click="exportAllNotesAsFile()" 
                                        class="text-gray-500 hover:text-green-600" 
                                        title="导出所有笔记">
                                    <i class="fas fa-file-export"></i>
                                </button>
                                <button @click="importNotesFromFile()" 
                                        class="text-gray-500 hover:text-blue-600" 
                                        title="导入笔记">
                                    <i class="fas fa-file-import"></i>
                                </button>
                                <button @click="shareNote()" 
                                        class="text-gray-500 hover:text-indigo-600" 
                                        title="分享笔记">
                                    <i class="fas fa-share"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 元信息 -->
                        <div class="flex items-center space-x-4 text-sm">
                            <select x-model="selectedNote.subjectId" 
                                    @change="updateNote()"
                                    class="border rounded px-2 py-1 text-sm">
                                <template x-for="subject in allSubjects" :key="subject.id">
                                    <option :value="subject.id" x-text="subject.name"></option>
                                </template>
                            </select>
                            
                            <select x-model="selectedNote.chapterId" 
                                    @change="updateNote()"
                                    class="border rounded px-2 py-1 text-sm">
                                <option value="">选择章节</option>
                                <template x-for="chapter in getChaptersBySubject(selectedNote.subjectId)" :key="chapter.name || chapter.id">
                                    <option :value="chapter.name || chapter.id" x-text="chapter.name"></option>
                                </template>
                            </select>
                            
                            <span class="text-gray-500" x-text="'最后编辑: ' + formatNoteDate(selectedNote.updatedAt)"></span>
                        </div>
                        
                        <!-- 标签编辑 -->
                        <div class="mt-3">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600">标签:</span>
                                <div class="flex flex-wrap gap-1 flex-1">
                                    <template x-for="tag in selectedNote.tags" :key="tag">
                                        <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-xs flex items-center">
                                            #<span x-text="tag"></span>
                                            <button @click="removeNoteTag(tag)" class="ml-1 text-indigo-600 hover:text-indigo-800">
                                                <i class="fas fa-times text-xs"></i>
                                            </button>
                                        </span>
                                    </template>
                                    <input type="text" 
                                           x-model="newNoteTag"
                                           @keydown.enter="addNoteTag()"
                                           placeholder="添加标签..."
                                           class="border-none bg-transparent text-sm focus:outline-none">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 编辑器工具栏 -->
                    <div class="p-3 border-b bg-white">
                        <div class="flex items-center space-x-3 text-sm">
                            <button @click="insertMarkdown('**', '**')" 
                                    class="text-gray-600 hover:text-indigo-600" title="粗体">
                                <i class="fas fa-bold"></i>
                            </button>
                            <button @click="insertMarkdown('*', '*')" 
                                    class="text-gray-600 hover:text-indigo-600" title="斜体">
                                <i class="fas fa-italic"></i>
                            </button>
                            <button @click="insertMarkdown('`', '`')" 
                                    class="text-gray-600 hover:text-indigo-600" title="代码">
                                <i class="fas fa-code"></i>
                            </button>
                            <span class="text-gray-300">|</span>
                            <button @click="insertMarkdown('## ', '')" 
                                    class="text-gray-600 hover:text-indigo-600" title="标题">
                                <i class="fas fa-heading"></i>
                            </button>
                            <button @click="insertMarkdown('- ', '')" 
                                    class="text-gray-600 hover:text-indigo-600" title="列表">
                                <i class="fas fa-list"></i>
                            </button>
                            <button @click="insertMarkdown('[链接文字](URL)', '')" 
                                    class="text-gray-600 hover:text-indigo-600" title="链接">
                                <i class="fas fa-link"></i>
                            </button>
                            <span class="text-gray-300">|</span>
                            <button @click="togglePreview()" 
                                    :class="showPreview ? 'text-indigo-600' : 'text-gray-600'"
                                    class="hover:text-indigo-600" title="预览">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 内容编辑区 -->
                    <div class="flex-1 flex">
                        <!-- Markdown 编辑器 -->
                        <div :class="showPreview ? 'w-1/2' : 'w-full'" class="border-r">
                            <textarea x-model="selectedNote.content"
                                      @input="updateNote()"
                                      x-ref="noteTextarea"
                                      placeholder="在这里开始写你的学习笔记...

支持 Markdown 语法:
# 一级标题
## 二级标题
**粗体** *斜体*
- 列表项
```
代码块
```
[链接](URL)"
                                      class="w-full h-full p-4 border-none resize-none focus:outline-none font-mono text-sm leading-relaxed"></textarea>
                        </div>
                        
                        <!-- 预览区 -->
                        <div x-show="showPreview" class="w-1/2 p-4 bg-gray-50 overflow-y-auto">
                            <div class="prose prose-sm max-w-none" x-html="renderMarkdown(selectedNote.content)"></div>
                        </div>
                    </div>
                </div>

                <!-- 空状态 -->
                <div x-show="!selectedNote" class="flex-1 flex items-center justify-center">
                    <div class="text-center text-gray-500">
                        <i class="fas fa-sticky-note text-6xl mb-4 opacity-30"></i>
                        <h3 class="text-lg font-medium mb-2">选择一个笔记开始编辑</h3>
                        <p class="text-sm">或者创建一个新的学习笔记</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
[x-cloak] {
    display: none !important;
}

.prose h1, .prose h2, .prose h3 {
    color: #1f2937;
    font-weight: 600;
}

.prose pre {
    background: #f3f4f6;
    border-radius: 0.5rem;
    padding: 1rem;
}

.prose code {
    background: #f3f4f6;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
}
</style>