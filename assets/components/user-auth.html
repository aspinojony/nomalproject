<!-- 用户认证模态框组件 -->
<div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center" x-data="authModalController()">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
        <!-- 模态框头部 -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white" x-text="currentMode === 'login' ? '用户登录' : '用户注册'"></h2>
            <button @click="closeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <!-- 登录表单 -->
        <div x-show="currentMode === 'login'" class="p-6">
            <form @submit.prevent="handleLogin()">
                <div class="space-y-4">
                    <!-- 用户名/邮箱 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            用户名或邮箱
                        </label>
                        <input 
                            type="text" 
                            x-model="loginForm.identifier"
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                            placeholder="请输入用户名或邮箱"
                            required>
                    </div>

                    <!-- 密码 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            密码
                        </label>
                        <div class="relative">
                            <input 
                                :type="showPassword ? 'text' : 'password'"
                                x-model="loginForm.password"
                                class="w-full px-3 py-2 pr-10 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                                placeholder="请输入密码"
                                required>
                            <button 
                                type="button"
                                @click="showPassword = !showPassword"
                                class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600">
                                <span class="material-symbols-outlined" x-text="showPassword ? 'visibility_off' : 'visibility'"></span>
                            </button>
                        </div>
                    </div>

                    <!-- 记住我 -->
                    <div class="flex items-center justify-between">
                        <label class="flex items-center">
                            <input 
                                type="checkbox" 
                                x-model="loginForm.rememberMe"
                                class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-600 dark:text-gray-400">记住我</span>
                        </label>
                        <button type="button" class="text-sm text-blue-600 hover:text-blue-500 dark:text-blue-400">
                            忘记密码？
                        </button>
                    </div>

                    <!-- 登录按钮 -->
                    <button 
                        type="submit"
                        :disabled="loginLoading"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                        <span x-show="!loginLoading">登录</span>
                        <span x-show="loginLoading" class="flex items-center">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                            登录中...
                        </span>
                    </button>

                    <!-- 错误提示 -->
                    <div x-show="loginError" class="text-red-600 text-sm mt-2" x-text="loginError"></div>
                </div>
            </form>

            <!-- 切换到注册 -->
            <div class="mt-6 text-center">
                <span class="text-gray-600 dark:text-gray-400">还没有账户？</span>
                <button @click="switchMode('register')" class="text-blue-600 hover:text-blue-500 dark:text-blue-400 ml-1">
                    立即注册
                </button>
            </div>
        </div>

        <!-- 注册表单 -->
        <div x-show="currentMode === 'register'" class="p-6">
            <form @submit.prevent="handleRegister()">
                <div class="space-y-4">
                    <!-- 用户名 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            用户名
                        </label>
                        <input 
                            type="text" 
                            x-model="registerForm.username"
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                            placeholder="请输入用户名"
                            required>
                    </div>

                    <!-- 显示名称 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            显示名称
                        </label>
                        <input 
                            type="text" 
                            x-model="registerForm.displayName"
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                            placeholder="请输入显示名称">
                    </div>

                    <!-- 邮箱 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            邮箱地址
                        </label>
                        <input 
                            type="email" 
                            x-model="registerForm.email"
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                            placeholder="请输入邮箱地址"
                            required>
                    </div>

                    <!-- 密码 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            密码
                        </label>
                        <div class="relative">
                            <input 
                                :type="showPassword ? 'text' : 'password'"
                                x-model="registerForm.password"
                                class="w-full px-3 py-2 pr-10 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                                placeholder="请输入密码（至少6位）"
                                minlength="6"
                                required>
                            <button 
                                type="button"
                                @click="showPassword = !showPassword"
                                class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600">
                                <span class="material-symbols-outlined" x-text="showPassword ? 'visibility_off' : 'visibility'"></span>
                            </button>
                        </div>
                    </div>

                    <!-- 确认密码 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            确认密码
                        </label>
                        <input 
                            type="password"
                            x-model="registerForm.confirmPassword"
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                            placeholder="请再次输入密码"
                            required>
                    </div>

                    <!-- 服务条款 -->
                    <div class="flex items-start">
                        <input 
                            type="checkbox" 
                            x-model="registerForm.acceptTerms"
                            class="mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                            required>
                        <label class="ml-2 text-sm text-gray-600 dark:text-gray-400">
                            我已阅读并同意 
                            <a href="#" class="text-blue-600 hover:text-blue-500 dark:text-blue-400">服务条款</a> 
                            和 
                            <a href="#" class="text-blue-600 hover:text-blue-500 dark:text-blue-400">隐私政策</a>
                        </label>
                    </div>

                    <!-- 注册按钮 -->
                    <button 
                        type="submit"
                        :disabled="registerLoading"
                        class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                        <span x-show="!registerLoading">注册账户</span>
                        <span x-show="registerLoading" class="flex items-center">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                            注册中...
                        </span>
                    </button>

                    <!-- 错误提示 -->
                    <div x-show="registerError" class="text-red-600 text-sm mt-2" x-text="registerError"></div>
                </div>
            </form>

            <!-- 切换到登录 -->
            <div class="mt-6 text-center">
                <span class="text-gray-600 dark:text-gray-400">已有账户？</span>
                <button @click="switchMode('login')" class="text-blue-600 hover:text-blue-500 dark:text-blue-400 ml-1">
                    立即登录
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 用户菜单组件 -->
<div id="userMenu" class="relative" x-data="userMenuController()">
    <!-- 未登录状态 -->
    <div x-show="!isAuthenticated" class="flex items-center space-x-2">
        <button 
            @click="openLoginModal()" 
            class="px-4 py-2 text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 font-medium">
            登录
        </button>
        <button 
            @click="openRegisterModal()" 
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium">
            注册
        </button>
    </div>

    <!-- 已登录状态 -->
    <div x-show="isAuthenticated" class="relative">
        <button 
            @click="showDropdown = !showDropdown"
            class="flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
            <img 
                :src="getUserAvatar()" 
                :alt="user?.displayName || '用户头像'"
                class="w-8 h-8 rounded-full object-cover">
            <span class="text-gray-700 dark:text-gray-300 font-medium" x-text="user?.displayName || '用户'"></span>
            <span class="material-symbols-outlined text-gray-500 transform transition-transform" 
                  :class="showDropdown ? 'rotate-180' : ''">expand_more</span>
        </button>

        <!-- 下拉菜单 -->
        <div x-show="showDropdown" 
             @click.away="showDropdown = false"
             x-transition:enter="transition ease-out duration-100"
             x-transition:enter-start="transform opacity-0 scale-95"
             x-transition:enter-end="transform opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-75"
             x-transition:leave-start="transform opacity-100 scale-100"
             x-transition:leave-end="transform opacity-0 scale-95"
             class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 z-10">
            <div class="py-1">
                <!-- 用户信息 -->
                <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                    <p class="text-sm text-gray-900 dark:text-white font-medium" x-text="user?.displayName"></p>
                    <p class="text-sm text-gray-500 dark:text-gray-400" x-text="user?.email"></p>
                </div>

                <!-- 菜单项 -->
                <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <span class="material-symbols-outlined mr-3">person</span>
                    个人资料
                </a>
                <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <span class="material-symbols-outlined mr-3">settings</span>
                    账户设置
                </a>
                <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <span class="material-symbols-outlined mr-3">analytics</span>
                    学习统计
                </a>
                <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <span class="material-symbols-outlined mr-3">backup</span>
                    数据备份
                </a>
                
                <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                
                <button 
                    @click="handleLogout()"
                    class="flex items-center w-full px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <span class="material-symbols-outlined mr-3">logout</span>
                    退出登录
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// 认证模态框控制器
function authModalController() {
    return {
        currentMode: 'login', // 'login' 或 'register'
        showPassword: false,
        loginLoading: false,
        registerLoading: false,
        loginError: '',
        registerError: '',
        
        // 登录表单数据
        loginForm: {
            identifier: '',
            password: '',
            rememberMe: false
        },
        
        // 注册表单数据
        registerForm: {
            username: '',
            displayName: '',
            email: '',
            password: '',
            confirmPassword: '',
            acceptTerms: false
        },

        // 打开模态框
        openModal(mode = 'login') {
            this.currentMode = mode;
            this.clearErrors();
            document.getElementById('authModal').classList.remove('hidden');
            document.getElementById('authModal').classList.add('flex');
            document.body.style.overflow = 'hidden';
        },

        // 关闭模态框
        closeModal() {
            document.getElementById('authModal').classList.add('hidden');
            document.getElementById('authModal').classList.remove('flex');
            document.body.style.overflow = '';
            this.clearForms();
        },

        // 切换模式
        switchMode(mode) {
            this.currentMode = mode;
            this.clearErrors();
        },

        // 清除错误
        clearErrors() {
            this.loginError = '';
            this.registerError = '';
        },

        // 清除表单
        clearForms() {
            this.loginForm = {
                identifier: '',
                password: '',
                rememberMe: false
            };
            this.registerForm = {
                username: '',
                displayName: '',
                email: '',
                password: '',
                confirmPassword: '',
                acceptTerms: false
            };
            this.showPassword = false;
        },

        // 处理登录
        async handleLogin() {
            this.loginLoading = true;
            this.loginError = '';

            try {
                if (!window.authManager) {
                    throw new Error('认证系统未加载，请刷新页面重试');
                }

                const result = await window.authManager.login(
                    this.loginForm.identifier,
                    this.loginForm.password,
                    this.loginForm.rememberMe
                );

                if (result.success) {
                    this.closeModal();
                    // 触发页面更新
                    window.dispatchEvent(new CustomEvent('userLoggedIn', {
                        detail: { user: result.user }
                    }));
                    // 显示成功消息
                    this.showMessage('登录成功！欢迎回来！', 'success');
                } else {
                    this.loginError = result.message || '登录失败，请检查用户名和密码';
                }
            } catch (error) {
                console.error('登录错误:', error);
                this.loginError = error.message || '登录失败，请检查网络连接';
            } finally {
                this.loginLoading = false;
            }
        },

        // 处理注册
        async handleRegister() {
            this.registerLoading = true;
            this.registerError = '';

            try {
                // 验证密码匹配
                if (this.registerForm.password !== this.registerForm.confirmPassword) {
                    this.registerError = '两次输入的密码不匹配';
                    return;
                }

                if (!window.authManager) {
                    throw new Error('认证系统未加载，请刷新页面重试');
                }

                const result = await window.authManager.register({
                    username: this.registerForm.username,
                    email: this.registerForm.email,
                    password: this.registerForm.password,
                    displayName: this.registerForm.displayName || this.registerForm.username,
                    acceptTerms: this.registerForm.acceptTerms
                });

                if (result.success) {
                    this.closeModal();
                    // 触发页面更新
                    window.dispatchEvent(new CustomEvent('userRegistered', {
                        detail: { user: result.user }
                    }));
                    // 显示成功消息
                    this.showMessage('注册成功！欢迎加入我们！', 'success');
                } else {
                    this.registerError = result.message || '注册失败，请检查输入信息';
                    if (result.errors) {
                        this.registerError += '\n' + Object.values(result.errors).join('\n');
                    }
                }
            } catch (error) {
                console.error('注册错误:', error);
                this.registerError = error.message || '注册失败，请检查网络连接';
            } finally {
                this.registerLoading = false;
            }
        },

        // 显示消息
        showMessage(message, type = 'info') {
            // 这里可以集成您现有的消息提示系统
            console.log(`${type.toUpperCase()}: ${message}`);
            
            // 简单的消息提示实现
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-md shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
    };
}

// 用户菜单控制器
function userMenuController() {
    return {
        isAuthenticated: false,
        user: null,
        showDropdown: false,

        init() {
            this.checkAuthStatus();
            
            // 监听认证状态变化
            window.addEventListener('userLoggedIn', (event) => {
                this.isAuthenticated = true;
                this.user = event.detail.user;
            });

            window.addEventListener('userRegistered', (event) => {
                this.isAuthenticated = true;
                this.user = event.detail.user;
            });

            window.addEventListener('userLoggedOut', () => {
                this.isAuthenticated = false;
                this.user = null;
                this.showDropdown = false;
            });
        },

        // 检查认证状态
        checkAuthStatus() {
            if (window.authManager && window.authManager.isAuthenticated()) {
                this.isAuthenticated = true;
                this.user = window.authManager.getCurrentUser();
            }
        },

        // 打开登录模态框
        openLoginModal() {
            const authModal = document.querySelector('[x-data*="authModalController"]').__x.$data;
            authModal.openModal('login');
        },

        // 打开注册模态框
        openRegisterModal() {
            const authModal = document.querySelector('[x-data*="authModalController"]').__x.$data;
            authModal.openModal('register');
        },

        // 处理登出
        async handleLogout() {
            try {
                if (window.authManager) {
                    await window.authManager.logout();
                    
                    // 触发登出事件
                    window.dispatchEvent(new CustomEvent('userLoggedOut'));
                    
                    // 显示消息
                    this.showMessage('已成功退出登录', 'info');
                }
            } catch (error) {
                console.error('登出错误:', error);
                this.showMessage('登出失败: ' + error.message, 'error');
            }
        },

        // 显示消息（复用认证模态框的方法）
        showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-md shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
    };
}
</script>