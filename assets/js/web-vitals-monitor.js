/**
 * Web Vitals ÂíåÊÄßËÉΩÁõëÊéß
 * ÁõëÊéß Core Web Vitals ÊåáÊ†áÂíåËá™ÂÆö‰πâÊÄßËÉΩÊåáÊ†á
 */
class WebVitalsMonitor {
    constructor() {
        this.metrics = {};
        this.observers = [];
        this.reportEndpoint = '/api/analytics/performance'; // ÂèØÈÖçÁΩÆÁöÑ‰∏äÊä•Á´ØÁÇπ
        this.reportThreshold = 5; // ÊâπÈáè‰∏äÊä•ÈòàÂÄº
        this.pendingMetrics = [];
        
        this.init();
    }

    init() {
        this.setupCoreWebVitals();
        this.setupCustomMetrics();
        this.setupUserInteractionMetrics();
        this.startReporting();
        
        console.log('üìä ÊÄßËÉΩÁõëÊéßÁ≥ªÁªüÂ∑≤ÂêØÂä®');
    }

    /**
     * ËÆæÁΩÆ Core Web Vitals ÁõëÊéß
     */
    setupCoreWebVitals() {
        // Largest Contentful Paint (LCP)
        this.observeLCP();
        
        // First Input Delay (FID)
        this.observeFID();
        
        // Cumulative Layout Shift (CLS)
        this.observeCLS();
        
        // First Contentful Paint (FCP)
        this.observeFCP();
        
        // Time to First Byte (TTFB)
        this.observeTTFB();
    }

    /**
     * ËßÇÂØü Largest Contentful Paint
     */
    observeLCP() {
        if ('PerformanceObserver' in window) {
            const observer = new PerformanceObserver((list) => {
                const entries = list.getEntries();
                const lcpEntry = entries[entries.length - 1]; // ÊúÄÂêé‰∏Ä‰∏™Â∞±ÊòØLCP
                
                this.recordMetric('LCP', {
                    value: lcpEntry.startTime,
                    element: lcpEntry.element?.tagName || 'unknown',
                    url: lcpEntry.url || '',
                    timestamp: Date.now(),
                    rating: this.rateLCP(lcpEntry.startTime)
                });
            });
            
            observer.observe({ entryTypes: ['largest-contentful-paint'] });
            this.observers.push(observer);
        }
    }

    /**
     * ËßÇÂØü First Input Delay
     */
    observeFID() {
        if ('PerformanceObserver' in window) {
            const observer = new PerformanceObserver((list) => {
                const entries = list.getEntries();
                entries.forEach(entry => {
                    this.recordMetric('FID', {
                        value: entry.processingStart - entry.startTime,
                        eventType: entry.name,
                        timestamp: Date.now(),
                        rating: this.rateFID(entry.processingStart - entry.startTime)
                    });
                });
            });
            
            observer.observe({ entryTypes: ['first-input'] });
            this.observers.push(observer);
        }
    }

    /**
     * ËßÇÂØü Cumulative Layout Shift
     */
    observeCLS() {
        if ('PerformanceObserver' in window) {
            let clsValue = 0;
            let sessionValue = 0;
            let sessionEntries = [];
            
            const observer = new PerformanceObserver((list) => {
                const entries = list.getEntries();
                
                for (const entry of entries) {
                    // Âè™ËÆ°ÁÆóÊ≤°ÊúâÁî®Êà∑ËæìÂÖ•ÁöÑÂ∏ÉÂ±ÄÂÅèÁßª
                    if (!entry.hadRecentInput) {
                        const firstSessionEntry = sessionEntries[0];
                        const lastSessionEntry = sessionEntries[sessionEntries.length - 1];
                        
                        // Â¶ÇÊûúÊù°ÁõÆ‰∏é‰ºöËØù‰∏≠ÁöÑÁ¨¨‰∏Ä‰∏™Êù°ÁõÆÁõ∏ÈöîË∂ÖËøá 1 ÁßíÔºåÊàñËÄÖ
                        // ‰∏é‰ºöËØù‰∏≠ÁöÑÊúÄÂêé‰∏Ä‰∏™Êù°ÁõÆÁõ∏ÈöîË∂ÖËøá 5 ÁßíÔºåÂºÄÂßãÊñ∞‰ºöËØù
                        if (sessionValue && 
                            (entry.startTime - lastSessionEntry.startTime > 5000 ||
                             entry.startTime - firstSessionEntry.startTime > 1000)) {
                            
                            this.recordMetric('CLS', {
                                value: sessionValue,
                                entries: sessionEntries.length,
                                timestamp: Date.now(),
                                rating: this.rateCLS(sessionValue)
                            });
                            
                            sessionValue = 0;
                            sessionEntries = [];
                        }
                        
                        sessionValue += entry.value;
                        sessionEntries.push(entry);
                    }
                }
            });
            
            observer.observe({ entryTypes: ['layout-shift'] });
            this.observers.push(observer);
        }
    }

    /**
     * ËßÇÂØü First Contentful Paint
     */
    observeFCP() {
        if ('PerformanceObserver' in window) {
            const observer = new PerformanceObserver((list) => {
                const entries = list.getEntries();
                entries.forEach(entry => {
                    if (entry.name === 'first-contentful-paint') {
                        this.recordMetric('FCP', {
                            value: entry.startTime,
                            timestamp: Date.now(),
                            rating: this.rateFCP(entry.startTime)
                        });
                    }
                });
            });
            
            observer.observe({ entryTypes: ['paint'] });
            this.observers.push(observer);
        }
    }

    /**
     * ËßÇÂØü Time to First Byte
     */
    observeTTFB() {
        // ‰ΩøÁî® Navigation Timing API
        window.addEventListener('load', () => {
            if ('performance' in window && 'timing' in window.performance) {
                const timing = window.performance.timing;
                const ttfb = timing.responseStart - timing.navigationStart;
                
                this.recordMetric('TTFB', {
                    value: ttfb,
                    timestamp: Date.now(),
                    rating: this.rateTTFB(ttfb)
                });
            }
        });
    }

    /**
     * ËÆæÁΩÆËá™ÂÆö‰πâÊÄßËÉΩÊåáÊ†á
     */
    setupCustomMetrics() {
        // È¶ñÂ±èÊ∏≤ÊüìÊó∂Èó¥
        this.measureFirstScreenRender();
        
        // ÂÖ≥ÈîÆËµÑÊ∫êÂä†ËΩΩÊó∂Èó¥
        this.measureCriticalResourceTiming();
        
        // JavaScript ÊâßË°åÊó∂Èó¥
        this.measureJavaScriptTiming();
        
        // ÂÜÖÂ≠ò‰ΩøÁî®ÊÉÖÂÜµ
        this.measureMemoryUsage();
    }

    /**
     * ÊµãÈáèÈ¶ñÂ±èÊ∏≤ÊüìÊó∂Èó¥
     */
    measureFirstScreenRender() {
        const startTime = window.PERFORMANCE_START || performance.now();
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && entry.target.classList.contains('above-fold')) {
                    const renderTime = performance.now() - startTime;
                    
                    this.recordMetric('FirstScreenRender', {
                        value: renderTime,
                        element: entry.target.tagName,
                        timestamp: Date.now()
                    });
                    
                    observer.unobserve(entry.target);
                }
            });
        });

        // ËßÇÂØüÈ¶ñÂ±èÂÜÖÂÆπ
        document.querySelectorAll('.above-fold').forEach(el => {
            observer.observe(el);
        });
    }

    /**
     * ÊµãÈáèÂÖ≥ÈîÆËµÑÊ∫êÂä†ËΩΩÊó∂Èó¥
     */
    measureCriticalResourceTiming() {
        if ('PerformanceObserver' in window) {
            const observer = new PerformanceObserver((list) => {
                const entries = list.getEntries();
                entries.forEach(entry => {
                    // Âè™ÂÖ≥Ê≥®ÂÖ≥ÈîÆËµÑÊ∫ê
                    if (this.isCriticalResource(entry.name)) {
                        this.recordMetric('ResourceTiming', {
                            name: entry.name,
                            duration: entry.duration,
                            transferSize: entry.transferSize || 0,
                            timestamp: Date.now(),
                            type: this.getResourceType(entry.name)
                        });
                    }
                });
            });
            
            observer.observe({ entryTypes: ['resource'] });
            this.observers.push(observer);
        }
    }

    /**
     * ÊµãÈáè JavaScript ÊâßË°åÊó∂Èó¥
     */
    measureJavaScriptTiming() {
        if ('PerformanceObserver' in window) {
            const observer = new PerformanceObserver((list) => {
                const entries = list.getEntries();
                entries.forEach(entry => {
                    if (entry.duration > 50) { // Âè™ËÆ∞ÂΩïËÄóÊó∂Ë∂ÖËøá50msÁöÑ‰ªªÂä°
                        this.recordMetric('LongTask', {
                            duration: entry.duration,
                            startTime: entry.startTime,
                            timestamp: Date.now()
                        });
                    }
                });
            });
            
            observer.observe({ entryTypes: ['longtask'] });
            this.observers.push(observer);
        }
    }

    /**
     * ÊµãÈáèÂÜÖÂ≠ò‰ΩøÁî®ÊÉÖÂÜµ
     */
    measureMemoryUsage() {
        if ('memory' in performance) {
            setInterval(() => {
                const memory = performance.memory;
                this.recordMetric('MemoryUsage', {
                    usedJSHeapSize: memory.usedJSHeapSize,
                    totalJSHeapSize: memory.totalJSHeapSize,
                    jsHeapSizeLimit: memory.jsHeapSizeLimit,
                    timestamp: Date.now()
                });
            }, 30000); // ÊØè30ÁßíËÆ∞ÂΩï‰∏ÄÊ¨°
        }
    }

    /**
     * ËÆæÁΩÆÁî®Êà∑‰∫§‰∫íÊåáÊ†á
     */
    setupUserInteractionMetrics() {
        // ÁÇπÂáªÂìçÂ∫îÊó∂Èó¥
        this.measureClickResponseTime();
        
        // È°µÈù¢ÂÅúÁïôÊó∂Èó¥
        this.measurePageEngagement();
        
        // ÊªöÂä®ÊÄßËÉΩ
        this.measureScrollPerformance();
    }

    /**
     * ÊµãÈáèÁÇπÂáªÂìçÂ∫îÊó∂Èó¥
     */
    measureClickResponseTime() {
        let clickStartTime = 0;
        
        document.addEventListener('mousedown', () => {
            clickStartTime = performance.now();
        });
        
        document.addEventListener('click', () => {
            if (clickStartTime) {
                const responseTime = performance.now() - clickStartTime;
                this.recordMetric('ClickResponse', {
                    value: responseTime,
                    timestamp: Date.now()
                });
                clickStartTime = 0;
            }
        });
    }

    /**
     * ÊµãÈáèÈ°µÈù¢ÂÅúÁïôÊó∂Èó¥
     */
    measurePageEngagement() {
        const startTime = Date.now();
        let lastActiveTime = startTime;
        
        const updateActiveTime = () => {
            lastActiveTime = Date.now();
        };
        
        ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, updateActiveTime);
        });
        
        window.addEventListener('beforeunload', () => {
            const engagementTime = lastActiveTime - startTime;
            this.recordMetric('PageEngagement', {
                value: engagementTime,
                totalTime: Date.now() - startTime,
                timestamp: Date.now()
            });
        });
    }

    /**
     * ÊµãÈáèÊªöÂä®ÊÄßËÉΩ
     */
    measureScrollPerformance() {
        let scrollStartTime = 0;
        let frameCount = 0;
        
        const measureScrollFrame = () => {
            frameCount++;
            requestAnimationFrame(measureScrollFrame);
        };
        
        document.addEventListener('scroll', () => {
            if (!scrollStartTime) {
                scrollStartTime = performance.now();
                frameCount = 0;
                measureScrollFrame();
                
                setTimeout(() => {
                    if (scrollStartTime) {
                        const duration = performance.now() - scrollStartTime;
                        const fps = frameCount / (duration / 1000);
                        
                        this.recordMetric('ScrollPerformance', {
                            fps: fps,
                            duration: duration,
                            frames: frameCount,
                            timestamp: Date.now()
                        });
                        
                        scrollStartTime = 0;
                    }
                }, 1000);
            }
        });
    }

    /**
     * ËÆ∞ÂΩïÊåáÊ†á
     */
    recordMetric(name, data) {
        this.metrics[name] = data;
        this.pendingMetrics.push({
            name,
            data,
            timestamp: Date.now()
        });
        
        console.log(`üìà ÊÄßËÉΩÊåáÊ†á ${name}:`, data);
        
        // Ëß¶ÂèëËá™ÂÆö‰πâ‰∫ã‰ª∂
        window.dispatchEvent(new CustomEvent('performanceMetric', {
            detail: { name, data }
        }));
    }

    /**
     * ËØÑÁ∫ßÂáΩÊï∞
     */
    rateLCP(value) {
        if (value <= 2500) return 'good';
        if (value <= 4000) return 'needs-improvement';
        return 'poor';
    }

    rateFID(value) {
        if (value <= 100) return 'good';
        if (value <= 300) return 'needs-improvement';
        return 'poor';
    }

    rateCLS(value) {
        if (value <= 0.1) return 'good';
        if (value <= 0.25) return 'needs-improvement';
        return 'poor';
    }

    rateFCP(value) {
        if (value <= 1800) return 'good';
        if (value <= 3000) return 'needs-improvement';
        return 'poor';
    }

    rateTTFB(value) {
        if (value <= 800) return 'good';
        if (value <= 1800) return 'needs-improvement';
        return 'poor';
    }

    /**
     * Â∑•ÂÖ∑ÂáΩÊï∞
     */
    isCriticalResource(url) {
        const criticalPatterns = [
            '/assets/css/critical.css',
            '/assets/js/performance-loader.js',
            '/assets/js/theme-manager.js',
            '/assets/css/theme-manager.css'
        ];
        
        return criticalPatterns.some(pattern => url.includes(pattern));
    }

    getResourceType(url) {
        if (url.endsWith('.css')) return 'stylesheet';
        if (url.endsWith('.js')) return 'script';
        if (url.match(/\.(jpg|jpeg|png|gif|webp|avif|svg)$/)) return 'image';
        return 'other';
    }

    /**
     * ÂºÄÂßãÊÄßËÉΩÊï∞ÊçÆ‰∏äÊä•
     */
    startReporting() {
        // È°µÈù¢Âç∏ËΩΩÊó∂‰∏äÊä•ÊâÄÊúâÊï∞ÊçÆ
        window.addEventListener('beforeunload', () => {
            this.sendMetrics(true);
        });
        
        // ÂÆöÊúü‰∏äÊä•Êï∞ÊçÆ
        setInterval(() => {
            if (this.pendingMetrics.length >= this.reportThreshold) {
                this.sendMetrics();
            }
        }, 10000); // ÊØè10ÁßíÊ£ÄÊü•‰∏ÄÊ¨°
    }

    /**
     * ÂèëÈÄÅÊÄßËÉΩÊï∞ÊçÆ
     */
    async sendMetrics(isBeacon = false) {
        if (this.pendingMetrics.length === 0) return;
        
        const metricsToSend = [...this.pendingMetrics];
        this.pendingMetrics = [];
        
        const payload = {
            url: window.location.href,
            userAgent: navigator.userAgent,
            timestamp: Date.now(),
            metrics: metricsToSend,
            sessionId: this.getSessionId(),
            userId: this.getUserId()
        };
        
        try {
            if (isBeacon && navigator.sendBeacon) {
                // ‰ΩøÁî® sendBeacon Á°Æ‰øùÂú®È°µÈù¢Âç∏ËΩΩÊó∂‰πüËÉΩÂèëÈÄÅÊï∞ÊçÆ
                navigator.sendBeacon(this.reportEndpoint, JSON.stringify(payload));
            } else {
                // ÊôÆÈÄöÁöÑ fetch ËØ∑Ê±Ç
                await fetch(this.reportEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
            }
            
            console.log('üì§ ÊÄßËÉΩÊï∞ÊçÆÂ∑≤‰∏äÊä•:', metricsToSend.length, 'Êù°ÊåáÊ†á');
            
        } catch (error) {
            console.warn('‚ùå ÊÄßËÉΩÊï∞ÊçÆ‰∏äÊä•Â§±Ë¥•:', error);
            // Â§±Ë¥•Êó∂ÈáçÊñ∞Âä†ÂÖ•ÈòüÂàó
            this.pendingMetrics.unshift(...metricsToSend);
        }
    }

    /**
     * Ëé∑Âèñ‰ºöËØùID
     */
    getSessionId() {
        let sessionId = sessionStorage.getItem('performanceSessionId');
        if (!sessionId) {
            sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('performanceSessionId', sessionId);
        }
        return sessionId;
    }

    /**
     * Ëé∑ÂèñÁî®Êà∑ID
     */
    getUserId() {
        // ‰ªéËÆ§ËØÅÁ≥ªÁªüËé∑ÂèñÁî®Êà∑IDÔºåÊàñ‰ΩøÁî®ÂåøÂêçID
        const user = JSON.parse(localStorage.getItem('auth_user') || 'null');
        return user?.id || 'anonymous_' + this.getSessionId();
    }

    /**
     * Ëé∑ÂèñÊÄßËÉΩÊëòË¶Å
     */
    getPerformanceSummary() {
        return {
            coreWebVitals: {
                LCP: this.metrics.LCP,
                FID: this.metrics.FID,
                CLS: this.metrics.CLS,
                FCP: this.metrics.FCP,
                TTFB: this.metrics.TTFB
            },
            customMetrics: {
                FirstScreenRender: this.metrics.FirstScreenRender,
                MemoryUsage: this.metrics.MemoryUsage,
                PageEngagement: this.metrics.PageEngagement
            },
            recommendations: this.getPerformanceRecommendations()
        };
    }

    /**
     * Ëé∑ÂèñÊÄßËÉΩÂª∫ËÆÆ
     */
    getPerformanceRecommendations() {
        const recommendations = [];
        
        if (this.metrics.LCP?.value > 2500) {
            recommendations.push('LCPËøáÊÖ¢ÔºåÂª∫ËÆÆ‰ºòÂåñÈ¶ñÂ±èÂÜÖÂÆπÂä†ËΩΩ');
        }
        
        if (this.metrics.FID?.value > 100) {
            recommendations.push('FIDËøáÈ´òÔºåÂª∫ËÆÆÂáèÂ∞ëJavaScriptÊâßË°åÊó∂Èó¥');
        }
        
        if (this.metrics.CLS?.value > 0.1) {
            recommendations.push('CLSËøáÈ´òÔºåÂª∫ËÆÆÂáèÂ∞ëÂ∏ÉÂ±ÄÂÅèÁßª');
        }
        
        return recommendations;
    }

    /**
     * Ê∏ÖÁêÜËµÑÊ∫ê
     */
    destroy() {
        this.observers.forEach(observer => observer.disconnect());
        this.observers = [];
        
        // ÂèëÈÄÅÂâ©‰ΩôÊï∞ÊçÆ
        if (this.pendingMetrics.length > 0) {
            this.sendMetrics(true);
        }
    }
}

// ÂÖ®Â±ÄÂÆû‰æã
if (typeof window !== 'undefined') {
    window.webVitalsMonitor = new WebVitalsMonitor();
}

// ÂØºÂá∫
if (typeof module !== 'undefined' && module.exports) {
    module.exports = WebVitalsMonitor;
}