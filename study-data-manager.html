<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ä¹ è®°å½•ç®¡ç† - è®¡ç®—æœºè€ƒç ”å­¦ä¹ å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- å¤´éƒ¨ -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-database text-blue-500 mr-3"></i>
                        å­¦ä¹ è®°å½•ç®¡ç†
                    </h1>
                    <p class="text-gray-600 mt-2">å¯¼å…¥å¯¼å‡ºå­¦ä¹ æ•°æ®ï¼Œæ–¹ä¾¿åœ¨ä¸åŒè®¾å¤‡é—´åŒæ­¥å­¦ä¹ è®°å½•</p>
                </div>
                <a href="index.html" class="text-blue-500 hover:text-blue-600 flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i>
                    è¿”å›é¦–é¡µ
                </a>
            </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-6">
            <!-- å·¦ä¾§ï¼šæ•°æ®æ¦‚è§ˆ -->
            <div class="space-y-6">
                <!-- æ•°æ®æ¦‚è§ˆå¡ç‰‡ -->
                <div class="bg-white rounded-xl shadow-sm p-6" x-data="dataOverview">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-chart-pie text-green-500 mr-3"></i>
                        æ•°æ®æ¦‚è§ˆ
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600" x-text="formatTime(totalStudyTime)"></div>
                                <div class="text-sm text-blue-500">æ€»å­¦ä¹ æ—¶é•¿</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <div class="text-2xl font-bold text-green-600" x-text="totalSessions"></div>
                                <div class="text-sm text-green-500">å­¦ä¹ ä¼šè¯</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <div class="text-2xl font-bold text-purple-600" x-text="totalQuestions"></div>
                                <div class="text-sm text-purple-500">ç­”é¢˜æ€»æ•°</div>
                            </div>
                            <div class="bg-orange-50 p-4 rounded-lg">
                                <div class="text-2xl font-bold text-orange-600" x-text="dailyStatsCount + 'å¤©'"></div>
                                <div class="text-sm text-orange-500">å­¦ä¹ å¤©æ•°</div>
                            </div>
                        </div>

                        <!-- ç« èŠ‚è¿›åº¦ç»Ÿè®¡ -->
                        <div class="border-t pt-4">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                <i class="fas fa-list-check text-indigo-500 mr-2"></i>
                                ç« èŠ‚è¿›åº¦ç»Ÿè®¡
                            </h3>
                            
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="bg-indigo-50 p-4 rounded-lg">
                                    <div class="text-2xl font-bold text-indigo-600" x-text="completedChapters + '/' + totalChapters"></div>
                                    <div class="text-sm text-indigo-500">ç« èŠ‚å®Œæˆåº¦</div>
                                </div>
                                <div class="bg-teal-50 p-4 rounded-lg">
                                    <div class="text-2xl font-bold text-teal-600" x-text="Math.round(completionPercentage) + '%'"></div>
                                    <div class="text-sm text-teal-500">å®Œæˆç™¾åˆ†æ¯”</div>
                                </div>
                            </div>

                            <!-- è¿›åº¦æ¡ -->
                            <div class="mb-4">
                                <div class="flex items-center justify-between text-sm text-gray-600 mb-2">
                                    <span>æ€»ä½“è¿›åº¦</span>
                                    <span x-text="completedChapters + '/' + totalChapters + 'ç« èŠ‚'"></span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 h-3 rounded-full transition-all duration-500"
                                         :style="`width: ${completionPercentage}%`"></div>
                                </div>
                            </div>

                            <!-- è¯¾ç¨‹è¿›åº¦è¯¦æƒ… -->
                            <div class="space-y-2" x-show="courseProgressDetails.length > 0">
                                <template x-for="course in courseProgressDetails" :key="course.courseId">
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="text-gray-700" x-text="course.courseName"></span>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-gray-500" x-text="course.completedCount + '/' + course.totalChapters"></span>
                                            <div class="w-20 bg-gray-200 rounded-full h-2">
                                                <div class="bg-blue-500 h-2 rounded-full transition-all duration-300"
                                                     :style="`width: ${course.completionRate}%`"></div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center text-sm text-gray-600">
                                <span>æ•°æ®å®Œæ•´æ€§:</span>
                                <span class="font-mono" x-text="dataIntegrity"></span>
                            </div>
                            <div class="flex justify-between items-center text-sm text-gray-600 mt-1">
                                <span>æœ€åæ›´æ–°:</span>
                                <span x-text="formatDate(lastUpdated)"></span>
                            </div>
                            <div class="flex justify-between items-center text-sm text-gray-600 mt-1">
                                <span>å­˜å‚¨å¤§å°:</span>
                                <span x-text="formatSize(storageSize)"></span>
                            </div>
                        </div>
                        
                        <!-- åˆ·æ–°æŒ‰é’® -->
                        <button @click="refreshData" 
                                class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors flex items-center justify-center">
                            <i class="fas fa-sync-alt mr-2" :class="{ 'fa-spin': refreshing }"></i>
                            åˆ·æ–°æ•°æ®
                        </button>
                    </div>
                </div>

                <!-- æ•°æ®å¤‡ä»½çŠ¶æ€ -->
                <div class="bg-white rounded-xl shadow-sm p-6" x-data="backupStatus">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-shield-alt text-yellow-500 mr-3"></i>
                        å¤‡ä»½çŠ¶æ€
                    </h2>
                    
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">æœ¬åœ°å¤‡ä»½:</span>
                            <span class="flex items-center" :class="hasBackup ? 'text-green-600' : 'text-gray-400'">
                                <i :class="hasBackup ? 'fas fa-check-circle' : 'fas fa-times-circle'" class="mr-2"></i>
                                <span x-text="hasBackup ? 'å·²å¤‡ä»½' : 'æ— å¤‡ä»½'"></span>
                            </span>
                        </div>
                        
                        <template x-if="hasBackup">
                            <div class="bg-yellow-50 p-3 rounded-lg">
                                <div class="text-sm text-yellow-800 mb-2">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    æ£€æµ‹åˆ°å¯¼å…¥å‰å¤‡ä»½æ•°æ®
                                </div>
                                <button @click="restoreBackup"
                                        :disabled="restoring"
                                        class="bg-yellow-500 hover:bg-yellow-600 disabled:bg-yellow-300 text-white px-4 py-2 rounded-lg text-sm transition-colors flex items-center">
                                    <i class="fas fa-undo mr-2" :class="{ 'fa-spin': restoring }"></i>
                                    æ¢å¤å¤‡ä»½æ•°æ®
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šå¯¼å…¥å¯¼å‡ºæ“ä½œ -->
            <div class="space-y-6">
                <!-- å¯¼å‡ºæ•°æ® -->
                <div class="bg-white rounded-xl shadow-sm p-6" x-data="exportData">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-download text-blue-500 mr-3"></i>
                        å¯¼å‡ºå­¦ä¹ è®°å½•
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©å¯¼å‡ºæ ¼å¼</label>
                            <div class="grid grid-cols-2 gap-3">
                                <button @click="selectedFormat = 'json'"
                                        :class="selectedFormat === 'json' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                        class="p-3 rounded-lg transition-colors flex items-center justify-center">
                                    <i class="fab fa-js-square mr-2"></i>
                                    JSONæ ¼å¼
                                </button>
                                <button @click="selectedFormat = 'csv'"
                                        :class="selectedFormat === 'csv' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                        class="p-3 rounded-lg transition-colors flex items-center justify-center">
                                    <i class="fas fa-table mr-2"></i>
                                    CSVæ ¼å¼
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-medium text-gray-900 mb-2">æ ¼å¼è¯´æ˜</h4>
                            <div class="text-sm text-gray-600 space-y-1">
                                <template x-if="selectedFormat === 'json'">
                                    <div>
                                        <p>â€¢ å®Œæ•´ä¿å­˜æ‰€æœ‰å­¦ä¹ æ•°æ®å’Œé…ç½®</p>
                                        <p>â€¢ åŒ…å«ç« èŠ‚å®Œæˆåº¦å’Œè§‚çœ‹è¿›åº¦</p>
                                        <p>â€¢ æ”¯æŒå®Œæ•´å¯¼å…¥æ¢å¤</p>
                                        <p>â€¢ æ¨èç”¨äºè®¾å¤‡é—´è¿ç§»</p>
                                    </div>
                                </template>
                                <template x-if="selectedFormat === 'csv'">
                                    <div>
                                        <p>â€¢ è¡¨æ ¼æ ¼å¼ï¼Œæ˜“äºæŸ¥çœ‹å’Œåˆ†æ</p>
                                        <p>â€¢ åŒ…å«æ¯æ—¥ç»Ÿè®¡ã€ç§‘ç›®ç»Ÿè®¡ã€ç« èŠ‚è¿›åº¦</p>
                                        <p>â€¢ å¯ç”¨Excelç­‰è½¯ä»¶æ‰“å¼€</p>
                                        <p>â€¢ æ¨èç”¨äºæ•°æ®åˆ†æ</p>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <button @click="exportData"
                                :disabled="exporting"
                                class="w-full bg-blue-500 hover:bg-blue-600 disabled:bg-blue-300 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center justify-center">
                            <i class="fas fa-download mr-2" :class="{ 'fa-spin': exporting }"></i>
                            <span x-text="exporting ? 'å¯¼å‡ºä¸­...' : `å¯¼å‡º${selectedFormat.toUpperCase()}æ–‡ä»¶`"></span>
                        </button>
                    </div>
                </div>

                <!-- å¯¼å…¥æ•°æ® -->
                <div class="bg-white rounded-xl shadow-sm p-6" x-data="importData">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-upload text-green-500 mr-3"></i>
                        å¯¼å…¥å­¦ä¹ è®°å½•
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©JSONæ–‡ä»¶</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors"
                                 @click="$refs.fileInput.click()"
                                 @dragover.prevent
                                 @drop.prevent="handleDrop">
                                <input type="file" 
                                       x-ref="fileInput" 
                                       @change="handleFileSelect"
                                       accept=".json"
                                       class="hidden">
                                <div class="space-y-2">
                                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400"></i>
                                    <div class="text-gray-600">
                                        <p class="font-medium">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</p>
                                        <p class="text-sm">æ”¯æŒ .json æ ¼å¼</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <template x-if="selectedFile">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <i class="fas fa-file-code text-blue-500 mr-3"></i>
                                        <div>
                                            <div class="font-medium text-blue-900" x-text="selectedFile.name"></div>
                                            <div class="text-sm text-blue-600" x-text="formatFileSize(selectedFile.size)"></div>
                                        </div>
                                    </div>
                                    <button @click="clearFile" class="text-blue-500 hover:text-blue-700">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </template>
                        
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <div class="flex items-start">
                                <i class="fas fa-exclamation-triangle text-yellow-500 mr-3 mt-0.5"></i>
                                <div class="text-sm text-yellow-800">
                                    <p class="font-medium mb-1">å¯¼å…¥æ³¨æ„äº‹é¡¹</p>
                                    <ul class="space-y-1 text-xs">
                                        <li>â€¢ å¯¼å…¥å‰ä¼šè‡ªåŠ¨å¤‡ä»½å½“å‰æ•°æ®å’Œç« èŠ‚è¿›åº¦</li>
                                        <li>â€¢ æ”¯æŒåˆå¹¶å¯¼å…¥å’Œæ›¿æ¢å¯¼å…¥</li>
                                        <li>â€¢ ç« èŠ‚è¿›åº¦å°†æ™ºèƒ½åˆå¹¶æˆ–æ›¿æ¢</li>
                                        <li>â€¢ å¦‚å‡ºç°é—®é¢˜å¯æ¢å¤å¤‡ä»½</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <button @click="importData"
                                :disabled="!selectedFile || importing"
                                class="w-full bg-green-500 hover:bg-green-600 disabled:bg-gray-300 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center justify-center">
                            <i class="fas fa-upload mr-2" :class="{ 'fa-spin': importing }"></i>
                            <span x-text="importing ? 'å¯¼å…¥ä¸­...' : 'å¯¼å…¥å­¦ä¹ è®°å½•'"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ“ä½œç»“æœæç¤º -->
        <div x-data="notification" 
             x-show="show" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-y-2"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 transform translate-y-0"
             x-transition:leave-end="opacity-0 transform translate-y-2"
             class="fixed bottom-4 right-4 max-w-sm bg-white rounded-lg shadow-lg border p-4 z-50">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <i :class="icon" class="text-xl"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900" x-text="title"></p>
                    <p class="text-sm text-gray-600 mt-1" x-text="message"></p>
                </div>
                <button @click="hide" class="ml-4 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦JSæ–‡ä»¶ -->
    <script src="assets/js/stats-manager.js"></script>
    
    <!-- é¡µé¢é€»è¾‘ -->
    <script>
        // å…¨å±€é€šçŸ¥ç»„ä»¶
        document.addEventListener('alpine:init', () => {
            Alpine.data('notification', () => ({
                show: false,
                title: '',
                message: '',
                icon: '',
                
                showSuccess(title, message) {
                    this.show = true;
                    this.title = title;
                    this.message = message;
                    this.icon = 'fas fa-check-circle text-green-500';
                    setTimeout(() => this.hide(), 5000);
                },
                
                showError(title, message) {
                    this.show = true;
                    this.title = title;
                    this.message = message;
                    this.icon = 'fas fa-times-circle text-red-500';
                    setTimeout(() => this.hide(), 5000);
                },
                
                showInfo(title, message) {
                    this.show = true;
                    this.title = title;
                    this.message = message;
                    this.icon = 'fas fa-info-circle text-blue-500';
                    setTimeout(() => this.hide(), 5000);
                },
                
                hide() {
                    this.show = false;
                }
            }));

            // æ•°æ®æ¦‚è§ˆç»„ä»¶
            Alpine.data('dataOverview', () => ({
                totalStudyTime: 0,
                totalSessions: 0,
                totalQuestions: 0,
                dailyStatsCount: 0,
                storageSize: 0,
                lastUpdated: '',
                dataIntegrity: '',
                refreshing: false,
                // ç« èŠ‚è¿›åº¦ç›¸å…³
                totalChapters: 0,
                completedChapters: 0,
                completionPercentage: 0,
                courseProgressDetails: [],

                init() {
                    this.refreshData();
                },

                async refreshData() {
                    this.refreshing = true;
                    try {
                        // è·å–åŸºç¡€ç»Ÿè®¡ä¿¡æ¯
                        const info = window.studyStats.getStorageInfo();
                        this.totalStudyTime = info.totalStudyTime || 0;
                        this.totalSessions = info.totalSessions || 0;
                        this.totalQuestions = window.studyStats.stats.totalQuestionsAnswered || 0;
                        this.dailyStatsCount = info.dailyStatsCount || 0;
                        this.storageSize = info.storageSize || 0;
                        this.lastUpdated = info.lastUpdated || '';
                        this.dataIntegrity = info.dataIntegrity || 'unknown';

                        // è·å–ç« èŠ‚è¿›åº¦ä¿¡æ¯ï¼ˆä½¿ç”¨æ–°çš„å…¼å®¹æ–¹æ³•ï¼‰
                        await this.loadChapterProgress();
                        
                        console.log('ğŸ“Š æ•°æ®æ¦‚è§ˆåˆ·æ–°å®Œæˆ:', {
                            totalChapters: this.totalChapters,
                            completedChapters: this.completedChapters,
                            completionPercentage: this.completionPercentage,
                            courseCount: this.courseProgressDetails.length
                        });
                    } catch (error) {
                        console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
                        // æ˜¾ç¤ºé”™è¯¯ä½†ä¸é˜»æ­¢ç•Œé¢
                        this.totalChapters = 0;
                        this.completedChapters = 0;
                        this.completionPercentage = 0;
                        this.courseProgressDetails = [];
                    } finally {
                        this.refreshing = false;
                    }
                },

                async loadChapterProgress() {
                    try {
                        console.log('ğŸ”„ å¼€å§‹åŠ è½½ç« èŠ‚è¿›åº¦æ•°æ®...');
                        
                        // æ£€æŸ¥StudyStatsManageræ˜¯å¦å­˜åœ¨
                        if (!window.studyStats || typeof window.studyStats.getAllChapterProgress !== 'function') {
                            console.error('âŒ StudyStatsManageræœªæ­£ç¡®åˆå§‹åŒ–');
                            this.setDefaultChapterData();
                            return;
                        }
                        
                        // ä½¿ç”¨æ›´æ–°åçš„getAllChapterProgressæ–¹æ³•
                        const chapterProgress = await window.studyStats.getAllChapterProgress();
                        
                        console.log('ğŸ“¥ è·å–åˆ°ç« èŠ‚è¿›åº¦æ•°æ®:', chapterProgress);
                        
                        // éªŒè¯æ•°æ®ç»“æ„
                        if (!chapterProgress || typeof chapterProgress !== 'object') {
                            console.error('âŒ ç« èŠ‚è¿›åº¦æ•°æ®æ ¼å¼æ— æ•ˆ:', chapterProgress);
                            this.setDefaultChapterData();
                            return;
                        }
                        
                        this.totalChapters = chapterProgress.totalChapters || 0;
                        this.completedChapters = chapterProgress.completedChapters || 0;
                        this.completionPercentage = this.totalChapters > 0 ? 
                            (this.completedChapters / this.totalChapters) * 100 : 0;

                        // æ„å»ºè¯¾ç¨‹è¿›åº¦è¯¦æƒ…
                        this.courseProgressDetails = [];
                        
                        if (chapterProgress.courseProgress && typeof chapterProgress.courseProgress === 'object') {
                            Object.values(chapterProgress.courseProgress).forEach(course => {
                                if (!course || typeof course !== 'object') {
                                    console.warn('âš ï¸ æ— æ•ˆçš„è¯¾ç¨‹æ•°æ®:', course);
                                    return;
                                }
                                
                                const totalChapters = course.chapters ? course.chapters.length : 0;
                                const completedCount = course.completedCount || 0;
                                const completionRate = totalChapters > 0 ? (completedCount / totalChapters) * 100 : 0;

                                this.courseProgressDetails.push({
                                    courseId: course.courseId || 'unknown',
                                    courseName: course.courseName || 'æœªçŸ¥è¯¾ç¨‹',
                                    totalChapters: totalChapters,
                                    completedCount: completedCount,
                                    completionRate: Math.round(completionRate)
                                });
                            });

                            // æŒ‰å®Œæˆç‡æ’åº
                            this.courseProgressDetails.sort((a, b) => b.completionRate - a.completionRate);
                        }

                        console.log('âœ… ç« èŠ‚è¿›åº¦åŠ è½½å®Œæˆ:', {
                            totalChapters: this.totalChapters,
                            completedChapters: this.completedChapters,
                            completionPercentage: Math.round(this.completionPercentage),
                            coursesCount: this.courseProgressDetails.length,
                            courses: this.courseProgressDetails.map(c => ({
                                name: c.courseName,
                                rate: c.completionRate + '%'
                            }))
                        });

                    } catch (error) {
                        console.error('åŠ è½½ç« èŠ‚è¿›åº¦å¤±è´¥:', error);
                        // è®¾ç½®é»˜è®¤å€¼ï¼Œé¿å…UIæ˜¾ç¤ºå¼‚å¸¸
                        this.setDefaultChapterData();
                        
                        // å¯ä»¥é€‰æ‹©æ˜¾ç¤ºé”™è¯¯æç¤ºç»™ç”¨æˆ·
                        // this.showError('ç« èŠ‚è¿›åº¦åŠ è½½å¤±è´¥: ' + error.message);
                    }
                },

                setDefaultChapterData() {
                    this.totalChapters = 0;
                    this.completedChapters = 0;
                    this.completionPercentage = 0;
                    this.courseProgressDetails = [];
                    console.log('âš ï¸ ä½¿ç”¨é»˜è®¤ç« èŠ‚è¿›åº¦æ•°æ®');
                },

                formatTime(minutes) {
                    if (minutes < 60) return minutes + 'åˆ†é’Ÿ';
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    return hours + 'å°æ—¶' + (mins > 0 ? mins + 'åˆ†é’Ÿ' : '');
                },

                formatDate(dateStr) {
                    if (!dateStr) return 'æœªçŸ¥';
                    return new Date(dateStr).toLocaleString('zh-CN');
                },

                formatSize(bytes) {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return Math.round(bytes / 1024) + ' KB';
                    return Math.round(bytes / 1024 / 1024 * 10) / 10 + ' MB';
                }
            }));

            // å¤‡ä»½çŠ¶æ€ç»„ä»¶
            Alpine.data('backupStatus', () => ({
                hasBackup: false,
                restoring: false,

                init() {
                    this.checkBackup();
                },

                checkBackup() {
                    const info = window.studyStats.getStorageInfo();
                    this.hasBackup = info.hasBackup || false;
                },

                async restoreBackup() {
                    this.restoring = true;
                    try {
                        const result = window.studyStats.restoreBackupData();
                        if (result.success) {
                            this.$dispatch('notify-success', {
                                title: 'æ¢å¤æˆåŠŸ',
                                message: 'å·²æ¢å¤åˆ°å¯¼å…¥å‰çš„æ•°æ®çŠ¶æ€'
                            });
                            this.hasBackup = false;
                            // åˆ·æ–°æ•°æ®æ¦‚è§ˆ
                            this.$dispatch('refresh-overview');
                        } else {
                            throw new Error(result.message);
                        }
                    } catch (error) {
                        this.$dispatch('notify-error', {
                            title: 'æ¢å¤å¤±è´¥',
                            message: error.message
                        });
                    } finally {
                        this.restoring = false;
                    }
                }
            }));

            // å¯¼å‡ºæ•°æ®ç»„ä»¶
            Alpine.data('exportData', () => ({
                selectedFormat: 'json',
                exporting: false,

                async exportData() {
                    this.exporting = true;
                    try {
                        const result = window.studyStats.exportStudyData(this.selectedFormat);
                        if (result.success) {
                            this.$dispatch('notify-success', {
                                title: 'å¯¼å‡ºæˆåŠŸ',
                                message: `${this.selectedFormat.toUpperCase()}æ–‡ä»¶å·²ä¸‹è½½åˆ°æœ¬åœ°`
                            });
                        } else {
                            throw new Error(result.message);
                        }
                    } catch (error) {
                        this.$dispatch('notify-error', {
                            title: 'å¯¼å‡ºå¤±è´¥',
                            message: error.message
                        });
                    } finally {
                        this.exporting = false;
                    }
                }
            }));

            // å¯¼å…¥æ•°æ®ç»„ä»¶
            Alpine.data('importData', () => ({
                selectedFile: null,
                importing: false,

                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file && file.type === 'application/json') {
                        this.selectedFile = file;
                    } else {
                        this.$dispatch('notify-error', {
                            title: 'æ–‡ä»¶æ ¼å¼é”™è¯¯',
                            message: 'è¯·é€‰æ‹©æœ‰æ•ˆçš„JSONæ–‡ä»¶'
                        });
                    }
                },

                handleDrop(event) {
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        if (file.type === 'application/json') {
                            this.selectedFile = file;
                        } else {
                            this.$dispatch('notify-error', {
                                title: 'æ–‡ä»¶æ ¼å¼é”™è¯¯',
                                message: 'è¯·æ‹–æ‹½æœ‰æ•ˆçš„JSONæ–‡ä»¶'
                            });
                        }
                    }
                },

                clearFile() {
                    this.selectedFile = null;
                    this.$refs.fileInput.value = '';
                },

                async importData() {
                    if (!this.selectedFile) return;
                    
                    this.importing = true;
                    try {
                        const result = await window.studyStats.importStudyData(this.selectedFile);
                        if (result.success) {
                            this.$dispatch('notify-success', {
                                title: 'å¯¼å…¥æˆåŠŸ',
                                message: `æ•°æ®å·²æˆåŠŸ${result.strategy === 'merge' ? 'åˆå¹¶' : 'æ›¿æ¢'}å¯¼å…¥`
                            });
                            this.clearFile();
                            // åˆ·æ–°é¡µé¢æ•°æ®
                            setTimeout(() => {
                                this.$dispatch('refresh-overview');
                                this.$dispatch('refresh-backup');
                            }, 1000);
                        } else {
                            throw new Error(result.message);
                        }
                    } catch (error) {
                        this.$dispatch('notify-error', {
                            title: 'å¯¼å…¥å¤±è´¥',
                            message: error.message
                        });
                    } finally {
                        this.importing = false;
                    }
                },

                formatFileSize(bytes) {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return Math.round(bytes / 1024) + ' KB';
                    return Math.round(bytes / 1024 / 1024 * 10) / 10 + ' MB';
                }
            }));
        });

        // ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶
        document.addEventListener('notify-success', (e) => {
            Alpine.store('notification').showSuccess(e.detail.title, e.detail.message);
        });

        document.addEventListener('notify-error', (e) => {
            Alpine.store('notification').showError(e.detail.title, e.detail.message);
        });

        document.addEventListener('notify-info', (e) => {
            Alpine.store('notification').showInfo(e.detail.title, e.detail.message);
        });

        document.addEventListener('refresh-overview', () => {
            // è§¦å‘æ•°æ®æ¦‚è§ˆåˆ·æ–°
            const overviewComponent = document.querySelector('[x-data="dataOverview"]');
            if (overviewComponent) {
                overviewComponent._x_dataStack[0].refreshData();
            }
        });

        document.addEventListener('refresh-backup', () => {
            // è§¦å‘å¤‡ä»½çŠ¶æ€åˆ·æ–°
            const backupComponent = document.querySelector('[x-data="backupStatus"]');
            if (backupComponent) {
                backupComponent._x_dataStack[0].checkBackup();
            }
        });

        // åˆ›å»ºå…¨å±€é€šçŸ¥store
        document.addEventListener('alpine:init', () => {
            Alpine.store('notification', {
                show: false,
                title: '',
                message: '',
                icon: '',
                
                showSuccess(title, message) {
                    const event = new CustomEvent('notify-success', {
                        detail: { title, message }
                    });
                    document.dispatchEvent(event);
                },
                
                showError(title, message) {
                    const event = new CustomEvent('notify-error', {
                        detail: { title, message }
                    });
                    document.dispatchEvent(event);
                },
                
                showInfo(title, message) {
                    const event = new CustomEvent('notify-info', {
                        detail: { title, message }
                    });
                    document.dispatchEvent(event);
                }
            });
        });
    </script>
</body>
</html>