<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试导入数据同步修复</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; border-radius: 8px; padding: 20px; margin: 15px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status { padding: 8px 15px; border-radius: 20px; font-size: 14px; margin: 5px; display: inline-block; }
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        .log { background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.warning { background: #ffc107; color: #212529; }
        .progress-item { padding: 10px; margin: 5px 0; background: #e9ecef; border-left: 4px solid #007bff; border-radius: 0 5px 5px 0; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .test-step { margin: 10px 0; padding: 10px; background: #f8f9fa; border-left: 4px solid #6c757d; }
        .test-step.active { border-left-color: #007bff; background: #e7f3ff; }
        .test-step.completed { border-left-color: #28a745; background: #d4edda; }
        .import-area { border: 2px dashed #dee2e6; padding: 20px; text-align: center; background: #f8f9fa; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 导入数据同步修复验证</h1>
        
        <div class="card">
            <h2>📋 测试说明</h2>
            <p>这个测试页面用于验证导入学习记录后，章节完成度能否正确显示在subjects.html中。</p>
            <p><strong>问题:</strong> 之前导入数据后，章节完成度显示为0，因为数据没有同步到subjects.html使用的localStorage格式。</p>
            <p><strong>修复:</strong> 增加了<code>syncChapterProgressToSubjectsFormat()</code>方法，将导入的数据同步到localStorage。</p>
        </div>

        <div class="card">
            <h2>🎮 测试步骤</h2>
            <div id="testSteps">
                <div class="test-step" id="step1">
                    <strong>1. 创建测试数据</strong>
                    <button onclick="createTestImportData()">创建测试导入数据</button>
                    <span id="step1Status"></span>
                </div>
                <div class="test-step" id="step2">
                    <strong>2. 清空现有数据</strong>
                    <button onclick="clearExistingData()">清空localStorage</button>
                    <span id="step2Status"></span>
                </div>
                <div class="test-step" id="step3">
                    <strong>3. 模拟导入数据</strong>
                    <button onclick="simulateImport()">模拟导入过程</button>
                    <span id="step3Status"></span>
                </div>
                <div class="test-step" id="step4">
                    <strong>4. 验证数据同步</strong>
                    <button onclick="verifyDataSync()">验证subjects数据</button>
                    <span id="step4Status"></span>
                </div>
                <div class="test-step" id="step5">
                    <strong>5. 测试章节进度显示</strong>
                    <button onclick="testChapterProgressDisplay()">测试进度显示</button>
                    <span id="step5Status"></span>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>📊 测试结果</h2>
                <div id="testResults">
                    <p>等待测试开始...</p>
                </div>
            </div>

            <div class="card">
                <h2>📝 详细日志</h2>
                <div id="testLog" class="log">测试准备就绪...\n</div>
                <button onclick="clearLog()">清空日志</button>
            </div>
        </div>

        <div class="card">
            <h2>📄 数据对比</h2>
            <div class="grid">
                <div>
                    <h3>导入前的subjects数据</h3>
                    <pre id="beforeData" style="background:#f8f9fa;padding:10px;border-radius:5px;font-size:12px;">未加载</pre>
                </div>
                <div>
                    <h3>导入后的subjects数据</h3>
                    <pre id="afterData" style="background:#f8f9fa;padding:10px;border-radius:5px;font-size:12px;">未加载</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入必要的JS -->
    <script src="assets/js/stats-manager.js"></script>

    <script>
        let testImportData = null;
        let currentStep = 1;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').textContent = '日志已清空...\n';
        }

        function updateStepStatus(stepNum, status, message = '') {
            const stepEl = document.getElementById(`step${stepNum}`);
            const statusEl = document.getElementById(`step${stepNum}Status`);
            
            stepEl.className = `test-step ${status}`;
            statusEl.innerHTML = message ? `<span class="status ${status}">${message}</span>` : '';
        }

        function createTestImportData() {
            log('创建测试导入数据...');
            
            testImportData = {
                exportInfo: {
                    exportTime: new Date().toISOString(),
                    version: '1.2',
                    platform: 'Computer Science Study Platform'
                },
                stats: {
                    totalStudyTime: 500,
                    totalSessions: 25,
                    totalQuestionsAnswered: 150,
                    correctAnswers: 120,
                    dailyStats: {},
                    subjectStats: {}
                },
                chapterProgress: {
                    courseProgress: {
                        'mathematics': {
                            courseName: '数学',
                            courseId: 'mathematics',
                            chapters: [
                                { index: 0, name: '高等数学基础', duration: '2小时30分钟', difficulty: '简单', completed: true, watchedSeconds: 9000 },
                                { index: 1, name: '线性代数', duration: '1小时45分钟', difficulty: '中等', completed: true, watchedSeconds: 6300 },
                                { index: 2, name: '概率统计', duration: '3小时15分钟', difficulty: '困难', completed: false, watchedSeconds: 0 }
                            ],
                            completedCount: 2,
                            totalWatchedSeconds: 15300
                        },
                        'data_structure': {
                            courseName: '数据结构',
                            courseId: 'data_structure',
                            chapters: [
                                { index: 0, name: '线性表', duration: '3小时', difficulty: '中等', completed: true, watchedSeconds: 10800 },
                                { index: 1, name: '栈和队列', duration: '2小时30分钟', difficulty: '中等', completed: true, watchedSeconds: 9000 },
                                { index: 2, name: '树和二叉树', duration: '4小时', difficulty: '困难', completed: false, watchedSeconds: 0 }
                            ],
                            completedCount: 2,
                            totalWatchedSeconds: 19800
                        }
                    },
                    totalChapters: 6,
                    completedChapters: 4,
                    totalWatchedSeconds: 35100
                }
            };

            log('测试导入数据创建完成', 'success');
            log(`包含 ${testImportData.chapterProgress.totalChapters} 个章节，其中 ${testImportData.chapterProgress.completedChapters} 个已完成`);
            
            updateStepStatus(1, 'completed', '数据已创建');
            document.getElementById('testResults').innerHTML = `
                <div class="progress-item">
                    <strong>测试数据概览</strong><br>
                    总章节数: ${testImportData.chapterProgress.totalChapters}<br>
                    已完成: ${testImportData.chapterProgress.completedChapters}<br>
                    完成率: ${Math.round((testImportData.chapterProgress.completedChapters / testImportData.chapterProgress.totalChapters) * 100)}%
                </div>
            `;
        }

        function clearExistingData() {
            log('清空现有localStorage数据...');
            
            // 记录清空前的数据
            const beforeData = localStorage.getItem('study_progress');
            document.getElementById('beforeData').textContent = beforeData ? JSON.stringify(JSON.parse(beforeData), null, 2) : '无数据';
            
            localStorage.removeItem('study_progress');
            localStorage.removeItem('study_statistics');
            
            log('现有数据已清空', 'success');
            updateStepStatus(2, 'completed', '数据已清空');
        }

        async function simulateImport() {
            if (!testImportData) {
                log('请先创建测试数据', 'error');
                return;
            }

            log('开始模拟导入过程...');
            updateStepStatus(3, 'active', '导入中...');
            
            try {
                if (!window.studyStats) {
                    throw new Error('StudyStatsManager未初始化');
                }

                // 直接调用同步方法测试
                log('调用syncChapterProgressToSubjectsFormat方法...');
                const syncResult = await window.studyStats.syncChapterProgressToSubjectsFormat(
                    testImportData.chapterProgress, 
                    'replace'
                );
                
                if (syncResult.success) {
                    log('数据同步成功!', 'success');
                    log(`更新了 ${syncResult.updatedSubjects} 个科目，创建了 ${syncResult.createdSubjects} 个科目`);
                    updateStepStatus(3, 'completed', '导入成功');
                } else {
                    throw new Error(syncResult.error || '同步失败');
                }
                
            } catch (error) {
                log(`导入失败: ${error.message}`, 'error');
                updateStepStatus(3, 'error', '导入失败');
            }
        }

        function verifyDataSync() {
            log('验证数据同步结果...');
            
            const afterData = localStorage.getItem('study_progress');
            if (!afterData) {
                log('未找到同步后的subjects数据', 'error');
                updateStepStatus(4, 'error', '验证失败');
                return;
            }

            try {
                const parsedData = JSON.parse(afterData);
                document.getElementById('afterData').textContent = JSON.stringify(parsedData, null, 2);
                
                // 统计同步后的数据
                let totalChapters = 0;
                let completedChapters = 0;
                
                const allSubjects = [
                    ...(parsedData.publicSubjects || []),
                    ...(parsedData.professionalSubjects || [])
                ];
                
                allSubjects.forEach(subject => {
                    if (subject.chapters) {
                        totalChapters += subject.chapters.length;
                        completedChapters += subject.chapters.filter(ch => ch.completed).length;
                    }
                });
                
                log(`同步验证完成: ${completedChapters}/${totalChapters} 章节已完成`, 'success');
                
                if (completedChapters > 0) {
                    updateStepStatus(4, 'completed', '验证成功');
                    document.getElementById('testResults').innerHTML += `
                        <div class="progress-item" style="border-left-color: #28a745;">
                            <strong>同步验证结果</strong><br>
                            subjects数据中的章节: ${totalChapters}<br>
                            已完成章节: ${completedChapters}<br>
                            完成率: ${Math.round((completedChapters / totalChapters) * 100)}%
                        </div>
                    `;
                } else {
                    updateStepStatus(4, 'warning', '章节完成度为0');
                }
                
            } catch (error) {
                log(`解析同步数据失败: ${error.message}`, 'error');
                updateStepStatus(4, 'error', '解析失败');
            }
        }

        async function testChapterProgressDisplay() {
            log('测试章节进度显示功能...');
            
            try {
                if (!window.studyStats) {
                    throw new Error('StudyStatsManager未初始化');
                }
                
                // 调用章节进度获取方法
                const chapterProgress = await window.studyStats.getAllChapterProgress();
                
                log(`进度显示测试结果: ${chapterProgress.completedChapters}/${chapterProgress.totalChapters} 章节`, 'success');
                
                if (chapterProgress.completedChapters > 0) {
                    updateStepStatus(5, 'completed', '显示正常');
                    
                    let resultsHTML = document.getElementById('testResults').innerHTML;
                    resultsHTML += `
                        <div class="progress-item" style="border-left-color: #007bff;">
                            <strong>最终测试结果</strong><br>
                            ✅ 导入数据成功同步到subjects格式<br>
                            ✅ 章节完成度正确显示: ${chapterProgress.completedChapters}/${chapterProgress.totalChapters}<br>
                            ✅ 完成率: ${Math.round((chapterProgress.completedChapters / chapterProgress.totalChapters) * 100)}%<br>
                            <strong style="color: #28a745;">修复成功！</strong>
                        </div>
                    `;
                    document.getElementById('testResults').innerHTML = resultsHTML;
                    
                } else {
                    updateStepStatus(5, 'error', '显示异常');
                    log('章节完成度仍为0，修复可能未生效', 'error');
                }
                
            } catch (error) {
                log(`进度显示测试失败: ${error.message}`, 'error');
                updateStepStatus(5, 'error', '测试失败');
            }
        }

        // 页面加载时的初始化
        window.addEventListener('load', () => {
            log('测试页面加载完成');
            if (window.studyStats) {
                log('StudyStatsManager已就绪', 'success');
            } else {
                log('StudyStatsManager未找到', 'error');
            }
        });
    </script>
</body>
</html>