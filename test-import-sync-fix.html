<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•å¯¼å…¥æ•°æ®åŒæ­¥ä¿®å¤</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; border-radius: 8px; padding: 20px; margin: 15px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status { padding: 8px 15px; border-radius: 20px; font-size: 14px; margin: 5px; display: inline-block; }
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        .log { background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.warning { background: #ffc107; color: #212529; }
        .progress-item { padding: 10px; margin: 5px 0; background: #e9ecef; border-left: 4px solid #007bff; border-radius: 0 5px 5px 0; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .test-step { margin: 10px 0; padding: 10px; background: #f8f9fa; border-left: 4px solid #6c757d; }
        .test-step.active { border-left-color: #007bff; background: #e7f3ff; }
        .test-step.completed { border-left-color: #28a745; background: #d4edda; }
        .import-area { border: 2px dashed #dee2e6; padding: 20px; text-align: center; background: #f8f9fa; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ å¯¼å…¥æ•°æ®åŒæ­¥ä¿®å¤éªŒè¯</h1>
        
        <div class="card">
            <h2>ğŸ“‹ æµ‹è¯•è¯´æ˜</h2>
            <p>è¿™ä¸ªæµ‹è¯•é¡µé¢ç”¨äºéªŒè¯å¯¼å…¥å­¦ä¹ è®°å½•åï¼Œç« èŠ‚å®Œæˆåº¦èƒ½å¦æ­£ç¡®æ˜¾ç¤ºåœ¨subjects.htmlä¸­ã€‚</p>
            <p><strong>é—®é¢˜:</strong> ä¹‹å‰å¯¼å…¥æ•°æ®åï¼Œç« èŠ‚å®Œæˆåº¦æ˜¾ç¤ºä¸º0ï¼Œå› ä¸ºæ•°æ®æ²¡æœ‰åŒæ­¥åˆ°subjects.htmlä½¿ç”¨çš„localStorageæ ¼å¼ã€‚</p>
            <p><strong>ä¿®å¤:</strong> å¢åŠ äº†<code>syncChapterProgressToSubjectsFormat()</code>æ–¹æ³•ï¼Œå°†å¯¼å…¥çš„æ•°æ®åŒæ­¥åˆ°localStorageã€‚</p>
        </div>

        <div class="card">
            <h2>ğŸ® æµ‹è¯•æ­¥éª¤</h2>
            <div id="testSteps">
                <div class="test-step" id="step1">
                    <strong>1. åˆ›å»ºæµ‹è¯•æ•°æ®</strong>
                    <button onclick="createTestImportData()">åˆ›å»ºæµ‹è¯•å¯¼å…¥æ•°æ®</button>
                    <span id="step1Status"></span>
                </div>
                <div class="test-step" id="step2">
                    <strong>2. æ¸…ç©ºç°æœ‰æ•°æ®</strong>
                    <button onclick="clearExistingData()">æ¸…ç©ºlocalStorage</button>
                    <span id="step2Status"></span>
                </div>
                <div class="test-step" id="step3">
                    <strong>3. æ¨¡æ‹Ÿå¯¼å…¥æ•°æ®</strong>
                    <button onclick="simulateImport()">æ¨¡æ‹Ÿå¯¼å…¥è¿‡ç¨‹</button>
                    <span id="step3Status"></span>
                </div>
                <div class="test-step" id="step4">
                    <strong>4. éªŒè¯æ•°æ®åŒæ­¥</strong>
                    <button onclick="verifyDataSync()">éªŒè¯subjectsæ•°æ®</button>
                    <span id="step4Status"></span>
                </div>
                <div class="test-step" id="step5">
                    <strong>5. æµ‹è¯•ç« èŠ‚è¿›åº¦æ˜¾ç¤º</strong>
                    <button onclick="testChapterProgressDisplay()">æµ‹è¯•è¿›åº¦æ˜¾ç¤º</button>
                    <span id="step5Status"></span>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
                <div id="testResults">
                    <p>ç­‰å¾…æµ‹è¯•å¼€å§‹...</p>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ“ è¯¦ç»†æ—¥å¿—</h2>
                <div id="testLog" class="log">æµ‹è¯•å‡†å¤‡å°±ç»ª...\n</div>
                <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“„ æ•°æ®å¯¹æ¯”</h2>
            <div class="grid">
                <div>
                    <h3>å¯¼å…¥å‰çš„subjectsæ•°æ®</h3>
                    <pre id="beforeData" style="background:#f8f9fa;padding:10px;border-radius:5px;font-size:12px;">æœªåŠ è½½</pre>
                </div>
                <div>
                    <h3>å¯¼å…¥åçš„subjectsæ•°æ®</h3>
                    <pre id="afterData" style="background:#f8f9fa;padding:10px;border-radius:5px;font-size:12px;">æœªåŠ è½½</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„JS -->
    <script src="assets/js/stats-manager.js"></script>

    <script>
        let testImportData = null;
        let currentStep = 1;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').textContent = 'æ—¥å¿—å·²æ¸…ç©º...\n';
        }

        function updateStepStatus(stepNum, status, message = '') {
            const stepEl = document.getElementById(`step${stepNum}`);
            const statusEl = document.getElementById(`step${stepNum}Status`);
            
            stepEl.className = `test-step ${status}`;
            statusEl.innerHTML = message ? `<span class="status ${status}">${message}</span>` : '';
        }

        function createTestImportData() {
            log('åˆ›å»ºæµ‹è¯•å¯¼å…¥æ•°æ®...');
            
            testImportData = {
                exportInfo: {
                    exportTime: new Date().toISOString(),
                    version: '1.2',
                    platform: 'Computer Science Study Platform'
                },
                stats: {
                    totalStudyTime: 500,
                    totalSessions: 25,
                    totalQuestionsAnswered: 150,
                    correctAnswers: 120,
                    dailyStats: {},
                    subjectStats: {}
                },
                chapterProgress: {
                    courseProgress: {
                        'mathematics': {
                            courseName: 'æ•°å­¦',
                            courseId: 'mathematics',
                            chapters: [
                                { index: 0, name: 'é«˜ç­‰æ•°å­¦åŸºç¡€', duration: '2å°æ—¶30åˆ†é’Ÿ', difficulty: 'ç®€å•', completed: true, watchedSeconds: 9000 },
                                { index: 1, name: 'çº¿æ€§ä»£æ•°', duration: '1å°æ—¶45åˆ†é’Ÿ', difficulty: 'ä¸­ç­‰', completed: true, watchedSeconds: 6300 },
                                { index: 2, name: 'æ¦‚ç‡ç»Ÿè®¡', duration: '3å°æ—¶15åˆ†é’Ÿ', difficulty: 'å›°éš¾', completed: false, watchedSeconds: 0 }
                            ],
                            completedCount: 2,
                            totalWatchedSeconds: 15300
                        },
                        'data_structure': {
                            courseName: 'æ•°æ®ç»“æ„',
                            courseId: 'data_structure',
                            chapters: [
                                { index: 0, name: 'çº¿æ€§è¡¨', duration: '3å°æ—¶', difficulty: 'ä¸­ç­‰', completed: true, watchedSeconds: 10800 },
                                { index: 1, name: 'æ ˆå’Œé˜Ÿåˆ—', duration: '2å°æ—¶30åˆ†é’Ÿ', difficulty: 'ä¸­ç­‰', completed: true, watchedSeconds: 9000 },
                                { index: 2, name: 'æ ‘å’ŒäºŒå‰æ ‘', duration: '4å°æ—¶', difficulty: 'å›°éš¾', completed: false, watchedSeconds: 0 }
                            ],
                            completedCount: 2,
                            totalWatchedSeconds: 19800
                        }
                    },
                    totalChapters: 6,
                    completedChapters: 4,
                    totalWatchedSeconds: 35100
                }
            };

            log('æµ‹è¯•å¯¼å…¥æ•°æ®åˆ›å»ºå®Œæˆ', 'success');
            log(`åŒ…å« ${testImportData.chapterProgress.totalChapters} ä¸ªç« èŠ‚ï¼Œå…¶ä¸­ ${testImportData.chapterProgress.completedChapters} ä¸ªå·²å®Œæˆ`);
            
            updateStepStatus(1, 'completed', 'æ•°æ®å·²åˆ›å»º');
            document.getElementById('testResults').innerHTML = `
                <div class="progress-item">
                    <strong>æµ‹è¯•æ•°æ®æ¦‚è§ˆ</strong><br>
                    æ€»ç« èŠ‚æ•°: ${testImportData.chapterProgress.totalChapters}<br>
                    å·²å®Œæˆ: ${testImportData.chapterProgress.completedChapters}<br>
                    å®Œæˆç‡: ${Math.round((testImportData.chapterProgress.completedChapters / testImportData.chapterProgress.totalChapters) * 100)}%
                </div>
            `;
        }

        function clearExistingData() {
            log('æ¸…ç©ºç°æœ‰localStorageæ•°æ®...');
            
            // è®°å½•æ¸…ç©ºå‰çš„æ•°æ®
            const beforeData = localStorage.getItem('study_progress');
            document.getElementById('beforeData').textContent = beforeData ? JSON.stringify(JSON.parse(beforeData), null, 2) : 'æ— æ•°æ®';
            
            localStorage.removeItem('study_progress');
            localStorage.removeItem('study_statistics');
            
            log('ç°æœ‰æ•°æ®å·²æ¸…ç©º', 'success');
            updateStepStatus(2, 'completed', 'æ•°æ®å·²æ¸…ç©º');
        }

        async function simulateImport() {
            if (!testImportData) {
                log('è¯·å…ˆåˆ›å»ºæµ‹è¯•æ•°æ®', 'error');
                return;
            }

            log('å¼€å§‹æ¨¡æ‹Ÿå¯¼å…¥è¿‡ç¨‹...');
            updateStepStatus(3, 'active', 'å¯¼å…¥ä¸­...');
            
            try {
                if (!window.studyStats) {
                    throw new Error('StudyStatsManageræœªåˆå§‹åŒ–');
                }

                // ç›´æ¥è°ƒç”¨åŒæ­¥æ–¹æ³•æµ‹è¯•
                log('è°ƒç”¨syncChapterProgressToSubjectsFormatæ–¹æ³•...');
                const syncResult = await window.studyStats.syncChapterProgressToSubjectsFormat(
                    testImportData.chapterProgress, 
                    'replace'
                );
                
                if (syncResult.success) {
                    log('æ•°æ®åŒæ­¥æˆåŠŸ!', 'success');
                    log(`æ›´æ–°äº† ${syncResult.updatedSubjects} ä¸ªç§‘ç›®ï¼Œåˆ›å»ºäº† ${syncResult.createdSubjects} ä¸ªç§‘ç›®`);
                    updateStepStatus(3, 'completed', 'å¯¼å…¥æˆåŠŸ');
                } else {
                    throw new Error(syncResult.error || 'åŒæ­¥å¤±è´¥');
                }
                
            } catch (error) {
                log(`å¯¼å…¥å¤±è´¥: ${error.message}`, 'error');
                updateStepStatus(3, 'error', 'å¯¼å…¥å¤±è´¥');
            }
        }

        function verifyDataSync() {
            log('éªŒè¯æ•°æ®åŒæ­¥ç»“æœ...');
            
            const afterData = localStorage.getItem('study_progress');
            if (!afterData) {
                log('æœªæ‰¾åˆ°åŒæ­¥åçš„subjectsæ•°æ®', 'error');
                updateStepStatus(4, 'error', 'éªŒè¯å¤±è´¥');
                return;
            }

            try {
                const parsedData = JSON.parse(afterData);
                document.getElementById('afterData').textContent = JSON.stringify(parsedData, null, 2);
                
                // ç»Ÿè®¡åŒæ­¥åçš„æ•°æ®
                let totalChapters = 0;
                let completedChapters = 0;
                
                const allSubjects = [
                    ...(parsedData.publicSubjects || []),
                    ...(parsedData.professionalSubjects || [])
                ];
                
                allSubjects.forEach(subject => {
                    if (subject.chapters) {
                        totalChapters += subject.chapters.length;
                        completedChapters += subject.chapters.filter(ch => ch.completed).length;
                    }
                });
                
                log(`åŒæ­¥éªŒè¯å®Œæˆ: ${completedChapters}/${totalChapters} ç« èŠ‚å·²å®Œæˆ`, 'success');
                
                if (completedChapters > 0) {
                    updateStepStatus(4, 'completed', 'éªŒè¯æˆåŠŸ');
                    document.getElementById('testResults').innerHTML += `
                        <div class="progress-item" style="border-left-color: #28a745;">
                            <strong>åŒæ­¥éªŒè¯ç»“æœ</strong><br>
                            subjectsæ•°æ®ä¸­çš„ç« èŠ‚: ${totalChapters}<br>
                            å·²å®Œæˆç« èŠ‚: ${completedChapters}<br>
                            å®Œæˆç‡: ${Math.round((completedChapters / totalChapters) * 100)}%
                        </div>
                    `;
                } else {
                    updateStepStatus(4, 'warning', 'ç« èŠ‚å®Œæˆåº¦ä¸º0');
                }
                
            } catch (error) {
                log(`è§£æåŒæ­¥æ•°æ®å¤±è´¥: ${error.message}`, 'error');
                updateStepStatus(4, 'error', 'è§£æå¤±è´¥');
            }
        }

        async function testChapterProgressDisplay() {
            log('æµ‹è¯•ç« èŠ‚è¿›åº¦æ˜¾ç¤ºåŠŸèƒ½...');
            
            try {
                if (!window.studyStats) {
                    throw new Error('StudyStatsManageræœªåˆå§‹åŒ–');
                }
                
                // è°ƒç”¨ç« èŠ‚è¿›åº¦è·å–æ–¹æ³•
                const chapterProgress = await window.studyStats.getAllChapterProgress();
                
                log(`è¿›åº¦æ˜¾ç¤ºæµ‹è¯•ç»“æœ: ${chapterProgress.completedChapters}/${chapterProgress.totalChapters} ç« èŠ‚`, 'success');
                
                if (chapterProgress.completedChapters > 0) {
                    updateStepStatus(5, 'completed', 'æ˜¾ç¤ºæ­£å¸¸');
                    
                    let resultsHTML = document.getElementById('testResults').innerHTML;
                    resultsHTML += `
                        <div class="progress-item" style="border-left-color: #007bff;">
                            <strong>æœ€ç»ˆæµ‹è¯•ç»“æœ</strong><br>
                            âœ… å¯¼å…¥æ•°æ®æˆåŠŸåŒæ­¥åˆ°subjectsæ ¼å¼<br>
                            âœ… ç« èŠ‚å®Œæˆåº¦æ­£ç¡®æ˜¾ç¤º: ${chapterProgress.completedChapters}/${chapterProgress.totalChapters}<br>
                            âœ… å®Œæˆç‡: ${Math.round((chapterProgress.completedChapters / chapterProgress.totalChapters) * 100)}%<br>
                            <strong style="color: #28a745;">ä¿®å¤æˆåŠŸï¼</strong>
                        </div>
                    `;
                    document.getElementById('testResults').innerHTML = resultsHTML;
                    
                } else {
                    updateStepStatus(5, 'error', 'æ˜¾ç¤ºå¼‚å¸¸');
                    log('ç« èŠ‚å®Œæˆåº¦ä»ä¸º0ï¼Œä¿®å¤å¯èƒ½æœªç”Ÿæ•ˆ', 'error');
                }
                
            } catch (error) {
                log(`è¿›åº¦æ˜¾ç¤ºæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateStepStatus(5, 'error', 'æµ‹è¯•å¤±è´¥');
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            if (window.studyStats) {
                log('StudyStatsManagerå·²å°±ç»ª', 'success');
            } else {
                log('StudyStatsManageræœªæ‰¾åˆ°', 'error');
            }
        });
    </script>
</body>
</html>