<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå¯¹è¯å†å²è®°å½•æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        .line-clamp-1 { 
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
        }
        .line-clamp-2 { 
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">AIå¯¹è¯å†å²è®°å½•æµ‹è¯•</h1>
            <p class="text-gray-600">æµ‹è¯•å®Œæ•´çš„AIå¯¹è¯å†å²è®°å½•åŠŸèƒ½</p>
        </div>

        <!-- æµ‹è¯•é¢æ¿ -->
        <div x-data="conversationHistoryTest" class="max-w-6xl mx-auto">
            <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-medium text-gray-900">å­˜å‚¨çŠ¶æ€</h3>
                        <div class="flex items-center">
                            <div class="w-2 h-2 rounded-full mr-2" 
                                 :class="storageReady ? 'bg-green-500' : 'bg-red-500'"></div>
                            <span class="text-xs" :class="storageReady ? 'text-green-600' : 'text-red-600'">
                                <span x-show="storageReady">å°±ç»ª</span>
                                <span x-show="!storageReady">æœªå°±ç»ª</span>
                            </span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1" x-text="storageType"></p>
                </div>

                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-medium text-gray-900">å½“å‰å¯¹è¯</h3>
                        <span class="text-xs text-gray-600" x-text="currentConversationId || 'æ— '"></span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                        <span x-text="messageCount"></span> æ¡æ¶ˆæ¯
                    </p>
                </div>

                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-medium text-gray-900">å†å²ç»Ÿè®¡</h3>
                        <span class="text-xs text-gray-600" x-text="totalConversations"></span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                        æ€»è®¡ <span x-text="totalMessages"></span> æ¡æ¶ˆæ¯
                    </p>
                </div>
            </div>

            <!-- åŠŸèƒ½æµ‹è¯•åŒºåŸŸ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- åŸºç¡€åŠŸèƒ½æµ‹è¯• -->
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">åŸºç¡€åŠŸèƒ½æµ‹è¯•</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <button @click="testCreateConversation" 
                                :disabled="testing"
                                class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50">
                            <span x-show="!testing">åˆ›å»ºæ–°å¯¹è¯</span>
                            <span x-show="testing">å¤„ç†ä¸­...</span>
                        </button>

                        <div x-show="currentConversationId" class="space-y-2">
                            <input type="text" 
                                   x-model="testMessage"
                                   placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯..."
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   @keyup.enter="testSendMessage">
                            
                            <button @click="testSendMessage" 
                                    :disabled="!testMessage.trim() || testing"
                                    class="w-full py-2 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50">
                                å‘é€æµ‹è¯•æ¶ˆæ¯
                            </button>
                        </div>

                        <button @click="testLoadHistory" 
                                :disabled="testing"
                                class="w-full py-2 px-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50">
                            åŠ è½½å†å²è®°å½•
                        </button>

                        <button @click="testSearchConversations" 
                                :disabled="testing"
                                class="w-full py-2 px-4 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors disabled:opacity-50">
                            æœç´¢æµ‹è¯•
                        </button>
                    </div>
                </div>

                <!-- é«˜çº§åŠŸèƒ½æµ‹è¯• -->
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">é«˜çº§åŠŸèƒ½æµ‹è¯•</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <button @click="testBatchCreate" 
                                :disabled="testing"
                                class="w-full py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50">
                            æ‰¹é‡åˆ›å»ºæµ‹è¯•æ•°æ®
                        </button>

                        <button @click="testExportData" 
                                :disabled="testing"
                                class="w-full py-2 px-4 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors disabled:opacity-50">
                            å¯¼å‡ºæ•°æ®æµ‹è¯•
                        </button>

                        <button @click="testCleanupData" 
                                :disabled="testing"
                                class="w-full py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50">
                            æ¸…ç†æ•°æ®æµ‹è¯•
                        </button>

                        <button @click="testPerformance" 
                                :disabled="testing"
                                class="w-full py-2 px-4 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors disabled:opacity-50">
                            æ€§èƒ½æµ‹è¯•
                        </button>

                        <button @click="clearAllData" 
                                :disabled="testing"
                                class="w-full py-2 px-4 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition-colors disabled:opacity-50">
                            âš ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®
                        </button>
                    </div>
                </div>
            </div>

            <!-- å½“å‰å¯¹è¯æ˜¾ç¤º -->
            <div x-show="currentMessages.length > 0" class="bg-white rounded-lg shadow mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">å½“å‰å¯¹è¯</h3>
                    <p class="text-sm text-gray-600" x-text="currentConversationTitle"></p>
                </div>
                <div class="p-6 max-h-96 overflow-y-auto">
                    <div class="space-y-4">
                        <template x-for="message in currentMessages" :key="message.timestamp">
                            <div class="flex" :class="message.role === 'user' ? 'justify-end' : 'justify-start'">
                                <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg"
                                     :class="message.role === 'user' 
                                         ? 'bg-blue-600 text-white' 
                                         : message.role === 'assistant' 
                                         ? 'bg-gray-200 text-gray-900'
                                         : 'bg-red-100 text-red-800'">
                                    <p class="text-sm" x-text="message.content"></p>
                                    <p class="text-xs mt-1 opacity-75" 
                                       x-text="formatTime(message.timestamp)"></p>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- å†å²å¯¹è¯åˆ—è¡¨ -->
            <div class="bg-white rounded-lg shadow mb-6">
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <h3 class="text-lg font-medium text-gray-900">å†å²å¯¹è¯</h3>
                    <div class="flex items-center space-x-2">
                        <input type="text" 
                               x-model="searchQuery"
                               @input="performSearch"
                               placeholder="æœç´¢å¯¹è¯..."
                               class="px-3 py-1 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <button @click="loadConversationHistory" 
                                class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors">
                            åˆ·æ–°
                        </button>
                    </div>
                </div>
                <div class="divide-y divide-gray-200 max-h-96 overflow-y-auto">
                    <template x-for="conversation in (searchResults.length > 0 ? searchResults : conversationHistory)" :key="conversation.id">
                        <div class="p-4 hover:bg-gray-50 cursor-pointer transition-colors"
                             @click="loadConversation(conversation.id)"
                             :class="conversation.id === currentConversationId ? 'bg-blue-50 border-l-4 border-blue-500' : ''">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <h4 class="text-sm font-medium text-gray-900 line-clamp-1" 
                                        x-text="conversation.title"></h4>
                                    <p class="text-xs text-gray-600 mt-1">
                                        <span x-text="conversation.messageCount || 0"></span> æ¡æ¶ˆæ¯ â€¢ 
                                        <span x-text="conversation.aiProvider || 'unknown'"></span>
                                    </p>
                                    <p class="text-xs text-gray-500 mt-1" 
                                       x-text="formatDate(conversation.updatedAt)"></p>
                                </div>
                                <div class="flex items-center space-x-1 ml-2">
                                    <button @click.stop="deleteConversation(conversation.id)"
                                            class="p-1 text-gray-400 hover:text-red-600 transition-colors">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9zM4 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 012 0v4a1 1 0 11-2 0V9zm4 0a1 1 0 112 0v4a1 1 0 11-2 0V9z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- ç©ºçŠ¶æ€ -->
                    <div x-show="conversationHistory.length === 0 && searchResults.length === 0 && !loading" 
                         class="p-8 text-center text-gray-500">
                        <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.955 8.955 0 01-2.707-.413l-3.293 3.293a1 1 0 01-1.414-1.414l3.293-3.293A8.955 8.955 0 013 12a8 8 0 018-8c4.418 0 8 3.582 8 8z"/>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">æš‚æ— å¯¹è¯å†å²</h3>
                        <p class="mt-1 text-sm text-gray-500">å¼€å§‹åˆ›å»ºä¸€äº›æµ‹è¯•å¯¹è¯å§ï¼</p>
                    </div>
                </div>
            </div>

            <!-- æµ‹è¯•æ—¥å¿— -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <h3 class="text-lg font-medium text-gray-900">æµ‹è¯•æ—¥å¿—</h3>
                    <button @click="clearLogs" 
                            class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        æ¸…ç©ºæ—¥å¿—
                    </button>
                </div>
                <div class="p-6 max-h-64 overflow-y-auto bg-gray-50 font-mono text-sm">
                    <template x-for="log in logs" :key="log.timestamp">
                        <div class="mb-2" :class="{
                            'text-green-600': log.type === 'success',
                            'text-red-600': log.type === 'error',
                            'text-blue-600': log.type === 'info',
                            'text-yellow-600': log.type === 'warning'
                        }">
                            <span class="text-gray-500 text-xs" x-text="formatTime(log.timestamp)"></span>
                            <span x-text="log.message"></span>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="../assets/js/ai-conversation-storage.js"></script>
    <script src="../assets/js/ai-service.js"></script>

    <script>
    // AIå¯¹è¯å†å²æµ‹è¯•æ•°æ®
    window.conversationHistoryTest = {
        // çŠ¶æ€
        storageReady: false,
        storageType: 'æ£€æŸ¥ä¸­...',
        testing: false,
        loading: false,

        // å½“å‰å¯¹è¯
        currentConversationId: null,
        currentConversationTitle: '',
        currentMessages: [],
        messageCount: 0,

        // å†å²æ•°æ®
        conversationHistory: [],
        totalConversations: 0,
        totalMessages: 0,

        // æœç´¢
        searchQuery: '',
        searchResults: [],
        searchTimeout: null,

        // æµ‹è¯•æ•°æ®
        testMessage: '',
        logs: [],

        // AIæœåŠ¡å®ä¾‹
        aiService: null,
        storage: null,

        // åˆå§‹åŒ–
        async init() {
            this.log('info', 'ğŸ”„ å¼€å§‹åˆå§‹åŒ–AIå¯¹è¯å†å²æµ‹è¯•...');
            
            try {
                await this.initializeServices();
                await this.checkStorageStatus();
                await this.loadInitialData();
                
                this.log('success', 'âœ… åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                this.log('error', 'âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
            }
        },

        // åˆå§‹åŒ–æœåŠ¡
        async initializeServices() {
            // åˆå§‹åŒ–å­˜å‚¨
            if (window.aiConversationStorage) {
                this.storage = window.aiConversationStorage;
                await this.storage.init();
                this.log('success', 'âœ… å¯¹è¯å­˜å‚¨åˆå§‹åŒ–æˆåŠŸ');
            } else {
                throw new Error('AIå¯¹è¯å­˜å‚¨æ¨¡å—æœªåŠ è½½');
            }

            // åˆå§‹åŒ–AIæœåŠ¡
            if (window.AIService) {
                this.aiService = new window.AIService();
                await this.aiService.initConversationStorage();
                this.log('success', 'âœ… AIæœåŠ¡åˆå§‹åŒ–æˆåŠŸ');
            } else {
                throw new Error('AIæœåŠ¡æ¨¡å—æœªåŠ è½½');
            }
        },

        // æ£€æŸ¥å­˜å‚¨çŠ¶æ€
        async checkStorageStatus() {
            try {
                if (this.storage) {
                    if (this.storage.useLocalStorageFallback) {
                        this.storageType = 'localStorage (é™çº§æ¨¡å¼)';
                    } else {
                        this.storageType = 'IndexedDB';
                    }
                    this.storageReady = true;
                    this.log('success', `âœ… å­˜å‚¨å°±ç»ª: ${this.storageType}`);
                }
            } catch (error) {
                this.storageReady = false;
                this.storageType = 'ä¸å¯ç”¨';
                this.log('error', 'âŒ å­˜å‚¨æ£€æŸ¥å¤±è´¥: ' + error.message);
            }
        },

        // åŠ è½½åˆå§‹æ•°æ®
        async loadInitialData() {
            await this.loadConversationHistory();
            await this.loadStats();
        },

        // åˆ›å»ºæµ‹è¯•å¯¹è¯
        async testCreateConversation() {
            this.testing = true;
            this.log('info', 'ğŸ“ åˆ›å»ºæ–°æµ‹è¯•å¯¹è¯...');

            try {
                const title = `æµ‹è¯•å¯¹è¯ ${new Date().toLocaleTimeString()}`;
                this.currentConversationId = await this.aiService.startNewConversation(title);
                this.currentConversationTitle = title;
                this.currentMessages = [];
                this.messageCount = 0;

                await this.loadConversationHistory();
                await this.loadStats();

                this.log('success', `âœ… åˆ›å»ºå¯¹è¯æˆåŠŸ: ${this.currentConversationId}`);
            } catch (error) {
                this.log('error', 'âŒ åˆ›å»ºå¯¹è¯å¤±è´¥: ' + error.message);
            } finally {
                this.testing = false;
            }
        },

        // å‘é€æµ‹è¯•æ¶ˆæ¯
        async testSendMessage() {
            if (!this.testMessage.trim() || !this.currentConversationId) return;

            this.testing = true;
            const message = this.testMessage;
            this.testMessage = '';

            this.log('info', `ğŸ“¤ å‘é€æ¶ˆæ¯: "${message}"`);

            try {
                // æ¨¡æ‹ŸAIå“åº”
                const mockResponse = this.generateMockResponse(message);
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                await this.storage.addMessage(
                    this.currentConversationId,
                    'user',
                    message,
                    { service: 'test' }
                );

                // æ·»åŠ AIå“åº”
                setTimeout(async () => {
                    await this.storage.addMessage(
                        this.currentConversationId,
                        'assistant',
                        mockResponse,
                        { service: 'test', processingTime: 1000 }
                    );

                    await this.loadCurrentConversation();
                    this.log('success', 'âœ… æ¶ˆæ¯å‘é€æˆåŠŸ');
                }, 1000);

                await this.loadCurrentConversation();
                
            } catch (error) {
                this.log('error', 'âŒ å‘é€æ¶ˆæ¯å¤±è´¥: ' + error.message);
            } finally {
                this.testing = false;
            }
        },

        // ç”Ÿæˆæ¨¡æ‹ŸAIå“åº”
        generateMockResponse(message) {
            const responses = [
                `æˆ‘ç†è§£æ‚¨è¯´çš„"${message}"ã€‚è¿™æ˜¯ä¸€ä¸ªæœ‰è¶£çš„è¯é¢˜ã€‚`,
                `å…³äº"${message}"ï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›ä¸€äº›è§è§£ã€‚`,
                `æ„Ÿè°¢æ‚¨çš„é—®é¢˜"${message}"ã€‚è®©æˆ‘æ¥å¸®æ‚¨åˆ†æä¸€ä¸‹ã€‚`,
                `"${message}"æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ã€‚æ ¹æ®æˆ‘çš„ç†è§£...`,
                `æ‚¨æåˆ°çš„"${message}"ç¡®å®å€¼å¾—æ·±å…¥æ¢è®¨ã€‚`
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        },

        // åŠ è½½å½“å‰å¯¹è¯
        async loadCurrentConversation() {
            if (!this.currentConversationId) return;

            try {
                const messages = await this.storage.getConversationMessages(this.currentConversationId);
                this.currentMessages = messages;
                this.messageCount = messages.length;
            } catch (error) {
                this.log('error', 'âŒ åŠ è½½å½“å‰å¯¹è¯å¤±è´¥: ' + error.message);
            }
        },

        // åŠ è½½å¯¹è¯å†å²
        async loadConversationHistory() {
            this.loading = true;
            this.log('info', 'ğŸ“š åŠ è½½å¯¹è¯å†å²...');

            try {
                const result = await this.aiService.getConversationHistory(0, 50);
                this.conversationHistory = result.conversations || [];
                this.log('success', `âœ… åŠ è½½äº† ${this.conversationHistory.length} ä¸ªå†å²å¯¹è¯`);
            } catch (error) {
                this.log('error', 'âŒ åŠ è½½å¯¹è¯å†å²å¤±è´¥: ' + error.message);
            } finally {
                this.loading = false;
            }
        },

        // åŠ è½½ç‰¹å®šå¯¹è¯
        async loadConversation(conversationId) {
            this.log('info', `ğŸ“– åŠ è½½å¯¹è¯: ${conversationId}`);

            try {
                const conversation = await this.aiService.loadConversation(conversationId);
                if (conversation) {
                    this.currentConversationId = conversationId;
                    this.currentMessages = conversation.messages;
                    this.messageCount = conversation.messages.length;
                    
                    // è·å–å¯¹è¯æ ‡é¢˜
                    const convData = this.conversationHistory.find(c => c.id === conversationId);
                    this.currentConversationTitle = convData?.title || 'æœªçŸ¥å¯¹è¯';
                    
                    this.log('success', `âœ… åŠ è½½å¯¹è¯æˆåŠŸ: ${this.messageCount} æ¡æ¶ˆæ¯`);
                }
            } catch (error) {
                this.log('error', 'âŒ åŠ è½½å¯¹è¯å¤±è´¥: ' + error.message);
            }
        },

        // åˆ é™¤å¯¹è¯
        async deleteConversation(conversationId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ')) return;

            this.log('info', `ğŸ—‘ï¸ åˆ é™¤å¯¹è¯: ${conversationId}`);

            try {
                await this.aiService.deleteConversation(conversationId);
                
                // ä»åˆ—è¡¨ä¸­ç§»é™¤
                this.conversationHistory = this.conversationHistory.filter(c => c.id !== conversationId);
                
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯
                if (this.currentConversationId === conversationId) {
                    this.currentConversationId = null;
                    this.currentMessages = [];
                    this.currentConversationTitle = '';
                    this.messageCount = 0;
                }

                await this.loadStats();
                this.log('success', 'âœ… å¯¹è¯åˆ é™¤æˆåŠŸ');
            } catch (error) {
                this.log('error', 'âŒ åˆ é™¤å¯¹è¯å¤±è´¥: ' + error.message);
            }
        },

        // æœç´¢æµ‹è¯•
        async testSearchConversations() {
            this.testing = true;
            this.log('info', 'ğŸ” å¼€å§‹æœç´¢æµ‹è¯•...');

            try {
                const testQueries = ['æµ‹è¯•', 'å¯¹è¯', 'æ¶ˆæ¯', 'AI'];
                const randomQuery = testQueries[Math.floor(Math.random() * testQueries.length)];
                
                const results = await this.aiService.searchConversations(randomQuery);
                
                this.log('success', `âœ… æœç´¢"${randomQuery}"æ‰¾åˆ° ${results.length} ä¸ªç»“æœ`);
                
                // æ˜¾ç¤ºæœç´¢ç»“æœ
                this.searchQuery = randomQuery;
                this.searchResults = results.map(r => r.conversation || { id: r.message?.conversationId }).filter(Boolean);
                
            } catch (error) {
                this.log('error', 'âŒ æœç´¢æµ‹è¯•å¤±è´¥: ' + error.message);
            } finally {
                this.testing = false;
            }
        },

        // æ‰§è¡Œæœç´¢
        async performSearch() {
            if (this.searchTimeout) {
                clearTimeout(this.searchTimeout);
            }
            
            this.searchTimeout = setTimeout(async () => {
                if (!this.searchQuery.trim()) {
                    this.searchResults = [];
                    return;
                }

                try {
                    const results = await this.aiService.searchConversations(this.searchQuery);
                    this.searchResults = results.map(r => r.conversation || { id: r.message?.conversationId }).filter(Boolean);
                } catch (error) {
                    this.log('error', 'âŒ æœç´¢å¤±è´¥: ' + error.message);
                }
            }, 300);
        },

        // æ‰¹é‡åˆ›å»ºæµ‹è¯•æ•°æ®
        async testBatchCreate() {
            this.testing = true;
            this.log('info', 'ğŸ“¦ æ‰¹é‡åˆ›å»ºæµ‹è¯•æ•°æ®...');

            try {
                const conversationTopics = [
                    'æ•°æ®ç»“æ„å­¦ä¹ è®¨è®º',
                    'ç®—æ³•é¢˜ç›®è§£ç­”',
                    'è®¡ç®—æœºç½‘ç»œåŸç†',
                    'æ“ä½œç³»ç»Ÿæ¦‚å¿µ',
                    'æ•°æ®åº“è®¾è®¡é—®é¢˜',
                    'ç¼–ç¨‹è¯­è¨€æ¯”è¾ƒ',
                    'è½¯ä»¶å·¥ç¨‹å®è·µ',
                    'äººå·¥æ™ºèƒ½åŸºç¡€'
                ];

                const testMessages = [
                    ['è¯·è§£é‡Šä¸€ä¸‹æ ˆå’Œé˜Ÿåˆ—çš„åŒºåˆ«ï¼Ÿ', 'æ ˆæ˜¯åè¿›å…ˆå‡º(LIFO)ï¼Œé˜Ÿåˆ—æ˜¯å…ˆè¿›å…ˆå‡º(FIFO)...'],
                    ['æ—¶é—´å¤æ‚åº¦O(n)æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ', 'æ—¶é—´å¤æ‚åº¦O(n)è¡¨ç¤ºç®—æ³•çš„æ‰§è¡Œæ—¶é—´ä¸è¾“å…¥å¤§å°æˆæ­£æ¯”...'],
                    ['ä»€ä¹ˆæ˜¯TCPå’ŒUDPçš„åŒºåˆ«ï¼Ÿ', 'TCPæ˜¯å¯é çš„ä¼ è¾“åè®®ï¼ŒUDPæ˜¯ä¸å¯é ä½†å¿«é€Ÿçš„åè®®...'],
                    ['è¿›ç¨‹å’Œçº¿ç¨‹æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ', 'è¿›ç¨‹æ˜¯ç³»ç»Ÿèµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œçº¿ç¨‹æ˜¯CPUè°ƒåº¦çš„åŸºæœ¬å•ä½...']
                ];

                for (let i = 0; i < 5; i++) {
                    const topic = conversationTopics[i % conversationTopics.length];
                    const conversationId = await this.aiService.startNewConversation(topic);
                    
                    // ä¸ºæ¯ä¸ªå¯¹è¯æ·»åŠ å‡ æ¡æ¶ˆæ¯
                    const messageSet = testMessages[i % testMessages.length];
                    
                    await this.storage.addMessage(conversationId, 'user', messageSet[0], { service: 'test' });
                    await new Promise(resolve => setTimeout(resolve, 100)); // å°å»¶è¿Ÿ
                    await this.storage.addMessage(conversationId, 'assistant', messageSet[1], { service: 'test' });
                    
                    this.log('info', `âœ… åˆ›å»ºæµ‹è¯•å¯¹è¯: ${topic}`);
                }

                await this.loadConversationHistory();
                await this.loadStats();
                
                this.log('success', 'âœ… æ‰¹é‡åˆ›å»ºå®Œæˆ');
            } catch (error) {
                this.log('error', 'âŒ æ‰¹é‡åˆ›å»ºå¤±è´¥: ' + error.message);
            } finally {
                this.testing = false;
            }
        },

        // å¯¼å‡ºæµ‹è¯•
        async testExportData() {
            this.testing = true;
            this.log('info', 'ğŸ“¤ æµ‹è¯•æ•°æ®å¯¼å‡º...');

            try {
                await this.aiService.exportConversationHistory();
                this.log('success', 'âœ… æ•°æ®å¯¼å‡ºæˆåŠŸ');
            } catch (error) {
                this.log('error', 'âŒ æ•°æ®å¯¼å‡ºå¤±è´¥: ' + error.message);
            } finally {
                this.testing = false;
            }
        },

        // æ¸…ç†æµ‹è¯•
        async testCleanupData() {
            this.testing = true;
            this.log('info', 'ğŸ§¹ æµ‹è¯•æ•°æ®æ¸…ç† (ä¿ç•™7å¤©)...');

            try {
                await this.aiService.cleanupOldConversations(7);
                await this.loadConversationHistory();
                await this.loadStats();
                this.log('success', 'âœ… æ•°æ®æ¸…ç†å®Œæˆ');
            } catch (error) {
                this.log('error', 'âŒ æ•°æ®æ¸…ç†å¤±è´¥: ' + error.message);
            } finally {
                this.testing = false;
            }
        },

        // æ€§èƒ½æµ‹è¯•
        async testPerformance() {
            this.testing = true;
            this.log('info', 'âš¡ å¼€å§‹æ€§èƒ½æµ‹è¯•...');

            try {
                const startTime = Date.now();
                
                // æµ‹è¯•1: åˆ›å»ºå¯¹è¯é€Ÿåº¦
                const createStart = Date.now();
                const conversationId = await this.aiService.startNewConversation('æ€§èƒ½æµ‹è¯•å¯¹è¯');
                const createTime = Date.now() - createStart;
                this.log('info', `åˆ›å»ºå¯¹è¯è€—æ—¶: ${createTime}ms`);

                // æµ‹è¯•2: æ‰¹é‡æ·»åŠ æ¶ˆæ¯é€Ÿåº¦
                const messageStart = Date.now();
                for (let i = 0; i < 10; i++) {
                    await this.storage.addMessage(conversationId, 'user', `æµ‹è¯•æ¶ˆæ¯ ${i}`, { service: 'test' });
                    await this.storage.addMessage(conversationId, 'assistant', `å›å¤æ¶ˆæ¯ ${i}`, { service: 'test' });
                }
                const messageTime = Date.now() - messageStart;
                this.log('info', `æ·»åŠ 20æ¡æ¶ˆæ¯è€—æ—¶: ${messageTime}ms`);

                // æµ‹è¯•3: åŠ è½½å¯¹è¯é€Ÿåº¦
                const loadStart = Date.now();
                await this.storage.getConversationMessages(conversationId);
                const loadTime = Date.now() - loadStart;
                this.log('info', `åŠ è½½å¯¹è¯è€—æ—¶: ${loadTime}ms`);

                // æµ‹è¯•4: æœç´¢é€Ÿåº¦
                const searchStart = Date.now();
                await this.aiService.searchConversations('æµ‹è¯•');
                const searchTime = Date.now() - searchStart;
                this.log('info', `æœç´¢è€—æ—¶: ${searchTime}ms`);

                const totalTime = Date.now() - startTime;
                this.log('success', `âœ… æ€§èƒ½æµ‹è¯•å®Œæˆï¼Œæ€»è€—æ—¶: ${totalTime}ms`);

                // æ¸…ç†æµ‹è¯•æ•°æ®
                await this.aiService.deleteConversation(conversationId);
                
            } catch (error) {
                this.log('error', 'âŒ æ€§èƒ½æµ‹è¯•å¤±è´¥: ' + error.message);
            } finally {
                this.testing = false;
            }
        },

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        async clearAllData() {
            if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) return;

            this.testing = true;
            this.log('warning', 'âš ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®...');

            try {
                // åˆ é™¤æ‰€æœ‰å¯¹è¯
                for (const conversation of this.conversationHistory) {
                    await this.aiService.deleteConversation(conversation.id);
                }

                // é‡ç½®çŠ¶æ€
                this.conversationHistory = [];
                this.currentConversationId = null;
                this.currentMessages = [];
                this.currentConversationTitle = '';
                this.messageCount = 0;
                this.searchResults = [];
                this.searchQuery = '';

                await this.loadStats();
                
                this.log('success', 'âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©º');
            } catch (error) {
                this.log('error', 'âŒ æ¸…ç©ºæ•°æ®å¤±è´¥: ' + error.message);
            } finally {
                this.testing = false;
            }
        },

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async loadStats() {
            try {
                const stats = await this.aiService.getStorageStats();
                this.totalConversations = stats.conversationCount || 0;
                this.totalMessages = stats.messageCount || 0;
            } catch (error) {
                this.log('error', 'âŒ åŠ è½½ç»Ÿè®¡å¤±è´¥: ' + error.message);
            }
        },

        // æ—¥å¿—ç®¡ç†
        log(type, message) {
            this.logs.unshift({
                type: type,
                message: message,
                timestamp: new Date()
            });
            
            // ä¿æŒæœ€è¿‘100æ¡æ—¥å¿—
            if (this.logs.length > 100) {
                this.logs = this.logs.slice(0, 100);
            }
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        },

        clearLogs() {
            this.logs = [];
        },

        // å·¥å…·æ–¹æ³•
        formatTime(date) {
            if (!date) return '';
            return new Date(date).toLocaleTimeString('zh-CN');
        },

        formatDate(dateStr) {
            if (!dateStr) return '';
            
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'åˆšåˆš';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'å¤©å‰';
            
            return date.toLocaleDateString('zh-CN');
        }
    };

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            if (window.conversationHistoryTest) {
                window.conversationHistoryTest.init();
            }
        }, 100); // ç»™è„šæœ¬åŠ è½½ä¸€ç‚¹æ—¶é—´
    });
    </script>
</body>
</html>